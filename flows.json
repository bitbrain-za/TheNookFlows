[{"id":"62f232c2.0dd08c","type":"tab","label":"General","disabled":false,"info":""},{"id":"152554cc.389edb","type":"tab","label":"Coffee Table","disabled":false,"info":""},{"id":"86a3c02f.3051a","type":"tab","label":"Bedroom","disabled":false,"info":""},{"id":"3788fae5.b038d6","type":"tab","label":"Lounge","disabled":false,"info":""},{"id":"b50f3595.0e3a28","type":"tab","label":"Lights","disabled":false,"info":""},{"id":"ef54a0c2.e259d","type":"tab","label":"Spotify","disabled":false,"info":""},{"id":"5e97ea24.516424","type":"tab","label":"Garden","disabled":false,"info":""},{"id":"fa310ecb.c84eb","type":"tab","label":"Test","disabled":false,"info":""},{"id":"796da880.c06928","type":"tab","label":"Telegram","disabled":false,"info":""},{"id":"dfa48b6f.2ff088","type":"tab","label":"Printer","disabled":false,"info":""},{"id":"2c8f60c4.cfd28","type":"tab","label":"System","disabled":false,"info":""},{"id":"9c2230b1.bee8d","type":"tab","label":"markiv","disabled":false,"info":""},{"id":"f2e45804.48caf8","type":"tab","label":"Cameras","disabled":false,"info":""},{"id":"8efb2399.f1af9","type":"subflow","name":"Play On Google Home","info":"","category":"","in":[{"x":80,"y":80,"wires":[{"id":"3a88dc46.74acb4"}]}],"out":[],"env":[]},{"id":"8dc4db95.863a28","type":"subflow","name":"Subflow 1","info":"","in":[{"x":60,"y":80,"wires":[{"id":"60efd2b7.c8f81c"}]}],"out":[{"x":1060,"y":80,"wires":[{"id":"a168d8f.5574f28","port":0}]}]},{"id":"81d9975e.584f98","type":"subflow","name":"MES","info":"","category":"The Nook","in":[],"out":[],"env":[],"icon":"node-red-contrib-cast/home.svg"},{"id":"4a06737d.008a7c","type":"subflow","name":"All AC Off","info":"","category":"The Nook","in":[{"x":460,"y":300,"wires":[{"id":"cff4a041.4964"}]}],"out":[],"env":[],"icon":"font-awesome/fa-snowflake-o"},{"id":"8ed72877.93bc38","type":"subflow","name":"Peripheral Lights Off","info":"","category":"The Nook","in":[{"x":220,"y":200,"wires":[{"id":"757620d3.73d4"}]}],"out":[],"env":[],"icon":"node-red/light.png"},{"id":"a436e8cb.527cf8","type":"subflow","name":"Toggle Lounge AC","info":"","category":"The Nook","in":[{"x":180,"y":160,"wires":[{"id":"b467c84c.4dc468"}]}],"out":[],"env":[],"icon":"font-awesome/fa-snowflake-o"},{"id":"54c86189.6415","type":"subflow","name":"Brightness wrt Time","info":"","category":"The Nook","in":[{"x":240,"y":140,"wires":[{"id":"5dbcd079.75d08"}]}],"out":[{"x":1020,"y":140,"wires":[{"id":"6946092c.681c38","port":0},{"id":"5a591dcf.255824","port":0}]}],"env":[],"icon":"node-red/light.png"},{"id":"34311fcd.cea24","type":"subflow","name":"Brightness Bedtime & Sun","info":"","category":"The Nook","in":[{"x":240,"y":240,"wires":[{"id":"5518df27.0ef46"}]}],"out":[{"x":1360,"y":340,"wires":[{"id":"9a09c277.b010d","port":0},{"id":"59476d48.5e9b54","port":0}]},{"x":1360,"y":440,"wires":[{"id":"a9f78513.321758","port":0}]}],"env":[],"inputLabels":["Trigger"],"outputLabels":["On","Off"],"icon":"node-red/light.png"},{"id":"ca5a8b67.211fb8","type":"subflow","name":"Bedtime","info":"","category":"The Nook","in":[{"x":260,"y":300,"wires":[{"id":"101919ec.aec916"},{"id":"c4d56b4d.33ac08"},{"id":"88a236e4.0d4fb8"},{"id":"b1b10b04.2ce1f8"},{"id":"b911b839.71bbe8"},{"id":"e46c9b84.60b878"},{"id":"2ba746ae.0bb31a"},{"id":"9f797a10.cb3098"},{"id":"ee2bfb22.e00998"}]}],"out":[{"x":860,"y":400,"wires":[{"id":"c22f4207.123ec","port":0},{"id":"5fece0df.00b57","port":0}]}],"env":[],"icon":"font-awesome/fa-bed"},{"id":"8e0a986b.ca0ef8","type":"subflow","name":"Lounge Warm","info":"","category":"Scenes","in":[{"x":220,"y":140,"wires":[{"id":"f7909cea.9905b"}]}],"out":[],"env":[],"color":"#3FADB5","icon":"font-awesome/fa-fire"},{"id":"8b2696b9.77c108","type":"subflow","name":"Lounge Bright","info":"","category":"Scenes","in":[{"x":160,"y":200,"wires":[{"id":"e3169abf.7a4a98"}]}],"out":[],"env":[],"color":"#3FADB5","icon":"node-red/light.svg"},{"id":"f39f57bd.f82a58","type":"subflow","name":"Lounge Medium","info":"","category":"Scenes","in":[{"x":120,"y":200,"wires":[{"id":"da8ae703.da5a18"}]}],"out":[],"env":[],"color":"#3FADB5","icon":"node-red/white-globe.svg"},{"id":"ecfae70d.6fd868","type":"subflow","name":"CR10S","info":"# payload\r\n\r\n---\r\n\r\n\r\n## _light_\r\n\r\n### on\r\nTurns on the light\r\n### off\r\nTurns off the light\r\n### toggle\r\nToggles the light\r\n\r\n---\r\n\r\n## _printer_\r\n\r\n### on\r\nTurns on the light\r\n### off\r\nTurns off the light\r\n### toggle\r\nToggles the light","category":"","in":[{"x":116,"y":161,"wires":[{"id":"6f6d535e.459b4c"},{"id":"3b95e8fe.376e68"},{"id":"7a4b8a04.c7d4b4"}]}],"out":[],"env":[],"color":"#3FADB5","icon":"font-awesome/fa-print"},{"id":"7d575fd3.be153","type":"server","z":"","name":"Home Assistant","legacy":false,"hassio":true,"rejectUnauthorizedCerts":true,"ha_boolean":"y|yes|true|on|home|open","connectionDelay":true},{"id":"5bf8ed86.6f1f24","type":"ui_base","theme":{"name":"theme-dark","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"},"themeState":{"base-color":{"default":"#097479","value":"#097479","edited":false},"page-titlebar-backgroundColor":{"value":"#097479","edited":false},"page-backgroundColor":{"value":"#111111","edited":false},"page-sidebar-backgroundColor":{"value":"#000000","edited":false},"group-textColor":{"value":"#0eb8c0","edited":false},"group-borderColor":{"value":"#555555","edited":false},"group-backgroundColor":{"value":"#333333","edited":false},"widget-textColor":{"value":"#eeeeee","edited":false},"widget-backgroundColor":{"value":"#097479","edited":false},"widget-borderColor":{"value":"#333333","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey"}},"site":{"name":"Node-RED Dashboard","hideToolbar":"false","allowSwipe":"false","lockMenu":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":48,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"2eafe4c0.b7da5c","type":"mqtt-broker","z":"","name":"hassio","broker":"192.168.1.32","port":"10883","clientid":"node_red","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"6db11244.bdedac","type":"spotify-auth","z":"","name":"Spotify OAuth2","scope":"user-library-modify\nuser-library-read\napp-remote-control\nstreaming\nplaylist-read-private\nplaylist-read-collaborative\nplaylist-modify-public\nplaylist-modify-private\nuser-read-recently-played\nuser-top-read\nuser-read-currently-playing\nuser-read-playback-state\nuser-modify-playback-state"},{"id":"f9e8d117.9aabc","type":"ui_group","z":"","name":"Group 1","tab":"","order":1,"disp":true,"width":"6","collapse":false},{"id":"4938713b.f73e5","type":"ui_spacer","name":"spacer","group":"f9e8d117.9aabc","order":1,"width":1,"height":1},{"id":"29745a73.469c46","type":"chatbot-telegram-node","z":"","botname":"Test bot","usernames":"532693134","providerToken":"","polling":"1000","store":"","log":"","parseMode":"","debug":false,"webHook":"","connectMode":"polling"},{"id":"a74dbc46.5290a","type":"chatbot-telegram-node","z":"","botname":"Home Bot","usernames":"532693134","providerToken":"","polling":"1000","store":"","log":"","parseMode":"","debug":false,"webHook":"","connectMode":"polling"},{"id":"c098a993.7d4cd8","type":"chatbot-telegram-node","z":"","botname":"Battery Bot","usernames":"532693134","providerToken":"","polling":"1000","store":"","log":"","parseMode":"","debug":false,"webHook":"","connectMode":"polling"},{"id":"19612d6f.770c43","type":"chatbot-telegram-node","z":"","botname":"Garden Bot","usernames":"","providerToken":"","polling":"1000","store":"","log":"","parseMode":"","debug":false,"webHook":"","connectMode":"polling"},{"id":"435a769d.ad67a8","type":"chatbot-telegram-node","z":"","botname":"Printer Bot","usernames":"532693134","providerToken":"","polling":"1000","store":"","log":"","parseMode":"","debug":false,"webHook":"","connectMode":"polling"},{"id":"b2e0dafd.f67fa8","type":"chatbot-telegram-node","z":"","botname":"Mark IV","usernames":"532693134","providerToken":"","polling":"1000","store":"","log":"","parseMode":"","debug":false,"webHook":"","connectMode":"polling"},{"id":"16114441.7d446c","type":"sftp","z":"","host":"192.168.1.30","port":"22","tryKeyboard":false,"key":"","keyname":"","algorithms_kex":"ecdh-sha2-nistp256,ecdh-sha2-nistp384,ecdh-sha2-nistp521,diffie-hellman-group-exchange-sha256,diffie-hellman-group14-sha1","algorithms_cipher":"aes128-ctr,aes192-ctr,aes256-ctr,aes128-gcm,aes128-gcm@openssh.com,aes256-gcm,aes256-gcm@openssh.com","algorithms_serverHostKey":"ssh-rsa,ecdsa-sha2-nistp256,ecdsa-sha2-nistp384,ecdsa-sha2-nistp521","algorithms_hmac":"hmac-sha2-256,hmac-sha2-512,hmac-sha1","algorithms_compress":"none,zlib@openssh.com,zlib"},{"id":"3585a77d.6fe258","type":"mqtt out","z":"152554cc.389edb","name":"Publish","topic":"","qos":"0","retain":"false","broker":"2eafe4c0.b7da5c","x":980,"y":300,"wires":[]},{"id":"d82b898d.8d2e48","type":"mqtt in","z":"152554cc.389edb","name":"tags","topic":"coffee_table/tags","qos":"0","datatype":"auto","broker":"2eafe4c0.b7da5c","x":190,"y":300,"wires":[["aa02c509.209398","deabd4b3.5c5048"]]},{"id":"bba7a822.6dd958","type":"stoptimer","z":"152554cc.389edb","duration":"5","units":"Second","payloadtype":"num","payloadval":"lock","name":"","x":680,"y":260,"wires":[["a8851025.063b3"],[]]},{"id":"45f0144b.39d25c","type":"switch","z":"152554cc.389edb","name":"Check","property":"unlock","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":490,"y":300,"wires":[["bba7a822.6dd958","3678f3ed.0183bc"],["fe74ad6.afe5a5"]]},{"id":"3678f3ed.0183bc","type":"function","z":"152554cc.389edb","name":"unlock","func":"msg.topic = \"coffee_table/command\"\nmsg.payload = \"unlock\"\nreturn msg;","outputs":1,"noerr":0,"x":770,"y":300,"wires":[["3585a77d.6fe258"]]},{"id":"a8851025.063b3","type":"function","z":"152554cc.389edb","name":"Lock","func":"msg.topic = \"coffee_table/command\"\nmsg.payload = \"lock\"\nreturn msg;","outputs":1,"noerr":0,"x":850,"y":260,"wires":[["3585a77d.6fe258"]]},{"id":"cb1f7bed.cb9da8","type":"inject","z":"152554cc.389edb","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":680,"y":380,"wires":[["3678f3ed.0183bc"]]},{"id":"8635c9e3.069778","type":"mqtt out","z":"152554cc.389edb","name":"Publish","topic":"","qos":"0","retain":"false","broker":"2eafe4c0.b7da5c","x":1100,"y":940,"wires":[]},{"id":"d6cfdf6e.27fd6","type":"function","z":"152554cc.389edb","name":"Temperature","func":"msg.topic = \"coffee_table/ac/temp\"\nmsg.payload = msg.data.event.new_state.attributes.temperature\nreturn msg;","outputs":1,"noerr":0,"x":830,"y":740,"wires":[[]]},{"id":"ba183189.07697","type":"trigger-state","z":"152554cc.389edb","name":"","server":"7d575fd3.be153","entityid":"climate.lounge_ac","entityidfiltertype":"exact","debugenabled":false,"constraints":[{"id":"e8hf5wc5cau","targetType":"this_entity","targetValue":"","propertyType":"property","propertyValue":"new_state.attributes.temperature","comparatorType":">","comparatorValueDatatype":"num","comparatorValue":"17"}],"constraintsmustmatch":"all","outputs":2,"customoutputs":[],"outputinitially":true,"state_type":"str","x":430,"y":780,"wires":[["7c54558e.35644c"],[]]},{"id":"7088c9e7.6daa68","type":"mqtt in","z":"152554cc.389edb","name":"AC setting","topic":"coffee_table/ac/set_temp","qos":"0","datatype":"auto","broker":"2eafe4c0.b7da5c","x":200,"y":1920,"wires":[["9a5cbe16.22dd6"]]},{"id":"9a5cbe16.22dd6","type":"switch","z":"152554cc.389edb","name":"Check","property":"payload","propertyType":"msg","rules":[{"t":"btwn","v":"17","vt":"str","v2":"26","v2t":"str"},{"t":"gte","v":"27","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":370,"y":1920,"wires":[["ed7faed8.4cd05","b788424a.7fac5"],["e8bd6c0b.4892e","b788424a.7fac5"]]},{"id":"c9b7f417.42b8d8","type":"api-call-service","z":"152554cc.389edb","name":"Set Mode","server":"7d575fd3.be153","version":1,"service_domain":"climate","service":"set_hvac_mode","entityId":"climate.lounge_ac","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":760,"y":1900,"wires":[[]]},{"id":"ed7faed8.4cd05","type":"function","z":"152554cc.389edb","name":"Cool","func":"msg.payload = \n{\n    data:\n    {\n        \"hvac_mode\":\"cool\"\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":570,"y":1920,"wires":[["c9b7f417.42b8d8","ef4a9d40.31fa1"]]},{"id":"e8bd6c0b.4892e","type":"function","z":"152554cc.389edb","name":"Auto","func":"msg.payload = \n{\n    data:\n    {\n        \"hvac_mode\":\"auto\"\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":570,"y":1980,"wires":[["c9b7f417.42b8d8","e4f1a7db.7c7008"]]},{"id":"a73b1c66.86f9c","type":"inject","z":"152554cc.389edb","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"27","payloadType":"str","x":170,"y":1800,"wires":[["9a5cbe16.22dd6"]]},{"id":"ef4a9d40.31fa1","type":"debug","z":"152554cc.389edb","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":750,"y":1860,"wires":[]},{"id":"e4f1a7db.7c7008","type":"debug","z":"152554cc.389edb","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":1980,"wires":[]},{"id":"964cb7ed.faf2c8","type":"inject","z":"152554cc.389edb","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"20","payloadType":"str","x":170,"y":1760,"wires":[["9a5cbe16.22dd6"]]},{"id":"4ba8cd83.504cf4","type":"inject","z":"152554cc.389edb","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"0","payloadType":"str","x":170,"y":1840,"wires":[["9a5cbe16.22dd6"]]},{"id":"b788424a.7fac5","type":"function","z":"152554cc.389edb","name":"Temperature","func":"msg.payload = \n{\n    data:\n    {\n        \"temperature\": msg.payload, \n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":2040,"wires":[["e9228812.c4f8d8","e21753cf.589bd"]]},{"id":"e9228812.c4f8d8","type":"api-call-service","z":"152554cc.389edb","name":"Set Temperature","server":"7d575fd3.be153","version":1,"service_domain":"climate","service":"set_temperature","entityId":"climate.lounge_ac","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":790,"y":2040,"wires":[[]]},{"id":"e21753cf.589bd","type":"debug","z":"152554cc.389edb","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":750,"y":2100,"wires":[]},{"id":"45f389d6.4a0148","type":"mqtt in","z":"152554cc.389edb","name":"Coffee Table Rebooted","topic":"coffee_table/boot","qos":"0","datatype":"auto","broker":"2eafe4c0.b7da5c","x":120,"y":960,"wires":[["3fd50609.42b72a","e28a7b90.cf96e8"]]},{"id":"3fd50609.42b72a","type":"api-current-state","z":"152554cc.389edb","name":"","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"climate.lounge_ac","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":430,"y":840,"wires":[["6eb0a296.32c9cc"],["d78eeb07.5b06e8"]]},{"id":"7c54558e.35644c","type":"switch","z":"152554cc.389edb","name":"Is Off","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"off","vt":"str"},{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":650,"y":780,"wires":[["d6cfdf6e.27fd6"],["6eb0a296.32c9cc"]]},{"id":"6eb0a296.32c9cc","type":"function","z":"152554cc.389edb","name":"Off","func":"msg.topic = \"coffee_table/ac/temp\"\nmsg.payload = 0\nreturn msg;","outputs":1,"noerr":0,"x":810,"y":820,"wires":[[]]},{"id":"d480b019.5e823","type":"inject","z":"152554cc.389edb","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"Trigger","payloadType":"str","x":170,"y":840,"wires":[["3fd50609.42b72a"]]},{"id":"d78eeb07.5b06e8","type":"function","z":"152554cc.389edb","name":"Temperature","func":"msg.topic = \"coffee_table/ac/temp\"\nmsg.payload = msg.data.attributes.temperature\nreturn msg;","outputs":1,"noerr":0,"x":830,"y":900,"wires":[[]]},{"id":"c0562d16.6a6","type":"inject","z":"152554cc.389edb","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"Trigger","payloadType":"str","x":170,"y":1120,"wires":[["e28a7b90.cf96e8"]]},{"id":"e28a7b90.cf96e8","type":"api-current-state","z":"152554cc.389edb","name":"","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"light.lounge","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":440,"y":1120,"wires":[["ee29ecbf.be8cd"],["8fe0276f.d1b7a8"]]},{"id":"e7b9101a.4eb1","type":"trigger-state","z":"152554cc.389edb","name":"Lounge Light Changed","server":"7d575fd3.be153","entityid":"light.lounge","entityidfiltertype":"exact","debugenabled":false,"constraints":[{"id":"x37cdsadl1","targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"on"}],"constraintsmustmatch":"all","outputs":2,"customoutputs":[],"outputinitially":true,"state_type":"str","x":480,"y":1060,"wires":[["4f5232e3.6d956c","a6cac5fd.85bd78"],["ee29ecbf.be8cd","a6cac5fd.85bd78"]]},{"id":"ee29ecbf.be8cd","type":"function","z":"152554cc.389edb","name":"Off","func":"msg.topic = \"coffee_table/rgb\"\nmsg.payload = \"0,0,0\"\nreturn msg;","outputs":1,"noerr":0,"x":850,"y":1060,"wires":[["8635c9e3.069778","5692ae5d.b9eef"]]},{"id":"8fe0276f.d1b7a8","type":"function","z":"152554cc.389edb","name":"Colour","func":"msg.topic = \"coffee_table/rgb\"\nmsg.payload = msg.data.attributes.rgb_color.join(\",\");\nreturn msg","outputs":1,"noerr":0,"x":850,"y":1120,"wires":[["8635c9e3.069778"]]},{"id":"4f5232e3.6d956c","type":"function","z":"152554cc.389edb","name":"Colour","func":"msg.topic = \"coffee_table/rgb\"\nmsg.payload = msg.data.event.new_state.attributes.rgb_color.join(\",\");\nreturn msg","outputs":1,"noerr":0,"x":850,"y":980,"wires":[["8635c9e3.069778","5692ae5d.b9eef"]]},{"id":"d8b87a2c.f84318","type":"comment","z":"152554cc.389edb","name":"Update Values","info":"Update the state variable on the coffee table","x":140,"y":720,"wires":[]},{"id":"f4db5f75.ad852","type":"comment","z":"152554cc.389edb","name":"Set the aircon","info":"","x":370,"y":1780,"wires":[]},{"id":"52d19d76.808bf4","type":"comment","z":"152554cc.389edb","name":"Handle Tag","info":"","x":170,"y":240,"wires":[]},{"id":"e011d35a.1d8b1","type":"file in","z":"152554cc.389edb","name":"Read Access Tags","filename":"/share/authorized_tags","format":"lines","chunk":false,"sendError":false,"encoding":"utf8","x":830,"y":80,"wires":[["48d45ac0.ec5f84"]]},{"id":"53992fe7.40b8e","type":"debug","z":"152554cc.389edb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1310,"y":80,"wires":[]},{"id":"6f4b6a83.b251e4","type":"function","z":"152554cc.389edb","name":"Load into global","func":"var count=global.get('tag_count') || 0;\n\nif (global.tag_count===undefined)//test exists\n{\n  global.tag_count=0;\n}\n\nglobal.set(\"Tags[\"+count+\"]\", msg.payload);\nglobal.set('tag_count', count + 1);\n\nmsg.payload = count\n\nreturn msg;","outputs":1,"noerr":0,"x":1140,"y":80,"wires":[["53992fe7.40b8e"]]},{"id":"f11098a2.4b88f8","type":"change","z":"152554cc.389edb","name":"Flush tags","rules":[{"t":"delete","p":"Tags","pt":"global"}],"action":"","property":"","from":"","to":"","reg":false,"x":410,"y":160,"wires":[["28d375f9.d4d47a"]]},{"id":"28d375f9.d4d47a","type":"function","z":"152554cc.389edb","name":"Reset Index","func":"global.set(\"tag_count\", 0)\nglobal.set(\"spotify_tag_count\", 0)\nreturn msg;","outputs":1,"noerr":0,"x":590,"y":160,"wires":[["e011d35a.1d8b1","5c8f7d2e.d82f84"]]},{"id":"d0249aa5.14afc8","type":"inject","z":"152554cc.389edb","name":"","repeat":"","crontab":"","once":true,"onceDelay":"","topic":"","payload":"Started!","payloadType":"str","x":200,"y":120,"wires":[["f11098a2.4b88f8","464e3e5d.1a4b5"]]},{"id":"aa02c509.209398","type":"function","z":"152554cc.389edb","name":"Lock?","func":"var count=global.get('tag_count') || 0;\nvar tag;\n\nfor(i=0; i<count; i++)\n{\n    tag = global.get(\"Tags[\"+i+\"]\");\n    if (tag==msg.payload)\n    {\n        msg.unlock = true\n        return msg;\n    }\n}\nmsg.unlock = false\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":300,"wires":[["45f0144b.39d25c"]]},{"id":"deabd4b3.5c5048","type":"debug","z":"152554cc.389edb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":390,"y":240,"wires":[]},{"id":"48d45ac0.ec5f84","type":"string","z":"152554cc.389edb","name":"strip","methods":[{"name":"trim","params":[]}],"prop":"payload","propout":"payload","object":"msg","objectout":"msg","x":990,"y":80,"wires":[["6f4b6a83.b251e4"]]},{"id":"b386a47d.b53228","type":"comment","z":"152554cc.389edb","name":"Load Tag table","info":"","x":200,"y":60,"wires":[]},{"id":"cbe0832e.f82a","type":"cast-to-client","z":"fa310ecb.c84eb","name":"","url":"","contentType":"","message":"","language":"en","ip":"","port":"","volume":"100","x":730,"y":420,"wires":[["8016a89c.b02d68"]],"icon":"node-red-contrib-cast/home.png"},{"id":"ae14cd86.e1a92","type":"inject","z":"fa310ecb.c84eb","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":340,"y":420,"wires":[["601a200c.7c9ec"]]},{"id":"601a200c.7c9ec","type":"change","z":"fa310ecb.c84eb","name":"","rules":[{"t":"set","p":"ip","pt":"msg","to":"192.168.1.27","tot":"str"},{"t":"set","p":"message","pt":"msg","to":"Testing 1 2 3. ","tot":"str"},{"t":"set","p":"language","pt":"msg","to":"En-gb","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":560,"y":420,"wires":[["cbe0832e.f82a"]]},{"id":"8016a89c.b02d68","type":"debug","z":"fa310ecb.c84eb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":890,"y":420,"wires":[]},{"id":"3da2ffbc.1e6b1","type":"comment","z":"fa310ecb.c84eb","name":"say a text","info":"","x":300,"y":380,"wires":[]},{"id":"5cc51160.65fdd","type":"spotify","z":"fa310ecb.c84eb","name":"Spotify","auth":"6db11244.bdedac","api":"getMyDevices","x":450,"y":580,"wires":[["e4c54319.69dcf"]]},{"id":"34a73767.208898","type":"inject","z":"fa310ecb.c84eb","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"Devices","payloadType":"str","x":290,"y":580,"wires":[["5cc51160.65fdd"]]},{"id":"e4c54319.69dcf","type":"debug","z":"fa310ecb.c84eb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":630,"y":580,"wires":[]},{"id":"b1a9b04c.ec789","type":"mqtt in","z":"152554cc.389edb","name":"set light brightness","topic":"coffee_table/lights/brightness","qos":"0","datatype":"auto","broker":"2eafe4c0.b7da5c","x":140,"y":1360,"wires":[["9070b397.0ba16"]]},{"id":"703506ba.99ec18","type":"api-call-service","z":"152554cc.389edb","name":"Set Brightness","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_on","entityId":"light.lounge","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":920,"y":1440,"wires":[[]]},{"id":"1115a864.e8b008","type":"function","z":"152554cc.389edb","name":"Brightness","func":"msg.payload = \n{\n    data:\n    {\n        \"brightness\":msg.payload\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":1340,"wires":[["703506ba.99ec18","fcb98fe6.327f9"]]},{"id":"61b08703.109fb8","type":"inject","z":"152554cc.389edb","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"80","payloadType":"str","x":250,"y":1300,"wires":[["1115a864.e8b008"]]},{"id":"16dfc199.75232e","type":"inject","z":"152554cc.389edb","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"0","payloadType":"str","x":250,"y":1260,"wires":[["1115a864.e8b008"]]},{"id":"a6ac0045.3f7d5","type":"mqtt in","z":"152554cc.389edb","name":"set light colour","topic":"coffee_table/lights/rgb","qos":"0","datatype":"auto","broker":"2eafe4c0.b7da5c","x":170,"y":1520,"wires":[["b7ce2f65.ec52e"]]},{"id":"7b8aa904.790698","type":"function","z":"152554cc.389edb","name":"Colour","func":"msg.payload = \n{\n    data:\n    {\n        \"rgb_color\":msg.payload\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":1520,"wires":[["703506ba.99ec18","fcb98fe6.327f9"]]},{"id":"a5c8c305.98023","type":"inject","z":"152554cc.389edb","name":"Green","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"0,255,0","payloadType":"str","x":150,"y":1480,"wires":[["b7ce2f65.ec52e"]]},{"id":"53c6731b.b525ac","type":"inject","z":"152554cc.389edb","name":"Blue","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"[0,0,255]","payloadType":"str","x":150,"y":1440,"wires":[["b7ce2f65.ec52e"]]},{"id":"b7ce2f65.ec52e","type":"string","z":"152554cc.389edb","name":"split","methods":[{"name":"split","params":[{"type":"str","value":","},{"type":"num","value":"3"}]}],"prop":"payload","propout":"payload","object":"msg","objectout":"msg","x":330,"y":1520,"wires":[["7b8aa904.790698"]]},{"id":"b77ac302.94cb2","type":"comment","z":"152554cc.389edb","name":"Set the lights","info":"","x":490,"y":1280,"wires":[]},{"id":"b597ff23.29d","type":"spotify","z":"fa310ecb.c84eb","name":"Spotify","auth":"6db11244.bdedac","api":"getUserPlaylists","x":450,"y":640,"wires":[["de1fd720.963eb8"]]},{"id":"fbb22061.ae571","type":"inject","z":"fa310ecb.c84eb","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"Playlists","payloadType":"str","x":300,"y":640,"wires":[["b597ff23.29d"]]},{"id":"de1fd720.963eb8","type":"debug","z":"fa310ecb.c84eb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":630,"y":640,"wires":[]},{"id":"f1a3ca51.122d78","type":"switch","z":"152554cc.389edb","name":"Click Type","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"click","vt":"str"},{"t":"eq","v":"hold","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1550,"y":360,"wires":[["f7c84f40.b0fdc"],[]]},{"id":"6a6a0e19.a5346","type":"api-call-service","z":"8e0a986b.ca0ef8","name":"Kitchen","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"light.kitchen","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":620,"y":80,"wires":[[]]},{"id":"33d5124b.5dd8fe","type":"api-call-service","z":"8e0a986b.ca0ef8","name":"Entrance","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"light.entrance","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":620,"y":120,"wires":[[]]},{"id":"edfd67d3.4d04d8","type":"mqtt in","z":"152554cc.389edb","name":"Button 5","topic":"coffee_table/btn5","qos":"0","datatype":"auto","broker":"2eafe4c0.b7da5c","x":1400,"y":740,"wires":[["5b1e3c1a.87e194","9caa92a0.a7d8b"]]},{"id":"5b1e3c1a.87e194","type":"switch","z":"152554cc.389edb","name":"Click Type","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"click","vt":"str"},{"t":"eq","v":"hold","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1550,"y":740,"wires":[["6d19006f.a4133"],["e7759e94.87d78"]]},{"id":"e7759e94.87d78","type":"link out","z":"152554cc.389edb","name":"Button5 Held","links":["bdbee893.050b58"],"x":1735,"y":780,"wires":[]},{"id":"82a2581a.cf2ae8","type":"switch","z":"152554cc.389edb","name":"Click Type","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"click","vt":"str"},{"t":"eq","v":"hold","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1550,"y":880,"wires":[["dfdf9da9.c9194"],["ab93b770.7384a8"]]},{"id":"dfdf9da9.c9194","type":"api-call-service","z":"152554cc.389edb","name":"Next","server":"7d575fd3.be153","version":1,"service_domain":"media_player","service":"media_next_track","entityId":"media_player.spotify_phil","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1770,"y":860,"wires":[[]]},{"id":"ab93b770.7384a8","type":"api-call-service","z":"152554cc.389edb","name":"Previous","server":"7d575fd3.be153","version":1,"service_domain":"media_player","service":"media_previous_track","entityId":"media_player.spotify_phil","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1780,"y":920,"wires":[[]]},{"id":"5c8f7d2e.d82f84","type":"file in","z":"152554cc.389edb","name":"Read Music Tags","filename":"/share/music_tags.json","format":"utf8","chunk":false,"sendError":false,"encoding":"utf8","x":830,"y":160,"wires":[["e917cd70.109a3"]]},{"id":"9e53aea4.e8981","type":"function","z":"152554cc.389edb","name":"Load into global","func":"global.set(\"SpotifyTags\", msg.payload.Tags);\nreturn msg;","outputs":1,"noerr":0,"x":1200,"y":160,"wires":[[]]},{"id":"e917cd70.109a3","type":"json","z":"152554cc.389edb","name":"Parse","property":"payload","action":"","pretty":false,"x":1010,"y":160,"wires":[["9e53aea4.e8981","c8e37c66.45575"]]},{"id":"fe74ad6.afe5a5","type":"function","z":"152554cc.389edb","name":"Album?","func":"var tags = global.get(\"SpotifyTags\");\n\nvar current_tag = flow.get(\"current_tag\")||0;\n\nnode.warn(\"Current tag: \" + current_tag);\nnode.warn(\"New tag: \" + msg.payload);\n\nif(current_tag > 0)\n{\n    if(current_tag==msg.payload)\n        return [null, msg]\n}\n\nfor(var i=0; i<tags.length; i++)\n{\n    // node.warn(tags[i].tag);\n    // node.warn(tags[i].uri);\n    if (tags[i].tag==msg.payload)\n    {\n        flow.set(\"current_tag\", msg.payload);\n        msg.payload = \n        {\n            data:\n            {\n                \"media_content_type\":tags[i].type,\n                \"media_content_id\":tags[i].uri\n            }\n        };\n        node.warn(\"Match\");\n        msg.uri_attached = true\n        return [msg, null];\n    }\n}\nnode.warn(\"No match\");\nmsg.uri_attached = false\nreturn [msg, null];","outputs":2,"noerr":0,"x":360,"y":480,"wires":[["a2d03719.e5c5a8"],["fe90a99e.6e4dd8"]]},{"id":"a2d03719.e5c5a8","type":"switch","z":"152554cc.389edb","name":"Check","property":"uri_attached","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":530,"y":480,"wires":[["9797be1a.8e886"],["cb97531.f1c1cb","ab7054af.900578"]]},{"id":"c8e37c66.45575","type":"debug","z":"152554cc.389edb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1130,"y":240,"wires":[]},{"id":"fcb98fe6.327f9","type":"debug","z":"152554cc.389edb","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":690,"y":1540,"wires":[]},{"id":"a6cac5fd.85bd78","type":"debug","z":"152554cc.389edb","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":670,"y":960,"wires":[]},{"id":"5692ae5d.b9eef","type":"debug","z":"152554cc.389edb","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1130,"y":1080,"wires":[]},{"id":"9070b397.0ba16","type":"switch","z":"152554cc.389edb","name":"","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"toggle","vt":"str"},{"t":"eq","v":"toggle","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":360,"y":1380,"wires":[["1115a864.e8b008"],["c0c6ce8.c57ec3"]]},{"id":"c0c6ce8.c57ec3","type":"api-call-service","z":"152554cc.389edb","name":"Set Brightness","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"toggle","entityId":"light.lounge","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":560,"y":1440,"wires":[[]]},{"id":"bdbee893.050b58","type":"link in","z":"3788fae5.b038d6","name":"Movie","links":["e7759e94.87d78"],"x":175,"y":180,"wires":[["68580e7b.59bde","6cad72cb.bffa3c","29f06b72.ef1114","3a505a79.5ca2f6","e226dd7c.ae6b4"]]},{"id":"fca6720f.a32c3","type":"api-call-service","z":"b50f3595.0e3a28","name":"Peripheral Lights Off","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"light.kitchen, light.passage, light.entrance, light.lab","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":260,"y":80,"wires":[[]]},{"id":"8653b724.b6b798","type":"link in","z":"b50f3595.0e3a28","name":"PeripheralLightsOff","links":["68580e7b.59bde","a208e1db.bc2bb","a1a2d7a5.e342d8"],"x":115,"y":80,"wires":[["fca6720f.a32c3"]]},{"id":"55a6be5f.50e59","type":"api-call-service","z":"b50f3595.0e3a28","name":"All Lights Off","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"group.all_lights","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":230,"y":140,"wires":[[]]},{"id":"14ab918f.a9369e","type":"link in","z":"b50f3595.0e3a28","name":"AllLightsOff","links":[],"x":115,"y":140,"wires":[["55a6be5f.50e59"]]},{"id":"1c301ebb.5df3b1","type":"api-call-service","z":"b50f3595.0e3a28","name":"Inside Lights Off","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"group.inside_lights","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":240,"y":200,"wires":[[]]},{"id":"e4edf7d9.080b48","type":"link in","z":"b50f3595.0e3a28","name":"InsideLightsOff","links":[],"x":115,"y":200,"wires":[["1c301ebb.5df3b1"]]},{"id":"929ef857.188298","type":"api-call-service","z":"b50f3595.0e3a28","name":"Bedtime Lights Off","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"group.lights_bedtime","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":250,"y":260,"wires":[[]]},{"id":"1b91702b.f09e6","type":"link in","z":"b50f3595.0e3a28","name":"BedtimeLightsOff","links":[],"x":115,"y":260,"wires":[["929ef857.188298"]]},{"id":"68580e7b.59bde","type":"link out","z":"3788fae5.b038d6","name":"MovieOffLights","links":["8653b724.b6b798"],"x":320,"y":120,"wires":[]},{"id":"6cad72cb.bffa3c","type":"api-call-service","z":"3788fae5.b038d6","name":"LoungeLight","server":"7d575fd3.be153","version":"1","service_domain":"light","service":"turn_on","entityId":"light.lounge","data":"{\"rgb_color\":[0,30,30]}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":370,"y":180,"wires":[[]]},{"id":"29f06b72.ef1114","type":"api-call-service","z":"3788fae5.b038d6","name":"OutsideLightOff","server":"7d575fd3.be153","version":"1","service_domain":"light","service":"turn_off","entityId":"light.back","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":380,"y":240,"wires":[[]]},{"id":"be57c11c.f8293","type":"mqtt out","z":"3788fae5.b038d6","name":"Publish","topic":"","qos":"0","retain":"false","broker":"2eafe4c0.b7da5c","x":520,"y":300,"wires":[]},{"id":"3a505a79.5ca2f6","type":"function","z":"3788fae5.b038d6","name":"DevicesOn","func":"msg.topic = \"coffee_table/command\"\nmsg.payload = \"devices_on\"\nreturn msg","outputs":1,"noerr":0,"x":350,"y":300,"wires":[["be57c11c.f8293"]]},{"id":"80e1fa55.2dd948","type":"mqtt out","z":"3788fae5.b038d6","name":"Publish","topic":"","qos":"0","retain":"false","broker":"2eafe4c0.b7da5c","x":520,"y":360,"wires":[]},{"id":"e226dd7c.ae6b4","type":"function","z":"3788fae5.b038d6","name":"Set Source","func":"msg.topic = \"coffee_table/command\"\nmsg.payload = \"source_dvd\"\nreturn msg","outputs":1,"noerr":0,"x":350,"y":360,"wires":[["80e1fa55.2dd948"]]},{"id":"f2adc0ca.e01d5","type":"link in","z":"3788fae5.b038d6","name":"Pause","links":["ba2848df.750b58"],"x":155,"y":420,"wires":[["6b3c3077.c736","6cf11b4c.1e6ba4","69c53cd7.421254","33e1c05.760b24","9b895081.0369a","cf96bcfd.6d46d"]]},{"id":"6b3c3077.c736","type":"api-call-service","z":"3788fae5.b038d6","name":"LoungeLight","server":"7d575fd3.be153","version":"1","service_domain":"light","service":"turn_on","entityId":"light.lounge","data":"{\"rgb_color\":[80,30,30]}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":350,"y":420,"wires":[[]]},{"id":"6cf11b4c.1e6ba4","type":"api-call-service","z":"3788fae5.b038d6","name":"OutsideLightOn","server":"7d575fd3.be153","version":"1","service_domain":"light","service":"turn_on","entityId":"light.back","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":360,"y":480,"wires":[[]]},{"id":"4d87dc9e.05eec4","type":"mqtt out","z":"3788fae5.b038d6","name":"Publish","topic":"","qos":"0","retain":"false","broker":"2eafe4c0.b7da5c","x":520,"y":540,"wires":[]},{"id":"69c53cd7.421254","type":"function","z":"3788fae5.b038d6","name":"Set Source","func":"msg.topic = \"coffee_table/command\"\nmsg.payload = \"source_aux\"\nreturn msg","outputs":1,"noerr":0,"x":350,"y":540,"wires":[["4d87dc9e.05eec4"]]},{"id":"d0df7b03.3e7558","type":"mqtt out","z":"3788fae5.b038d6","name":"Publish","topic":"","qos":"0","retain":"false","broker":"2eafe4c0.b7da5c","x":520,"y":600,"wires":[]},{"id":"33e1c05.760b24","type":"function","z":"3788fae5.b038d6","name":"Pause","func":"msg.topic = \"coffee_table/command\"\nmsg.payload = \"pause\"\nreturn msg","outputs":1,"noerr":0,"x":330,"y":600,"wires":[["d0df7b03.3e7558"]]},{"id":"52759888.916928","type":"api-call-service","z":"ef54a0c2.e259d","name":"Select Source","server":"7d575fd3.be153","version":1,"service_domain":"media_player","service":"select_source","entityId":"media_player.spotify","data":"{\"source\":\"DESKTOP-P765FDU\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":580,"y":240,"wires":[["f1ef43ac.57113"]]},{"id":"594b1dc9.7baaf4","type":"api-call-service","z":"ef54a0c2.e259d","name":"Play Music","server":"7d575fd3.be153","version":"1","service_domain":"media_player","service":"play_media","entityId":"media_player.spotify","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":890,"y":240,"wires":[["345c013b.a4fdbe"]]},{"id":"ff1531c4.2fb2d","type":"change","z":"ef54a0c2.e259d","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":390,"y":240,"wires":[["52759888.916928"]]},{"id":"fa2b4fb.f01d7b","type":"link in","z":"ef54a0c2.e259d","name":"SpotifyPlayPlaylist","links":["bee3b9e6.682758","433622ba.a574ac","8ebc3823.28c588","616f1977.d61988"],"x":115,"y":240,"wires":[["ec05ddd9.e58c6"]]},{"id":"9b895081.0369a","type":"function","z":"3788fae5.b038d6","name":"IntervalMusic","func":"msg.payload=\"interval music uri\"\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":660,"wires":[["bee3b9e6.682758"]]},{"id":"f1ef43ac.57113","type":"function","z":"ef54a0c2.e259d","name":"Format","func":"var uri = flow.get(\"uri\")\n\nmsg.payload = \n{\n    data:\n    {\n        \"media_content_type\":\"playlist\",\n        \"media_content_id\":uri\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":240,"wires":[["594b1dc9.7baaf4"]]},{"id":"bee3b9e6.682758","type":"link out","z":"3788fae5.b038d6","name":"IntervalMusic","links":["fa2b4fb.f01d7b","99f978d8.77fdd8"],"x":475,"y":660,"wires":[]},{"id":"a1a2d7a5.e342d8","type":"link out","z":"3788fae5.b038d6","name":"MovieOffLights","links":["8653b724.b6b798"],"x":740,"y":380,"wires":[]},{"id":"fcc1f3e5.a12e","type":"mqtt out","z":"3788fae5.b038d6","name":"Publish","topic":"","qos":"0","retain":"false","broker":"2eafe4c0.b7da5c","x":960,"y":560,"wires":[]},{"id":"2f8776c0.82b32a","type":"mqtt out","z":"3788fae5.b038d6","name":"Publish","topic":"","qos":"0","retain":"false","broker":"2eafe4c0.b7da5c","x":960,"y":620,"wires":[]},{"id":"9bcd1e72.0f657","type":"function","z":"3788fae5.b038d6","name":"Play","func":"msg.topic = \"coffee_table/command\"\nmsg.payload = \"play\"\nreturn msg","outputs":1,"noerr":0,"x":770,"y":620,"wires":[["2f8776c0.82b32a"]]},{"id":"d0f7c7cc.490c18","type":"api-call-service","z":"3788fae5.b038d6","name":"LoungeLight","server":"7d575fd3.be153","version":"1","service_domain":"light","service":"turn_on","entityId":"light.lounge","data":"{\"rgb_color\":[0,30,30]}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":790,"y":440,"wires":[[]]},{"id":"38a48f73.f00b9","type":"api-call-service","z":"3788fae5.b038d6","name":"OutsideLightOff","server":"7d575fd3.be153","version":"1","service_domain":"light","service":"turn_off","entityId":"light.back","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":800,"y":500,"wires":[[]]},{"id":"69a6479d.ff2198","type":"function","z":"3788fae5.b038d6","name":"Set Source","func":"msg.topic = \"coffee_table/command\"\nmsg.payload = \"source_dvd\"\nreturn msg","outputs":1,"noerr":0,"x":790,"y":560,"wires":[["fcc1f3e5.a12e"]]},{"id":"d0d05ed0.1c20d","type":"api-call-service","z":"3788fae5.b038d6","name":"Stop Music","server":"7d575fd3.be153","version":"1","service_domain":"media_player","service":"media_stop","entityId":"media_player.spotify","data":"{\"source\":\"raspotify\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":790,"y":680,"wires":[[]]},{"id":"ba2848df.750b58","type":"link out","z":"152554cc.389edb","name":"Btn5 Pause","links":["f2adc0ca.e01d5"],"x":1895,"y":740,"wires":[]},{"id":"cf96bcfd.6d46d","type":"change","z":"3788fae5.b038d6","name":"","rules":[{"t":"set","p":"paused","pt":"global","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":370,"y":720,"wires":[[]]},{"id":"fd89f781.574d18","type":"change","z":"3788fae5.b038d6","name":"","rules":[{"t":"set","p":"paused","pt":"global","to":"false","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":810,"y":740,"wires":[[]]},{"id":"f38dc16c.16a27","type":"link in","z":"3788fae5.b038d6","name":"Play","links":["f65c5281.8848"],"x":595,"y":440,"wires":[["a1a2d7a5.e342d8","9bcd1e72.0f657","69a6479d.ff2198","d0d05ed0.1c20d","d0f7c7cc.490c18","38a48f73.f00b9","fd89f781.574d18"]]},{"id":"6d19006f.a4133","type":"switch","z":"152554cc.389edb","name":"","property":"paused","propertyType":"global","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1770,"y":720,"wires":[["ba2848df.750b58","f65c5281.8848"]]},{"id":"f65c5281.8848","type":"link out","z":"152554cc.389edb","name":"Button5 Play","links":["f38dc16c.16a27"],"x":1895,"y":680,"wires":[]},{"id":"345c013b.a4fdbe","type":"link out","z":"ef54a0c2.e259d","name":"SpotifyReturn","links":["99a3797d.d57128"],"x":1015,"y":240,"wires":[]},{"id":"cb698e84.66564","type":"cast-to-client","z":"8efb2399.f1af9","name":"","url":"","contentType":"","message":"","language":"en","ip":"","port":"","volume":"100","x":550,"y":80,"wires":[["936fad8c.17f24"]],"icon":"node-red-contrib-cast/home.png"},{"id":"545f3a7e.cf5f84","type":"change","z":"8efb2399.f1af9","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"ip","pt":"msg","to":"192.168.1.27","tot":"str"},{"t":"set","p":"message","pt":"msg","to":"music","tot":"str"},{"t":"set","p":"language","pt":"msg","to":"En-gb","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":380,"y":80,"wires":[["cb698e84.66564"]]},{"id":"a796fca6.d858c","type":"api-call-service","z":"8efb2399.f1af9","name":"Select Source","server":"7d575fd3.be153","version":"1","service_domain":"media_player","service":"select_source","entityId":"media_player.spotify","data":"{\"source\":\"bedroom_speaker\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":940,"y":80,"wires":[["21aad61.9a6152a"]]},{"id":"778151c5.49c37","type":"api-call-service","z":"8efb2399.f1af9","name":"Play Music","server":"7d575fd3.be153","version":"1","service_domain":"media_player","service":"play_media","entityId":"media_player.spotify","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1290,"y":80,"wires":[[]]},{"id":"936fad8c.17f24","type":"change","z":"8efb2399.f1af9","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":730,"y":80,"wires":[["a796fca6.d858c"]]},{"id":"21aad61.9a6152a","type":"function","z":"8efb2399.f1af9","name":"Format","func":"var uri = flow.get(\"uri\")\n\nmsg.payload = \n{\n    data:\n    {\n        \"media_content_type\":\"playlist\",\n        \"media_content_id\":uri\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":1120,"y":80,"wires":[["778151c5.49c37"]]},{"id":"3a88dc46.74acb4","type":"function","z":"8efb2399.f1af9","name":"Save URI","func":"flow.set(\"uri\", msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["545f3a7e.cf5f84"]]},{"id":"ec05ddd9.e58c6","type":"function","z":"ef54a0c2.e259d","name":"Save URI","func":"flow.set(\"uri\", msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":220,"y":240,"wires":[["ff1531c4.2fb2d"]]},{"id":"2721a371.68b63c","type":"subflow:8efb2399.f1af9","z":"ef54a0c2.e259d","name":"Play On GHM","env":[],"x":230,"y":480,"wires":[]},{"id":"ebb644f1.87aee8","type":"api-call-service","z":"8dc4db95.863a28","name":"Select Source","server":"7d575fd3.be153","service_domain":"media_player","service":"select_source","data":"{\"entity_id\":\"media_player.spotify\",\"source\":\"raspotify\"}","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":600,"y":80,"wires":[["acdb9595.de7918"]]},{"id":"a168d8f.5574f28","type":"api-call-service","z":"8dc4db95.863a28","name":"Play Music","server":"7d575fd3.be153","service_domain":"media_player","service":"play_media","data":"{\"entity_id\":\"media_player.spotify\"}","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":910,"y":80,"wires":[[]]},{"id":"ffe7743c.8fb3a8","type":"change","z":"8dc4db95.863a28","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":410,"y":80,"wires":[["ebb644f1.87aee8"]]},{"id":"acdb9595.de7918","type":"function","z":"8dc4db95.863a28","name":"Restore","func":"msg.payload = flow.get(\"data\")\nreturn msg;","outputs":1,"noerr":0,"x":760,"y":80,"wires":[["a168d8f.5574f28"]]},{"id":"60efd2b7.c8f81c","type":"function","z":"8dc4db95.863a28","name":"Save Payload","func":"flow.set(\"data\", msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["ffe7743c.8fb3a8"]]},{"id":"2812674d.817bc8","type":"function","z":"fa310ecb.c84eb","name":"John Mayer","func":"msg.payload=\"spotify:playlist:37i9dQZF1DWYrlaUEYy4Vg\"\nreturn msg;","outputs":1,"noerr":0,"x":400,"y":500,"wires":[["9ddaee69.14da5"]]},{"id":"b3a79b0b.db0ed8","type":"inject","z":"fa310ecb.c84eb","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":220,"y":500,"wires":[["2812674d.817bc8"]]},{"id":"9ddaee69.14da5","type":"subflow:8efb2399.f1af9","z":"fa310ecb.c84eb","name":"","env":[],"x":600,"y":500,"wires":[]},{"id":"16dd58a7.09dac7","type":"api-call-service","z":"152554cc.389edb","name":"","server":"7d575fd3.be153","version":"1","service_domain":"persistent_notification","service":"create","entityId":"philip","data":"{\"message\":\"Test\",\"title\":\"Test Message\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":960,"y":560,"wires":[[]]},{"id":"cb97531.f1c1cb","type":"function","z":"152554cc.389edb","name":"Show Tag","func":"var tag = msg.payload\n\nmsg.payload = \n{\n    data:\n    {\n        \"message\": msg.payload,\n        \"title\": \"Unrecognised Tag\"\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":700,"y":560,"wires":[["16dd58a7.09dac7"]]},{"id":"ab7054af.900578","type":"file","z":"152554cc.389edb","name":"save tag","filename":"/share/unhandled_tags.txt","appendNewline":true,"createDir":false,"overwriteFile":"false","encoding":"none","x":720,"y":500,"wires":[[]]},{"id":"3588c40.30fe83c","type":"api-call-service","z":"152554cc.389edb","name":"Select Source","server":"7d575fd3.be153","version":1,"service_domain":"media_player","service":"select_source","entityId":"media_player.spotify_phil","data":"{\"source\":\"Onkyo TX-NR575E F3F71F\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1020,"y":620,"wires":[["b0e16619.df8b38"]]},{"id":"964c8b2c.5aed58","type":"api-call-service","z":"152554cc.389edb","name":"Play Music","server":"7d575fd3.be153","version":1,"service_domain":"media_player","service":"play_media","entityId":"media_player.spotify_phil","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1230,"y":540,"wires":[["cab35574.45d8b8"]]},{"id":"2a65857f.b92bfa","type":"change","z":"152554cc.389edb","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":830,"y":620,"wires":[["3588c40.30fe83c","e7d9d2d6.63e2"]]},{"id":"b0e16619.df8b38","type":"function","z":"152554cc.389edb","name":"Restore","func":"msg.payload = flow.get(\"data\")\nreturn msg;","outputs":1,"noerr":0,"x":1180,"y":620,"wires":[["964c8b2c.5aed58","352d393b.28cc76"]]},{"id":"9797be1a.8e886","type":"function","z":"152554cc.389edb","name":"Save Payload","func":"flow.set(\"data\", msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":620,"y":620,"wires":[["2a65857f.b92bfa"]]},{"id":"9caa92a0.a7d8b","type":"debug","z":"152554cc.389edb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1560,"y":680,"wires":[]},{"id":"91e1aa96.f61138","type":"debug","z":"152554cc.389edb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1550,"y":960,"wires":[]},{"id":"6830a69e.0e1898","type":"mqtt in","z":"152554cc.389edb","name":"Button 2","topic":"coffee_table/btn2","qos":"0","datatype":"auto","broker":"2eafe4c0.b7da5c","x":1340,"y":1060,"wires":[["cfb8664b.53ecb8"]]},{"id":"3f7a74fb.3a8d6c","type":"mqtt in","z":"152554cc.389edb","name":"Button 3","topic":"coffee_table/btn3","qos":"0","datatype":"auto","broker":"2eafe4c0.b7da5c","x":1340,"y":1200,"wires":[["c8b64d36.f35","9eff93a3.d32b8"]]},{"id":"c8b64d36.f35","type":"debug","z":"152554cc.389edb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1580,"y":1160,"wires":[]},{"id":"1232e22b.3aa97e","type":"mqtt out","z":"152554cc.389edb","name":"","topic":"","qos":"","retain":"","broker":"2eafe4c0.b7da5c","x":1230,"y":480,"wires":[]},{"id":"be753f6e.c4262","type":"function","z":"152554cc.389edb","name":"Amp Source","func":"msg.topic = \"coffee_table/command\"\nmsg.payload = \"source_aux\"\nreturn msg;","outputs":1,"noerr":0,"x":1060,"y":480,"wires":[["1232e22b.3aa97e"]]},{"id":"b0082697.274b38","type":"api-call-service","z":"ef54a0c2.e259d","name":"Select Source","server":"7d575fd3.be153","version":1,"service_domain":"media_player","service":"select_source","entityId":"media_player.spotify","data":"{\"source\":\"DESKTOP-P765FDU\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":500,"y":540,"wires":[["3a9da6fb.a2677a"]]},{"id":"f7fb213a.c8af1","type":"api-call-service","z":"ef54a0c2.e259d","name":"Play Music","server":"7d575fd3.be153","version":1,"service_domain":"media_player","service":"play_media","entityId":"media_player.spotify","data":"{\"media_content_type\":\"playlist\",\"media_content_id\":\"spotify:playlist:37i9dQZF1DWYrlaUEYy4Vg\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":870,"y":540,"wires":[[]]},{"id":"3a9da6fb.a2677a","type":"function","z":"ef54a0c2.e259d","name":"John Mayer","func":"msg.payload = \n{\n    data:\n    {\n        \"media_content_type\":\"playlist\",\n        \"media_content_id\":\"spotify:playlist:37i9dQZF1DWYrlaUEYy4Vg\"\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":670,"y":540,"wires":[["f7fb213a.c8af1","6003dd5b.6a7464"]]},{"id":"6003dd5b.6a7464","type":"debug","z":"ef54a0c2.e259d","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":870,"y":620,"wires":[]},{"id":"9096b173.59172","type":"inject","z":"ef54a0c2.e259d","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":260,"y":560,"wires":[["b0082697.274b38"]]},{"id":"f9978cbe.2de58","type":"spotify","z":"ef54a0c2.e259d","name":"Spotify","auth":"6db11244.bdedac","api":"getMyDevices","x":350,"y":340,"wires":[["47093f16.49e58"]]},{"id":"3456a225.cc296e","type":"inject","z":"ef54a0c2.e259d","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"Devices","payloadType":"str","x":190,"y":340,"wires":[["f9978cbe.2de58"]]},{"id":"47093f16.49e58","type":"debug","z":"ef54a0c2.e259d","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":510,"y":340,"wires":[]},{"id":"a17917a4.abed38","type":"spotify","z":"ef54a0c2.e259d","name":"Spotify","auth":"6db11244.bdedac","api":"getUserPlaylists","x":350,"y":400,"wires":[["59e2dd4b.62e0c4"]]},{"id":"5dc5d578.0d57cc","type":"inject","z":"ef54a0c2.e259d","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"Playlists","payloadType":"str","x":200,"y":400,"wires":[["a17917a4.abed38"]]},{"id":"59e2dd4b.62e0c4","type":"debug","z":"ef54a0c2.e259d","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":530,"y":400,"wires":[]},{"id":"9e84bbab.f55708","type":"inject","z":"ef54a0c2.e259d","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":520,"y":480,"wires":[["3a9da6fb.a2677a"]]},{"id":"bdf4bd0d.46605","type":"inject","z":"ef54a0c2.e259d","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":720,"y":460,"wires":[["f7fb213a.c8af1"]]},{"id":"c314409e.98e99","type":"mqtt in","z":"152554cc.389edb","name":"Button 6","topic":"coffee_table/btn6","qos":"0","datatype":"auto","broker":"2eafe4c0.b7da5c","x":1380,"y":360,"wires":[["f1a3ca51.122d78"]]},{"id":"668cf769.103728","type":"mqtt in","z":"152554cc.389edb","name":"Button 4","topic":"coffee_table/btn4","qos":"0","datatype":"auto","broker":"2eafe4c0.b7da5c","x":1340,"y":920,"wires":[["82a2581a.cf2ae8","91e1aa96.f61138"]]},{"id":"9eff93a3.d32b8","type":"switch","z":"152554cc.389edb","name":"Click Type","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"click","vt":"str"},{"t":"eq","v":"hold","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1530,"y":1260,"wires":[["3b7f265a.6b708a"],["912c420d.2b4d8"]]},{"id":"5f47c1e.369284","type":"api-current-state","z":"5e97ea24.516424","name":"Did it rain?","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"0.1","halt_if_type":"num","halt_if_compare":"gt","override_topic":false,"entity_id":"sensor.dark_sky_precip_intensity","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":430,"y":500,"wires":[["9b0c4919.432c68"],["5650274e.3a1738"]]},{"id":"83c823a.f8046e","type":"api-current-state","z":"5e97ea24.516424","name":"Max temp","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"0","halt_if_type":"num","halt_if_compare":"gt","override_topic":false,"entity_id":"sensor.dark_sky_forecast_daytime_high_temperature_0d","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":440,"y":580,"wires":[["9885bb2b.020218"],[]]},{"id":"9885bb2b.020218","type":"function","z":"5e97ea24.516424","name":"Water Time","func":"msg.max_temp = msg.payload\nvar seconds = (0.5 * msg.payload) * 60\nvar pulse = 0;\n\nif(seconds <= 11)\n{\n    pulse = seconds * 10;\n}\nelse\n{\n    pulse = seconds + 100;\n}\nmsg.topic = \"sonoff_garden/cmnd/PulseTime\"\nmsg.payload = pulse\n\nmsg.delay = (seconds + 60) * 1000\nmsg.seconds = seconds\n\nreturn msg;","outputs":1,"noerr":0,"x":630,"y":580,"wires":[["c0a2e16.268822","bedb8077.e3b2","6ce2a0d7.53834","48ccf6bc.6f7a98"]]},{"id":"bedb8077.e3b2","type":"mqtt out","z":"5e97ea24.516424","name":"","topic":"","qos":"","retain":"","broker":"2eafe4c0.b7da5c","x":1146,"y":580,"wires":[]},{"id":"5650274e.3a1738","type":"function","z":"5e97ea24.516424","name":"Prepare text","func":"msg.rainfall = msg.payload\nreturn msg;","outputs":1,"noerr":0,"x":630,"y":500,"wires":[["83c823a.f8046e"]]},{"id":"c0a2e16.268822","type":"function","z":"5e97ea24.516424","name":"Prepare Text","func":"msg.topic = \"garden\"\nmsg.payload = \"PM Water Time: \" + ((msg.payload - 100) / 60);\nmsg.payload += \" minutes\\n\";\nmsg.payload += \"Rain Today: \" + msg.rainfall;\nmsg.payload += \" mm\\n\";\nmsg.payload += \"Max Temp: \" + msg.max_temp;\nmsg.payload += \"C\";\nreturn msg;","outputs":1,"noerr":0,"x":850,"y":640,"wires":[["3a7c0926.309d16"]]},{"id":"e24fae3.91ca85","type":"inject","z":"5e97ea24.516424","name":"8pm","repeat":"","crontab":"00 20 * * *","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":250,"y":500,"wires":[["5f47c1e.369284"]]},{"id":"9b0c4919.432c68","type":"function","z":"5e97ea24.516424","name":"Prepare Text","func":"msg.topic = \"garden\"\nvar rainfall = msg.payload;\nmsg.payload = \"No water tonight, it rained.\"\nmsg.payload += \"Rain Today: \" + rainfall;\nmsg.payload += \" mm\\n\";\nreturn msg;","outputs":1,"noerr":0,"x":630,"y":460,"wires":[["e5039bb6.86f6d8"]]},{"id":"11d949ee.321536","type":"inject","z":"62f232c2.0dd08c","name":"11:30am","repeat":"","crontab":"30 11 * * *","once":false,"onceDelay":0.1,"topic":"batteries","payload":"","payloadType":"date","x":130,"y":80,"wires":[["8f5c3a46.14b858"]]},{"id":"ff0d71bd.d2b91","type":"comment","z":"62f232c2.0dd08c","name":"Low battery alert","info":"","x":160,"y":40,"wires":[]},{"id":"d7c42c52.4c3e","type":"server-state-changed","z":"62f232c2.0dd08c","name":"MQTT Pair","server":"7d575fd3.be153","version":1,"entityidfilter":"input_boolean.zigbee_permit_join","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":160,"y":240,"wires":[["c9ef9198.2a334"],["aa68a33b.3692"]]},{"id":"1fe49938.52d287","type":"mqtt out","z":"62f232c2.0dd08c","name":"","topic":"","qos":"","retain":"","broker":"2eafe4c0.b7da5c","x":690,"y":240,"wires":[]},{"id":"5ea20869.b1c748","type":"function","z":"62f232c2.0dd08c","name":"Join on","func":"msg.topic = \"zigbee2mqtt/bridge/config/permit_join\"\nmsg.payload = \"true\"\nreturn msg;","outputs":1,"noerr":0,"x":520,"y":200,"wires":[["1fe49938.52d287"]]},{"id":"c9ef9198.2a334","type":"api-call-service","z":"62f232c2.0dd08c","name":"Start Timer","server":"7d575fd3.be153","version":1,"service_domain":"timer","service":"start","entityId":"timer.zigbee_permit_join","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":350,"y":200,"wires":[["5ea20869.b1c748"]]},{"id":"aa68a33b.3692","type":"api-call-service","z":"62f232c2.0dd08c","name":"Stop Timer","server":"7d575fd3.be153","version":1,"service_domain":"timer","service":"cancel","entityId":"timer.zigbee_permit_join","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":350,"y":280,"wires":[[]]},{"id":"cdf5e2d6.f8e5f","type":"function","z":"62f232c2.0dd08c","name":"Join off","func":"msg.topic = \"zigbee2mqtt/bridge/config/permit_join\"\nmsg.payload = \"false\"\nreturn msg;","outputs":1,"noerr":0,"x":520,"y":280,"wires":[["1fe49938.52d287"]]},{"id":"54c2f5a5.aff98c","type":"server-state-changed","z":"62f232c2.0dd08c","name":"Pair Timer Expired","server":"7d575fd3.be153","version":1,"entityidfilter":"timer.zigbee_permit_join","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"idle","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":170,"y":340,"wires":[["741a1712.015708"],[]]},{"id":"741a1712.015708","type":"api-call-service","z":"62f232c2.0dd08c","name":"clear bool","server":"7d575fd3.be153","version":1,"service_domain":"input_boolean","service":"turn_off","entityId":"input_boolean.zigbee_permit_join","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":360,"y":340,"wires":[["cdf5e2d6.f8e5f"]]},{"id":"66f9c23a.75febc","type":"comment","z":"62f232c2.0dd08c","name":"Zigbee Pairing","info":"","x":150,"y":180,"wires":[]},{"id":"4e8e5e9a.35431","type":"status","z":"62f232c2.0dd08c","name":"HASSIO Boot","scope":["d7c42c52.4c3e"],"x":230,"y":500,"wires":[["2cc991c7.0b963e"]]},{"id":"2cc991c7.0b963e","type":"switch","z":"62f232c2.0dd08c","name":"","property":"status.text","propertyType":"msg","rules":[{"t":"eq","v":"connected","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":390,"y":500,"wires":[["b211aafc.28b0d8"]]},{"id":"cc487fc2.b40e4","type":"status","z":"152554cc.389edb","name":"HASSIO Boot","scope":["d82b898d.8d2e48"],"x":90,"y":180,"wires":[["7511ac32.864f94"]]},{"id":"7511ac32.864f94","type":"switch","z":"152554cc.389edb","name":"","property":"status.text","propertyType":"msg","rules":[{"t":"eq","v":"connected","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":250,"y":180,"wires":[["f11098a2.4b88f8"]]},{"id":"66f45eb2.0ae32","type":"ha-get-entities","z":"62f232c2.0dd08c","server":"7d575fd3.be153","name":"Batteries","rules":[{"property":"attributes.battery_level","logic":"gt","value":"0","valueType":"num"}],"output_type":"array","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":580,"y":580,"wires":[["10721432.a6deac"]]},{"id":"10721432.a6deac","type":"function","z":"62f232c2.0dd08c","name":"Parse","func":"var message = \"Battery Levels:\\n\"\nfor(i = 0 ; i < msg.payload.length; i++)\n{\n    message += msg.payload[i].attributes.friendly_name + \": \"\n    message += msg.payload[i].attributes.battery_level + \"%\\n\"\n}\n\nmsg.payload = flow.get('reply');\nmsg.payload.content = message\nreturn msg;","outputs":1,"noerr":0,"x":730,"y":580,"wires":[[]]},{"id":"323abf5c.a08e7","type":"function","z":"62f232c2.0dd08c","name":"Save reply","func":"flow.set(\"reply\", msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":580,"wires":[["66f45eb2.0ae32"]]},{"id":"951ebb1b.aedb38","type":"comment","z":"86a3c02f.3051a","name":"TRIGGER ALARM CLOCK","info":"","x":230,"y":120,"wires":[]},{"id":"21a768bf.736828","type":"join","z":"86a3c02f.3051a","name":"","mode":"custom","build":"array","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"2","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1170,"y":140,"wires":[["72ba238c.949acc"]]},{"id":"72ba238c.949acc","type":"function","z":"86a3c02f.3051a","name":"Compare Times","func":"newmsg = {};\nif (msg.payload[0] == msg.payload[1]) {\n    newmsg.payload = \"True\";\n} else {\n    newmsg.payload = \"False\";\n}\n\nreturn newmsg;","outputs":1,"noerr":0,"x":1180,"y":200,"wires":[["f1ba2345.5cc9a"]]},{"id":"f1ba2345.5cc9a","type":"switch","z":"86a3c02f.3051a","name":"Is it Time?","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"True","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1190,"y":260,"wires":[["49b0602e.96e57","e7230f88.15f9e"]]},{"id":"617433c5.87712c","type":"api-current-state","z":"86a3c02f.3051a","name":"Alarm Clock ON?","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.alarm_clock_enabled","state_type":"habool","state_location":"","override_payload":"none","entity_location":"","override_data":"none","blockInputOverrides":false,"x":610,"y":180,"wires":[["a31fd267.fff56","66f16d49.ceea74"],[]]},{"id":"a31fd267.fff56","type":"api-current-state","z":"86a3c02f.3051a","name":"Get Alarm Time","server":"7d575fd3.be153","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":true,"entity_id":"input_datetime.alarmclock_time","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":920,"y":260,"wires":[["1197e274.51606e"]]},{"id":"66f16d49.ceea74","type":"moment","z":"86a3c02f.3051a","name":"Current Time","topic":"","input":"","inputType":"date","inTz":"Africa/Johannesburg","adjAmount":"0","adjType":"minutes","adjDir":"add","format":"H:mm","locale":"C","output":"payload","outputType":"msg","outTz":"Africa/Johannesburg","x":930,"y":140,"wires":[["21a768bf.736828"]]},{"id":"4ed7e717.239db8","type":"inject","z":"86a3c02f.3051a","name":"","repeat":"60","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":190,"y":180,"wires":[["8aeb0a62.eafe88"]]},{"id":"1197e274.51606e","type":"moment","z":"86a3c02f.3051a","name":"Alarm - 10min","topic":"","input":"payload","inputType":"msg","inTz":"Africa/Johannesburg","adjAmount":"10","adjType":"minutes","adjDir":"subtract","format":"H:mm","locale":"C","output":"payload","outputType":"msg","outTz":"Africa/Johannesburg","x":920,"y":200,"wires":[["21a768bf.736828"]]},{"id":"49b0602e.96e57","type":"api-call-service","z":"86a3c02f.3051a","name":"House State - Waking Up","server":"7d575fd3.be153","version":1,"service_domain":"input_boolean","service":"turn_on","entityId":"input_boolean.alarm_clock_active","data":"","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"msg","mustacheAltTags":false,"x":1470,"y":200,"wires":[[]]},{"id":"f261c354.9a785","type":"server-state-changed","z":"86a3c02f.3051a","name":"Wake Up House","server":"7d575fd3.be153","version":1,"entityidfilter":"input_boolean.alarm_clock_active","entityidfiltertype":"substring","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":400,"y":460,"wires":[["45474777.933ac8","3dea446c.b5e58c","9299d151.36775"],[]]},{"id":"8aeb0a62.eafe88","type":"api-current-state","z":"86a3c02f.3051a","name":"Philip is home","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"home","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"device_tracker.mi9tpro_miphone","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":400,"y":180,"wires":[["617433c5.87712c"],[]]},{"id":"b37f9998.3759e8","type":"function","z":"86a3c02f.3051a","name":"Sunrise Effect","func":"msg.payload = \n{\n    data:\n    {\n        \"effect\": \"Sunrise\"\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":860,"y":440,"wires":[["4d54e0ea.338b1"]]},{"id":"4d54e0ea.338b1","type":"api-call-service","z":"86a3c02f.3051a","name":"Bedroom Lights","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_on","entityId":"light.bedroom","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1060,"y":440,"wires":[[]]},{"id":"45474777.933ac8","type":"api-current-state","z":"86a3c02f.3051a","name":"Music Enabled","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.alarm_clock_music","state_type":"habool","state_location":"","override_payload":"none","entity_location":"","override_data":"none","blockInputOverrides":false,"x":620,"y":520,"wires":[["749d4018.ec617"],[]]},{"id":"3dea446c.b5e58c","type":"api-current-state","z":"86a3c02f.3051a","name":"Lights Enabled","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.alarm_clock_lights","state_type":"habool","state_location":"","override_payload":"none","entity_location":"","override_data":"none","blockInputOverrides":false,"x":640,"y":420,"wires":[["b37f9998.3759e8"],[]]},{"id":"749d4018.ec617","type":"function","z":"86a3c02f.3051a","name":"Load Playlist","func":"msg.payload = \n{\n    data:\n    {\n        \"device_name\":\"Bedroom speaker\",\n        \"uri\":\"spotify:playlist:37i9dQZF1DX1rVvRgjX59F\",\n        \"random_song\": true\n    }\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":850,"y":520,"wires":[["e2c10bbd.552c28"]]},{"id":"dea0e52f.d0eb08","type":"api-call-service","z":"86a3c02f.3051a","name":"Spotcast","server":"7d575fd3.be153","version":1,"service_domain":"spotcast","service":"start","entityId":"bitbrain-za","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1200,"y":520,"wires":[[]]},{"id":"777251bb.27d0f","type":"delay","z":"86a3c02f.3051a","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":580,"y":640,"wires":[["209f25f6.5060ea"]]},{"id":"9e7d566f.c0eeb8","type":"link in","z":"86a3c02f.3051a","name":"","links":["34964cfd.3c65e4","66b80fc4.ba25b","f6c80296.f4169","e4ac6eb1.fcbac","51cf81a7.976a8"],"x":135,"y":700,"wires":[["6ac50ad7.b3eb24"]]},{"id":"a2dbb7bf.7abb28","type":"api-call-service","z":"86a3c02f.3051a","name":"House State - Waking Up","server":"7d575fd3.be153","version":1,"service_domain":"input_boolean","service":"turn_on","entityId":"input_boolean.alarm_clock_active","data":"","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"msg","mustacheAltTags":false,"x":1110,"y":620,"wires":[[]]},{"id":"8e96267b.55e438","type":"api-call-service","z":"86a3c02f.3051a","name":"House State - Snooze","server":"7d575fd3.be153","version":1,"service_domain":"input_boolean","service":"turn_off","entityId":"input_boolean.alarm_clock_active","data":"","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"msg","mustacheAltTags":false,"x":580,"y":900,"wires":[[]]},{"id":"6ac50ad7.b3eb24","type":"api-current-state","z":"86a3c02f.3051a","name":"Currently Active","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.alarm_clock_active","state_type":"habool","state_location":"","override_payload":"none","entity_location":"","override_data":"none","blockInputOverrides":false,"x":300,"y":700,"wires":[["777251bb.27d0f","8e96267b.55e438","fd44a722.43ea38","d2ec98c7.e44a18","bbb99ab7.14d918"],[]]},{"id":"c60a710d.89a63","type":"link in","z":"86a3c02f.3051a","name":"","links":["859b99e7.e716b8","bd6bd6b4.21ebb8","e8b6e211.8391f","f1c1ba61.562008"],"x":675,"y":1240,"wires":[["8ff826ff.336198"]]},{"id":"8ff826ff.336198","type":"api-current-state","z":"86a3c02f.3051a","name":"Alarm Active","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.alarm_clock_active","state_type":"habool","state_location":"","override_payload":"none","entity_location":"","override_data":"none","blockInputOverrides":false,"x":810,"y":1240,"wires":[["89aceef6.5c2db","60205cc6.113a64","cedba0b5.8b3b7"],[]]},{"id":"89aceef6.5c2db","type":"api-call-service","z":"86a3c02f.3051a","name":"House State - Awake","server":"7d575fd3.be153","version":1,"service_domain":"input_boolean","service":"turn_off","entityId":"input_boolean.alarm_clock_active","data":"","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"msg","mustacheAltTags":false,"x":1040,"y":1320,"wires":[[]]},{"id":"e7230f88.15f9e","type":"api-call-service","z":"86a3c02f.3051a","name":"Turn Off AC","server":"7d575fd3.be153","version":1,"service_domain":"climate","service":"turn_off","entityId":"climate.bedroom_ac","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1430,"y":340,"wires":[[]]},{"id":"f1c885ac.695b58","type":"inject","z":"86a3c02f.3051a","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1380,"y":120,"wires":[["49b0602e.96e57"]]},{"id":"89154aae.1a8ea8","type":"api-current-state","z":"86a3c02f.3051a","name":"","server":"7d575fd3.be153","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.alarm_clock_active","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1220,"y":740,"wires":[["96024a8.f9d60b8"]]},{"id":"7d96a4a1.fd496c","type":"inject","z":"86a3c02f.3051a","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":940,"y":740,"wires":[["89154aae.1a8ea8"]]},{"id":"96024a8.f9d60b8","type":"debug","z":"86a3c02f.3051a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1550,"y":740,"wires":[]},{"id":"9b89ed1.d99b51","type":"inject","z":"86a3c02f.3051a","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":720,"y":1100,"wires":[["8ff826ff.336198"]]},{"id":"4d7464c1.e964ec","type":"inject","z":"86a3c02f.3051a","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":140,"y":600,"wires":[["6ac50ad7.b3eb24"]]},{"id":"209f25f6.5060ea","type":"api-current-state","z":"86a3c02f.3051a","name":"Snooze Still On","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.alarm_clock_snooze","state_type":"habool","state_location":"","override_payload":"none","entity_location":"","override_data":"none","blockInputOverrides":false,"x":800,"y":640,"wires":[["a2dbb7bf.7abb28"],[]]},{"id":"7ba7db28.473424","type":"api-current-state","z":"86a3c02f.3051a","name":"","server":"7d575fd3.be153","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.alarm_clock_snooze","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1230,"y":820,"wires":[["da7d0908.080878"]]},{"id":"222bbc2f.35a954","type":"inject","z":"86a3c02f.3051a","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":940,"y":820,"wires":[["7ba7db28.473424"]]},{"id":"da7d0908.080878","type":"debug","z":"86a3c02f.3051a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1550,"y":820,"wires":[]},{"id":"bbb99ab7.14d918","type":"api-call-service","z":"86a3c02f.3051a","name":"Snooze On","server":"7d575fd3.be153","version":1,"service_domain":"input_boolean","service":"turn_on","entityId":"input_boolean.alarm_clock_snooze","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":550,"y":840,"wires":[[]]},{"id":"d2ec98c7.e44a18","type":"api-call-service","z":"86a3c02f.3051a","name":"Pause Music","server":"7d575fd3.be153","version":1,"service_domain":"media_player","service":"media_pause","entityId":"media_player.spotify_phil","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":550,"y":780,"wires":[[]]},{"id":"fd44a722.43ea38","type":"api-call-service","z":"86a3c02f.3051a","name":"Bedroom Lights","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"light.bedroom","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":560,"y":720,"wires":[[]]},{"id":"60205cc6.113a64","type":"api-call-service","z":"86a3c02f.3051a","name":"Snooze Off","server":"7d575fd3.be153","version":1,"service_domain":"input_boolean","service":"turn_off","entityId":"input_boolean.alarm_clock_snooze","data":"","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"msg","mustacheAltTags":false,"x":1010,"y":1240,"wires":[[]]},{"id":"cedba0b5.8b3b7","type":"function","z":"86a3c02f.3051a","name":"Dawn","func":"msg.payload = \n{\n    data:\n    {\n        \"brightness\":255,\n        \"color_temp\": \"2500\"\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":990,"y":1180,"wires":[["398ef51a.729b6a"]]},{"id":"398ef51a.729b6a","type":"api-call-service","z":"86a3c02f.3051a","name":"Bedroom Lights","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_on","entityId":"light.bedroom","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1220,"y":1180,"wires":[[]]},{"id":"80d3f246.1704d","type":"link in","z":"86a3c02f.3051a","name":"","links":["34964cfd.3c65e4","66b80fc4.ba25b","f6c80296.f4169","e4ac6eb1.fcbac","51cf81a7.976a8"],"x":635,"y":1460,"wires":[["1168c01c.2fbe4"]]},{"id":"1168c01c.2fbe4","type":"api-current-state","z":"86a3c02f.3051a","name":"Currently Active","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.alarm_clock_active","state_type":"habool","state_location":"","override_payload":"none","entity_location":"","override_data":"none","blockInputOverrides":false,"x":780,"y":1460,"wires":[[],["5b454d26.040844"]]},{"id":"5b454d26.040844","type":"api-current-state","z":"86a3c02f.3051a","name":"Lights on?","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"light.bedroom","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":990,"y":1460,"wires":[["885c2d4.b0f47d"],["fdf37a8d.98bfc8"]]},{"id":"885c2d4.b0f47d","type":"api-call-service","z":"86a3c02f.3051a","name":"Bedroom Lights","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"light.bedroom","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1220,"y":1420,"wires":[[]]},{"id":"fdf37a8d.98bfc8","type":"api-current-state","z":"86a3c02f.3051a","name":"After Bedtime","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.bedtime","state_type":"habool","state_location":"","override_payload":"none","entity_location":"","override_data":"none","blockInputOverrides":false,"x":1220,"y":1500,"wires":[["380edbd6.9993a4"],["cf2d2127.960e"]]},{"id":"380edbd6.9993a4","type":"function","z":"86a3c02f.3051a","name":"Red","func":"msg.payload = \n{\n    data:\n    {\n        \"brightness_pct\":20,\n        \"rgb_color\":[255,0,0]\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":1430,"y":1460,"wires":[["64914934.088278"]]},{"id":"64914934.088278","type":"api-call-service","z":"86a3c02f.3051a","name":"Bedroom Lights","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_on","entityId":"light.bedroom","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1620,"y":1500,"wires":[[]]},{"id":"cf2d2127.960e","type":"function","z":"86a3c02f.3051a","name":"White","func":"msg.payload = \n{\n    data:\n    {\n        \"brightness\":255,\n        \"color_temp\":268\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":1430,"y":1540,"wires":[["64914934.088278"]]},{"id":"6dee1e13.58fe4","type":"link in","z":"86a3c02f.3051a","name":"","links":["859b99e7.e716b8","bd6bd6b4.21ebb8","e8b6e211.8391f","f1c1ba61.562008"],"x":875,"y":960,"wires":[["22caf5ba.da849a"]]},{"id":"22caf5ba.da849a","type":"api-current-state","z":"86a3c02f.3051a","name":"Alarm Active","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.alarm_clock_active","state_type":"habool","state_location":"","override_payload":"none","entity_location":"","override_data":"none","blockInputOverrides":false,"x":1010,"y":960,"wires":[[],[]]},{"id":"6adf3725.b2d148","type":"link in","z":"86a3c02f.3051a","name":"","links":["1095f41a.a65f3c","124c0dae.d8e8a2","4acd8c9.9778e74","90adabb3.bf43c8"],"x":775,"y":1780,"wires":[["ce17ec80.a2256"]]},{"id":"f22572ad.fd772","type":"api-current-state","z":"86a3c02f.3051a","name":"After Bedtime","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.bedtime","state_type":"habool","state_location":"","override_payload":"none","entity_location":"","override_data":"none","blockInputOverrides":false,"x":1240,"y":1780,"wires":[["214e1978.86b3a6","6b5f3339.b0213c"],["58efeb79.8b6464"]]},{"id":"ce17ec80.a2256","type":"api-call-service","z":"86a3c02f.3051a","name":"toggle bedtime","server":"7d575fd3.be153","version":1,"service_domain":"input_boolean","service":"toggle","entityId":"input_boolean.bedtime","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":920,"y":1780,"wires":[["f22572ad.fd772"]]},{"id":"214e1978.86b3a6","type":"function","z":"86a3c02f.3051a","name":"Red","func":"msg.payload = \n{\n    data:\n    {\n        \"brightness_pct\":20,\n        \"rgb_color\":[255,0,0]\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":1470,"y":1740,"wires":[["c5d3aa58.90c388"]]},{"id":"c5d3aa58.90c388","type":"api-call-service","z":"86a3c02f.3051a","name":"Bedroom Lights","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_on","entityId":"light.bedroom","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1660,"y":1780,"wires":[[]]},{"id":"58efeb79.8b6464","type":"function","z":"86a3c02f.3051a","name":"White","func":"msg.payload = \n{\n    data:\n    {\n        \"brightness\":255,\n        \"color_temp\":268\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":1470,"y":1820,"wires":[["c5d3aa58.90c388"]]},{"id":"9299d151.36775","type":"stoptimer","z":"86a3c02f.3051a","duration":"40","units":"Minute","payloadtype":"num","payloadval":"0","name":"","x":640,"y":340,"wires":[["bf9efdec.52f43","3fc373d6.eae9fc"],[]]},{"id":"bf9efdec.52f43","type":"api-call-service","z":"86a3c02f.3051a","name":"House State - Awake","server":"7d575fd3.be153","version":1,"service_domain":"input_boolean","service":"turn_off","entityId":"input_boolean.alarm_clock_active","data":"","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"msg","mustacheAltTags":false,"x":900,"y":340,"wires":[[]]},{"id":"3fc373d6.eae9fc","type":"api-call-service","z":"86a3c02f.3051a","name":"Snooze Off","server":"7d575fd3.be153","version":1,"service_domain":"input_boolean","service":"turn_off","entityId":"input_boolean.alarm_clock_snooze","data":"","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"msg","mustacheAltTags":false,"x":870,"y":380,"wires":[[]]},{"id":"8a4be04.d03a02","type":"comment","z":"86a3c02f.3051a","name":"Long click, end alarm","info":"","x":960,"y":1100,"wires":[]},{"id":"8212694c.b17548","type":"comment","z":"86a3c02f.3051a","name":"Click, no alarm. Toggle Lights","info":"","x":780,"y":1400,"wires":[]},{"id":"69a1b8b6.4e7518","type":"comment","z":"86a3c02f.3051a","name":"Double click. Toggle Bedtime state","info":"","x":1060,"y":1720,"wires":[]},{"id":"e50adb11.c46a18","type":"comment","z":"86a3c02f.3051a","name":"Click - Snooze","info":"","x":210,"y":780,"wires":[]},{"id":"eb4ca30a.d8017","type":"api-current-state","z":"81d9975e.584f98","name":"Light On?","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"light.mes","state_type":"str","state_location":"","override_payload":"none","entity_location":"","override_data":"none","blockInputOverrides":false,"x":1020,"y":440,"wires":[["c6f751b1.69167"],["ac36ceda.a7637"]]},{"id":"c6f751b1.69167","type":"api-call-service","z":"81d9975e.584f98","name":"Light Off","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"light.mes","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1190,"y":400,"wires":[[]]},{"id":"ac36ceda.a7637","type":"api-current-state","z":"81d9975e.584f98","name":"After Bedtime","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.bedtime","state_type":"habool","state_location":"","override_payload":"none","entity_location":"","override_data":"none","blockInputOverrides":false,"x":1220,"y":480,"wires":[["99473bb7.50a508"],["1c29f463.85028c"]]},{"id":"99473bb7.50a508","type":"function","z":"81d9975e.584f98","name":"Dim","func":"msg.payload = \n{\n    data:\n    {\n        \"brightness\":20,\n        \"color_temp\":333\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":1430,"y":440,"wires":[["b43e4f02.eb039"]]},{"id":"b43e4f02.eb039","type":"api-call-service","z":"81d9975e.584f98","name":"Light On","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_on","entityId":"light.mes","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1600,"y":480,"wires":[[]]},{"id":"1c29f463.85028c","type":"function","z":"81d9975e.584f98","name":"Bright","func":"msg.payload = \n{\n    data:\n    {\n        \"brightness\":255,\n        \"color_temp\":200\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":1430,"y":520,"wires":[["b43e4f02.eb039"]]},{"id":"56cec2d4.56edfc","type":"server-state-changed","z":"81d9975e.584f98","name":"MES Light","server":"7d575fd3.be153","version":1,"entityidfilter":"light.mes","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":160,"y":160,"wires":[["861ac36d.9e22e","444dffde.77514"],["a8804900.221418","b512568f.0c0e38"]]},{"id":"861ac36d.9e22e","type":"stoptimer","z":"81d9975e.584f98","duration":"150","units":"Second","payloadtype":"num","payloadval":"0","name":"","x":450,"y":60,"wires":[["ebae9abe.517ec8"],[]]},{"id":"32aa9536.b7091a","type":"api-call-service","z":"81d9975e.584f98","name":"Extractor On","server":"7d575fd3.be153","version":1,"service_domain":"switch","service":"turn_on","entityId":"switch.sonoff_extractor","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":850,"y":60,"wires":[[]]},{"id":"ebae9abe.517ec8","type":"api-current-state","z":"81d9975e.584f98","name":"Light On?","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"light.mes","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":640,"y":60,"wires":[["32aa9536.b7091a"],[]]},{"id":"a8804900.221418","type":"stoptimer","z":"81d9975e.584f98","duration":"3","units":"Minute","payloadtype":"num","payloadval":"0","name":"","x":440,"y":260,"wires":[["9073ec08.dfc67"],[]]},{"id":"9073ec08.dfc67","type":"api-call-service","z":"81d9975e.584f98","name":"Extractor Off","server":"7d575fd3.be153","version":1,"service_domain":"switch","service":"turn_off","entityId":"switch.sonoff_extractor","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":650,"y":260,"wires":[[]]},{"id":"b512568f.0c0e38","type":"function","z":"81d9975e.584f98","name":"Stop","func":"msg.payload = \"STOP\"\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":140,"wires":[["861ac36d.9e22e"]]},{"id":"444dffde.77514","type":"function","z":"81d9975e.584f98","name":"Stop","func":"msg.payload = \"STOP\"\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":180,"wires":[["a8804900.221418"]]},{"id":"ee515653.7bb448","type":"subflow:81d9975e.584f98","z":"62f232c2.0dd08c","name":"","env":[],"x":650,"y":420,"wires":[]},{"id":"3597b497.0ed8fc","type":"comment","z":"81d9975e.584f98","name":"Double Click","info":"State 0:\nLight Off Extractor Off\nAction - Both on\n\nState 1:\nLight Off Extractor On\nAction - Both off\n\nState 2:\nLight On Extractor Off\nAction - Both on\n\nState 3:\nLight On Extractor On\nAction - Both off","x":1030,"y":620,"wires":[]},{"id":"60108002.8a7e4","type":"api-current-state","z":"81d9975e.584f98","name":"Extractor On?","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"switch.sonoff_extractor","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1040,"y":660,"wires":[["8253368b.5fc958","296317f9.c2a588"],["4a4037f0.1af008","88a41310.4cc51"]]},{"id":"8253368b.5fc958","type":"api-call-service","z":"81d9975e.584f98","name":"Light Off","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"light.mes","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1260,"y":580,"wires":[[]]},{"id":"296317f9.c2a588","type":"api-call-service","z":"81d9975e.584f98","name":"Extractor Off","server":"7d575fd3.be153","version":1,"service_domain":"switch","service":"turn_off","entityId":"switch.sonoff_extractor","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1270,"y":620,"wires":[[]]},{"id":"4a4037f0.1af008","type":"api-current-state","z":"81d9975e.584f98","name":"After Bedtime","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.bedtime","state_type":"habool","state_location":"","override_payload":"none","entity_location":"","override_data":"none","blockInputOverrides":false,"x":1280,"y":680,"wires":[["c68bd92c.c79b58"],["53ebeb08.b21744"]]},{"id":"c68bd92c.c79b58","type":"function","z":"81d9975e.584f98","name":"Dim","func":"msg.payload = \n{\n    data:\n    {\n        \"brightness\":20,\n        \"color_temp\":333\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":1490,"y":640,"wires":[["5ca54b22.c636c4"]]},{"id":"5ca54b22.c636c4","type":"api-call-service","z":"81d9975e.584f98","name":"Light On","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_on","entityId":"light.mes","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1660,"y":680,"wires":[[]]},{"id":"53ebeb08.b21744","type":"function","z":"81d9975e.584f98","name":"Bright","func":"msg.payload = \n{\n    data:\n    {\n        \"brightness\":255,\n        \"color_temp\":200\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":1490,"y":720,"wires":[["5ca54b22.c636c4"]]},{"id":"88a41310.4cc51","type":"api-call-service","z":"81d9975e.584f98","name":"Extractor On","server":"7d575fd3.be153","version":1,"service_domain":"switch","service":"turn_on","entityId":"switch.sonoff_extractor","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1270,"y":720,"wires":[[]]},{"id":"f5908ade.54dc78","type":"comment","z":"81d9975e.584f98","name":"Long Click","info":"","x":700,"y":740,"wires":[]},{"id":"51d13bad.2e4d14","type":"stoptimer","z":"81d9975e.584f98","duration":"2","units":"Minute","payloadtype":"num","payloadval":"0","name":"","x":700,"y":780,"wires":[["19d4c63a.ced0da"],[]]},{"id":"19d4c63a.ced0da","type":"api-call-service","z":"81d9975e.584f98","name":"Light Off","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"light.mes","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":940,"y":780,"wires":[[]]},{"id":"30ac7365.37ee4c","type":"api-current-state","z":"62f232c2.0dd08c","name":"Sun Down","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"above_horizon","halt_if_type":"str","halt_if_compare":"is_not","override_topic":false,"entity_id":"sun.sun","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1390,"y":720,"wires":[["e23b1f5e.78b27","30b14c5c.eabb14"],["e5b48f60.58d56"]]},{"id":"e5b48f60.58d56","type":"api-call-service","z":"62f232c2.0dd08c","name":"Entrance Light Off","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"light.entrance","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1610,"y":780,"wires":[[]]},{"id":"e23b1f5e.78b27","type":"stoptimer","z":"62f232c2.0dd08c","duration":"15","units":"Minute","payloadtype":"num","payloadval":"0","name":"","x":1580,"y":720,"wires":[["1b488cc2.349313"],[]]},{"id":"1b488cc2.349313","type":"api-call-service","z":"62f232c2.0dd08c","name":"Entrance Light Off","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"light.entrance","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1790,"y":720,"wires":[[]]},{"id":"c71179cb.80bf68","type":"server-state-changed","z":"62f232c2.0dd08c","name":"Come Home","server":"7d575fd3.be153","version":1,"entityidfilter":"device_tracker.mi9tpro_miphone","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"home","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":1130,"y":640,"wires":[["30ac7365.37ee4c"],[]]},{"id":"219f16bd.25cbca","type":"api-call-service","z":"4a06737d.008a7c","name":"Bedroom","server":"7d575fd3.be153","version":1,"service_domain":"climate","service":"turn_off","entityId":"climate.bedroom_ac","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":780,"y":260,"wires":[[]]},{"id":"d56d58e6.cb90c8","type":"api-call-service","z":"4a06737d.008a7c","name":"Lounge","server":"7d575fd3.be153","version":1,"service_domain":"climate","service":"turn_off","entityId":"climate.lounge_ac","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":780,"y":300,"wires":[[]]},{"id":"5d5860c4.f0506","type":"api-call-service","z":"4a06737d.008a7c","name":"Study","server":"7d575fd3.be153","version":1,"service_domain":"climate","service":"turn_off","entityId":"climate.study_ac","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":770,"y":340,"wires":[[]]},{"id":"cff4a041.4964","type":"change","z":"4a06737d.008a7c","name":"Del payload","rules":[{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":590,"y":300,"wires":[["219f16bd.25cbca","d56d58e6.cb90c8","5d5860c4.f0506"]]},{"id":"23c17bb2.43d894","type":"api-call-service","z":"62f232c2.0dd08c","name":"Inside Lights","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"group.inside_lights","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":730,"y":720,"wires":[["30ac7365.37ee4c"]]},{"id":"2e80644e.db870c","type":"subflow:4a06737d.008a7c","z":"62f232c2.0dd08c","name":"","x":720,"y":780,"wires":[]},{"id":"ae9b0c69.199fe","type":"change","z":"81d9975e.584f98","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":830,"y":440,"wires":[["eb4ca30a.d8017"]]},{"id":"fd7516e6.d64e58","type":"change","z":"81d9975e.584f98","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":830,"y":660,"wires":[["60108002.8a7e4"]]},{"id":"177db4a8.2abf4b","type":"switch","z":"62f232c2.0dd08c","name":"Message","property":"payload.click","propertyType":"msg","rules":[{"t":"eq","v":"single","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1280,"y":100,"wires":[["9b339980.ae4a38"]]},{"id":"d4d06d0d.9f08","type":"json","z":"62f232c2.0dd08c","name":"","property":"payload","action":"","pretty":false,"x":1130,"y":100,"wires":[["177db4a8.2abf4b"]]},{"id":"53c81521.7792bc","type":"mqtt in","z":"62f232c2.0dd08c","name":"Study Button","topic":"zigbee2mqtt/0x00158d000183a788","qos":"2","datatype":"auto","broker":"2eafe4c0.b7da5c","x":950,"y":100,"wires":[["d4d06d0d.9f08"]]},{"id":"9b339980.ae4a38","type":"api-call-service","z":"62f232c2.0dd08c","name":"Toggle Study","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"toggle","entityId":"light.office","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1470,"y":100,"wires":[[]]},{"id":"4548fc61.c16f84","type":"switch","z":"62f232c2.0dd08c","name":"Message","property":"payload.click","propertyType":"msg","rules":[{"t":"eq","v":"single","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1280,"y":160,"wires":[["a1d64bcd.5a5a58"]]},{"id":"6ae135a6.3c675c","type":"json","z":"62f232c2.0dd08c","name":"","property":"payload","action":"","pretty":false,"x":1130,"y":160,"wires":[["4548fc61.c16f84"]]},{"id":"2904420e.3233be","type":"mqtt in","z":"62f232c2.0dd08c","name":"Lab Button","topic":"zigbee2mqtt/0x00158d000183aead","qos":"2","datatype":"auto","broker":"2eafe4c0.b7da5c","x":940,"y":160,"wires":[["6ae135a6.3c675c"]]},{"id":"a1d64bcd.5a5a58","type":"api-call-service","z":"62f232c2.0dd08c","name":"Toggle Lab","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"toggle","entityId":"light.lab","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1470,"y":160,"wires":[[]]},{"id":"360719a8.d15aa6","type":"mqtt in","z":"86a3c02f.3051a","name":"Bedside","topic":"zigbee2mqtt/0x00158d0001f41dcb","qos":"2","datatype":"auto","broker":"2eafe4c0.b7da5c","x":200,"y":1140,"wires":[["38bb577e.b05638"]]},{"id":"5f9674b.18a118c","type":"switch","z":"86a3c02f.3051a","name":"Message","property":"payload.click","propertyType":"msg","rules":[{"t":"eq","v":"single","vt":"str"},{"t":"eq","v":"long","vt":"str"},{"t":"eq","v":"double","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":340,"y":1240,"wires":[["f6c80296.f4169"],["bd6bd6b4.21ebb8"],["124c0dae.d8e8a2"]]},{"id":"38bb577e.b05638","type":"json","z":"86a3c02f.3051a","name":"","property":"payload","action":"","pretty":false,"x":190,"y":1240,"wires":[["5f9674b.18a118c"]]},{"id":"f6c80296.f4169","type":"link out","z":"86a3c02f.3051a","name":"Bedside Single Click","links":["9e7d566f.c0eeb8","80d3f246.1704d"],"x":495,"y":1200,"wires":[]},{"id":"124c0dae.d8e8a2","type":"link out","z":"86a3c02f.3051a","name":"Bedside Double Click","links":["6adf3725.b2d148"],"x":495,"y":1280,"wires":[]},{"id":"bd6bd6b4.21ebb8","type":"link out","z":"86a3c02f.3051a","name":"Bedside Long Click","links":["c60a710d.89a63","6dee1e13.58fe4"],"x":495,"y":1240,"wires":[]},{"id":"5b437d34.cd4e64","type":"mqtt in","z":"86a3c02f.3051a","name":"Bedroom Wall","topic":"zigbee2mqtt/0x00158d00017101b2","qos":"2","datatype":"auto","broker":"2eafe4c0.b7da5c","x":330,"y":1580,"wires":[["eedcdb6b.2469b8","9c5c2859.2d3568"]]},{"id":"9b0ecc00.91bb7","type":"switch","z":"86a3c02f.3051a","name":"Message","property":"payload.click","propertyType":"msg","rules":[{"t":"eq","v":"single","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":700,"y":1580,"wires":[["5b454d26.040844"]]},{"id":"eedcdb6b.2469b8","type":"json","z":"86a3c02f.3051a","name":"","property":"payload","action":"","pretty":false,"x":510,"y":1580,"wires":[["9b0ecc00.91bb7"]]},{"id":"9c5c2859.2d3568","type":"debug","z":"86a3c02f.3051a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":530,"y":1700,"wires":[]},{"id":"d222ee80.c4c89","type":"mqtt in","z":"62f232c2.0dd08c","name":"Entrance","topic":"zigbee2mqtt/0x00158d0002139069","qos":"2","datatype":"auto","broker":"2eafe4c0.b7da5c","x":200,"y":840,"wires":[["2e970b7f.2d1b84"]]},{"id":"4398747e.fec52c","type":"switch","z":"62f232c2.0dd08c","name":"Message","property":"payload.click","propertyType":"msg","rules":[{"t":"eq","v":"single","vt":"str"},{"t":"eq","v":"double","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":500,"y":840,"wires":[["23c17bb2.43d894","2e80644e.db870c","e51bf764.54a428","e2d1f061.2c3d7"],["8b4677ab.406cf8","4015f510.e1850c"]]},{"id":"2e970b7f.2d1b84","type":"json","z":"62f232c2.0dd08c","name":"","property":"payload","action":"","pretty":false,"x":350,"y":840,"wires":[["4398747e.fec52c"]]},{"id":"9d9e89db.f1ba78","type":"mqtt in","z":"3788fae5.b038d6","name":"Button 2","topic":"zigbee2mqtt/0x00158d0001f4183f","qos":"2","datatype":"auto","broker":"2eafe4c0.b7da5c","x":244,"y":1464,"wires":[["18c5f63f.32e9ea"]]},{"id":"9a7eabc4.79b9e8","type":"switch","z":"3788fae5.b038d6","name":"Message","property":"payload.click","propertyType":"msg","rules":[{"t":"eq","v":"single","vt":"str"},{"t":"eq","v":"long","vt":"str"},{"t":"eq","v":"double","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":544,"y":1464,"wires":[["62952589.3e1e6c","b852bbe9.eef808"],["e17b482c.30ea08"],["3b9215e4.fd290a"]]},{"id":"18c5f63f.32e9ea","type":"json","z":"3788fae5.b038d6","name":"","property":"payload","action":"","pretty":false,"x":394,"y":1464,"wires":[["9a7eabc4.79b9e8"]]},{"id":"9d4f9b1e.bb0308","type":"function","z":"3788fae5.b038d6","name":"Parse","func":"var brightness = msg.payload\n\nmsg.payload = \n{\n    data:\n    {\n        \"brightness\":brightness,\n        \"color_temp\": \"2500\"\n    }\n};\n\nif (brightness == \"0\")\n    msg.topic = \"reset\"\n    \nreturn msg;","outputs":1,"noerr":0,"x":1114,"y":1444,"wires":[["b8d5d3ef.78ae6"]]},{"id":"b48f5aad.7b4cf8","type":"api-call-service","z":"3788fae5.b038d6","name":"lounge","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_on","entityId":"light.lounge","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1414,"y":1444,"wires":[[]]},{"id":"62952589.3e1e6c","type":"state-machine","z":"3788fae5.b038d6","name":"","triggerProperty":"payload.click","triggerPropertyType":"msg","stateProperty":"payload","statePropertyType":"msg","outputStateChangeOnly":true,"throwException":false,"states":["0","40","80","255"],"transitions":[{"name":"single","from":"40","to":"255"},{"name":"single","from":"80","to":"40"},{"name":"single","from":"255","to":"80"},{"name":"single","from":"0","to":"255"},{"name":"reset","from":"*","to":"0"}],"x":924,"y":1444,"wires":[["9d4f9b1e.bb0308"]]},{"id":"b8d5d3ef.78ae6","type":"switch","z":"3788fae5.b038d6","name":"","property":"topic","propertyType":"msg","rules":[{"t":"neq","v":"reset","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1274,"y":1444,"wires":[["b48f5aad.7b4cf8"]]},{"id":"b852bbe9.eef808","type":"stoptimer","z":"3788fae5.b038d6","duration":"15","units":"Minute","payloadtype":"num","payloadval":"0","name":"","x":724,"y":1304,"wires":[["20926755.0d5338"],[]]},{"id":"20926755.0d5338","type":"change","z":"3788fae5.b038d6","name":"Reset","rules":[{"t":"set","p":"payload.click","pt":"msg","to":"reset","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":734,"y":1384,"wires":[["62952589.3e1e6c"]]},{"id":"bd07ea84.78f3c8","type":"api-call-service","z":"8ed72877.93bc38","name":"Kitchen Off","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"light.kitchen","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":650,"y":120,"wires":[[]]},{"id":"d9334fa0.38208","type":"api-call-service","z":"8ed72877.93bc38","name":"Entrance Off","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"light.entrance","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":650,"y":160,"wires":[[]]},{"id":"275772ae.eaabde","type":"api-call-service","z":"8ed72877.93bc38","name":"Passsage Off","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"light.passage","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":660,"y":200,"wires":[[]]},{"id":"52d7095a.13bfc8","type":"api-call-service","z":"8ed72877.93bc38","name":"Lab Off","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"light.lab","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":640,"y":240,"wires":[[]]},{"id":"22807ad5.545076","type":"function","z":"8ed72877.93bc38","name":"Dim","func":"msg.payload = \n{\n    data:\n    {\n        \"brightness\":20,\n        \"color_temp\":333\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":770,"y":280,"wires":[["57fb48a3.ed0348"]]},{"id":"57fb48a3.ed0348","type":"api-call-service","z":"8ed72877.93bc38","name":"Outside","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_on","entityId":"light.back","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":920,"y":280,"wires":[[]]},{"id":"d0accc36.33341","type":"api-current-state","z":"8ed72877.93bc38","name":"Sun","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"below_horizon","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"sun.sun","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":630,"y":280,"wires":[["22807ad5.545076"],["fca2e757.f77478"]]},{"id":"fca2e757.f77478","type":"api-call-service","z":"8ed72877.93bc38","name":"Outside","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"light.back","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":780,"y":320,"wires":[[]]},{"id":"757620d3.73d4","type":"change","z":"8ed72877.93bc38","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":410,"y":200,"wires":[["bd07ea84.78f3c8","d9334fa0.38208","275772ae.eaabde","52d7095a.13bfc8","d0accc36.33341"]]},{"id":"e17b482c.30ea08","type":"subflow:8ed72877.93bc38","z":"3788fae5.b038d6","name":"","x":814,"y":1504,"wires":[]},{"id":"18360cce.e565e3","type":"api-current-state","z":"a436e8cb.527cf8","name":"","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"climate.lounge_ac","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":610,"y":160,"wires":[["48c60189.2b274"],["c6530cf1.a2f1d"]]},{"id":"48c60189.2b274","type":"api-call-service","z":"a436e8cb.527cf8","name":"","server":"7d575fd3.be153","version":1,"service_domain":"climate","service":"turn_on","entityId":"climate.lounge_ac","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":900,"y":140,"wires":[[]]},{"id":"c6530cf1.a2f1d","type":"api-call-service","z":"a436e8cb.527cf8","name":"","server":"7d575fd3.be153","version":1,"service_domain":"climate","service":"turn_off","entityId":"climate.lounge_ac","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":900,"y":200,"wires":[[]]},{"id":"b467c84c.4dc468","type":"change","z":"a436e8cb.527cf8","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":350,"y":160,"wires":[["18360cce.e565e3"]]},{"id":"3b9215e4.fd290a","type":"subflow:a436e8cb.527cf8","z":"3788fae5.b038d6","name":"","env":[],"x":780,"y":1580,"wires":[]},{"id":"df556151.d8c22","type":"api-current-state","z":"54c86189.6415","name":"After Bedtime","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.bedtime","state_type":"habool","state_location":"","override_payload":"none","entity_location":"","override_data":"none","blockInputOverrides":false,"x":640,"y":140,"wires":[["6946092c.681c38"],["5a591dcf.255824"]]},{"id":"6946092c.681c38","type":"function","z":"54c86189.6415","name":"Dim","func":"msg.payload = \n{\n    data:\n    {\n        \"brightness\":20,\n        \"color_temp\":333\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":850,"y":100,"wires":[[]]},{"id":"5a591dcf.255824","type":"function","z":"54c86189.6415","name":"Bright","func":"msg.payload = \n{\n    data:\n    {\n        \"brightness\":255,\n        \"color_temp\":200\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":850,"y":180,"wires":[[]]},{"id":"5dbcd079.75d08","type":"change","z":"54c86189.6415","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":430,"y":140,"wires":[["df556151.d8c22"]]},{"id":"e04f8c99.fa593","type":"mqtt in","z":"62f232c2.0dd08c","name":"PIR","topic":"zigbee2mqtt/0x00158d000222dec9","qos":"2","datatype":"auto","broker":"2eafe4c0.b7da5c","x":190,"y":1080,"wires":[["3695f2a4.970f5e"]]},{"id":"3695f2a4.970f5e","type":"json","z":"62f232c2.0dd08c","name":"","property":"payload","action":"","pretty":false,"x":330,"y":1080,"wires":[["2b7a149c.413ebc"]]},{"id":"2b7a149c.413ebc","type":"switch","z":"62f232c2.0dd08c","name":"Message","property":"payload.occupancy","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":500,"y":1080,"wires":[["8896b27c.0c087","c8ff82ec.c7e07"],["9a6f96a7.0f4878"]]},{"id":"5518df27.0ef46","type":"change","z":"34311fcd.cea24","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":450,"y":240,"wires":[["c139bcd0.3b1bc"]]},{"id":"c139bcd0.3b1bc","type":"api-current-state","z":"34311fcd.cea24","name":"Sun Down","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"above_horizon","halt_if_type":"str","halt_if_compare":"is_not","override_topic":false,"entity_id":"sun.sun","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":690,"y":360,"wires":[["60952339.5f863c"],["a9f78513.321758"]]},{"id":"60952339.5f863c","type":"api-current-state","z":"34311fcd.cea24","name":"After Bedtime","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.bedtime","state_type":"habool","state_location":"","override_payload":"none","entity_location":"","override_data":"none","blockInputOverrides":false,"x":980,"y":340,"wires":[["9a09c277.b010d"],["59476d48.5e9b54"]]},{"id":"9a09c277.b010d","type":"function","z":"34311fcd.cea24","name":"Dim","func":"msg.payload = \n{\n    data:\n    {\n        \"brightness\":20,\n        \"color_temp\":333\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":1190,"y":300,"wires":[[]]},{"id":"59476d48.5e9b54","type":"function","z":"34311fcd.cea24","name":"Bright","func":"msg.payload = \n{\n    data:\n    {\n        \"brightness\":255,\n        \"color_temp\":200\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":1190,"y":380,"wires":[[]]},{"id":"a9f78513.321758","type":"function","z":"34311fcd.cea24","name":"Off","func":"msg.payload = \n{\n    data:\n    {\n        \"brightness\":0,\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":1190,"y":460,"wires":[[]]},{"id":"8896b27c.0c087","type":"subflow:34311fcd.cea24","z":"62f232c2.0dd08c","name":"","x":710,"y":1040,"wires":[["8308a91a.284bd8"],[]]},{"id":"9a6f96a7.0f4878","type":"stoptimer","z":"62f232c2.0dd08c","duration":"1","units":"Minute","payloadtype":"num","payloadval":"0","name":"","x":680,"y":1120,"wires":[["5bb1c918.a79778"],[]]},{"id":"8308a91a.284bd8","type":"api-call-service","z":"62f232c2.0dd08c","name":"Passage Light On","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_on","entityId":"light.passage","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":930,"y":1040,"wires":[[]]},{"id":"5bb1c918.a79778","type":"api-call-service","z":"62f232c2.0dd08c","name":"Passage Light Off","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"light.passage","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":870,"y":1120,"wires":[[]]},{"id":"8b4677ab.406cf8","type":"api-call-service","z":"62f232c2.0dd08c","name":"Toggle Entrance","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"toggle","entityId":"light.entrance","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":740,"y":900,"wires":[[]]},{"id":"4015f510.e1850c","type":"stoptimer","z":"62f232c2.0dd08c","duration":"5","units":"Minute","payloadtype":"num","payloadval":"0","name":"","x":740,"y":860,"wires":[["ecbd4f25.1a057"],[]]},{"id":"ecbd4f25.1a057","type":"api-call-service","z":"62f232c2.0dd08c","name":"Entrance Light Off","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"light.entrance","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":930,"y":860,"wires":[[]]},{"id":"62b69e68.ab764","type":"mqtt in","z":"81d9975e.584f98","name":"Button","topic":"zigbee2mqtt/0x00158d0001e5c0de","qos":"2","datatype":"auto","broker":"2eafe4c0.b7da5c","x":190,"y":540,"wires":[["126fb590.ef2ffa"]]},{"id":"b8d98938.f61bf8","type":"switch","z":"81d9975e.584f98","name":"Message","property":"payload.click","propertyType":"msg","rules":[{"t":"eq","v":"single","vt":"str"},{"t":"eq","v":"double","vt":"str"},{"t":"eq","v":"long","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":520,"y":540,"wires":[["ae9b0c69.199fe"],["fd7516e6.d64e58"],["51d13bad.2e4d14","ae9b0c69.199fe"]]},{"id":"126fb590.ef2ffa","type":"json","z":"81d9975e.584f98","name":"","property":"payload","action":"","pretty":false,"x":350,"y":540,"wires":[["b8d98938.f61bf8"]]},{"id":"30b14c5c.eabb14","type":"api-call-service","z":"62f232c2.0dd08c","name":"Entrance Light On","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_on","entityId":"light.entrance","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1610,"y":660,"wires":[[]]},{"id":"8824ebf4.df7668","type":"function","z":"62f232c2.0dd08c","name":"Opened","func":"msg.topic = \"boss\"\nmsg.payload = \"Back door opened\"\nreturn msg;","outputs":1,"noerr":0,"x":300,"y":1360,"wires":[["a5bbbd59.3562d","543bd5c9.d60d2c"]]},{"id":"16215a4f.2396a6","type":"function","z":"62f232c2.0dd08c","name":"Closed","func":"msg.topic = \"boss\"\nmsg.payload = \"Back door closed\"\nreturn msg;","outputs":1,"noerr":0,"x":300,"y":1280,"wires":[["dcf088e0.722e08","543bd5c9.d60d2c"]]},{"id":"e8b48634.c449f8","type":"function","z":"62f232c2.0dd08c","name":"Opened","func":"msg.topic = \"boss\"\nmsg.payload = \"Front door opened\"\nreturn msg;","outputs":1,"noerr":0,"x":360,"y":1720,"wires":[["21ff3a8b.1ea676"]]},{"id":"5ed83a0.b9856c8","type":"function","z":"62f232c2.0dd08c","name":"Closed","func":"msg.topic = \"boss\"\nmsg.payload = \"Front door closed\"\nreturn msg;","outputs":1,"noerr":0,"x":360,"y":1640,"wires":[["21ff3a8b.1ea676"]]},{"id":"861fdc56.d3f4f","type":"mqtt in","z":"62f232c2.0dd08c","name":"Front Door","topic":"zigbee2mqtt/0x00158d0001f9e18e","qos":"2","datatype":"auto","broker":"2eafe4c0.b7da5c","x":920,"y":800,"wires":[["290c8e22.993552"]]},{"id":"bff26e5b.a0323","type":"switch","z":"62f232c2.0dd08c","name":"Message","property":"payload.contact","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":1220,"y":800,"wires":[[],["30ac7365.37ee4c"]]},{"id":"290c8e22.993552","type":"json","z":"62f232c2.0dd08c","name":"","property":"payload","action":"","pretty":false,"x":1070,"y":800,"wires":[["bff26e5b.a0323"]]},{"id":"d9924072.9bf18","type":"api-current-state","z":"62f232c2.0dd08c","name":"Is it after sunset?","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"above_horizon","halt_if_type":"str","halt_if_compare":"is_not","override_topic":false,"entity_id":"sun.sun","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":390,"y":1820,"wires":[["97695a79.486c98"],["5cd14205.7e73bc"]]},{"id":"5cd14205.7e73bc","type":"api-call-service","z":"62f232c2.0dd08c","name":"Front light off","server":"7d575fd3.be153","version":"1","service_domain":"light","service":"turn_off","entityId":"light.front","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":610,"y":1860,"wires":[[]]},{"id":"718dfbea.2be854","type":"api-current-state","z":"62f232c2.0dd08c","name":"Is it still dark?","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"above_horizon","halt_if_type":"str","halt_if_compare":"is_not","override_topic":false,"entity_id":"sun.sun","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":580,"y":1580,"wires":[["f086f313.1eee3"],["ee682f5e.434f5"]]},{"id":"41e1e53.8143f1c","type":"stoptimer","z":"62f232c2.0dd08c","duration":"5","units":"Minute","payloadtype":"num","payloadval":"0","name":"","x":380,"y":1580,"wires":[["718dfbea.2be854"],[]]},{"id":"456eca62.b4bb54","type":"comment","z":"62f232c2.0dd08c","name":"Front Door and Light","info":"","x":150,"y":1580,"wires":[]},{"id":"ee682f5e.434f5","type":"api-call-service","z":"62f232c2.0dd08c","name":"Front light off","server":"7d575fd3.be153","version":"1","service_domain":"light","service":"turn_off","entityId":"light.front","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":770,"y":1620,"wires":[[]]},{"id":"97695a79.486c98","type":"api-call-service","z":"62f232c2.0dd08c","name":"Front Light 100%","server":"7d575fd3.be153","version":"1","service_domain":"light","service":"turn_on","entityId":"light.front","data":"{\"brightness\":255}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":630,"y":1780,"wires":[[]]},{"id":"f086f313.1eee3","type":"api-call-service","z":"62f232c2.0dd08c","name":"Front Light 30%","server":"7d575fd3.be153","version":"1","service_domain":"light","service":"turn_on","entityId":"light.front","data":"{\"brightness\":80}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":780,"y":1560,"wires":[[]]},{"id":"a5bbbd59.3562d","type":"api-current-state","z":"62f232c2.0dd08c","name":"Is it after sunset?","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"above_horizon","halt_if_type":"str","halt_if_compare":"is_not","override_topic":false,"entity_id":"sun.sun","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":621,"y":1398,"wires":[["ea1ccc18.d23f7"],["47c88411.97dcec"]]},{"id":"ea1ccc18.d23f7","type":"api-call-service","z":"62f232c2.0dd08c","name":"Back to full brightness","server":"7d575fd3.be153","version":"1","service_domain":"light","service":"turn_on","entityId":"light.back","data":"{\"brightness\":255}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":871,"y":1358,"wires":[[]]},{"id":"47c88411.97dcec","type":"api-call-service","z":"62f232c2.0dd08c","name":"Back light off","server":"7d575fd3.be153","version":"1","service_domain":"light","service":"turn_off","entityId":"light.back","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":841,"y":1438,"wires":[[]]},{"id":"aaa6ce0f.3afb2","type":"api-current-state","z":"62f232c2.0dd08c","name":"Is it still dark?","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"above_horizon","halt_if_type":"str","halt_if_compare":"is_not","override_topic":false,"entity_id":"sun.sun","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":708,"y":1244,"wires":[["1f8f87e6.a3e738"],["b358d60d.303208"]]},{"id":"1f8f87e6.a3e738","type":"api-call-service","z":"62f232c2.0dd08c","name":"Back light 30%","server":"7d575fd3.be153","version":"1","service_domain":"light","service":"turn_on","entityId":"light.back","data":"{\"brightness\":80}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":908,"y":1224,"wires":[[]]},{"id":"b358d60d.303208","type":"api-call-service","z":"62f232c2.0dd08c","name":"Back Light off","server":"7d575fd3.be153","version":"1","service_domain":"light","service":"turn_off","entityId":"light.back","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":908,"y":1264,"wires":[[]]},{"id":"dcf088e0.722e08","type":"stoptimer","z":"62f232c2.0dd08c","duration":"15","units":"Minute","payloadtype":"num","payloadval":"0","name":"","x":508,"y":1244,"wires":[["aaa6ce0f.3afb2"],[]]},{"id":"8fb231c0.a4ff6","type":"comment","z":"62f232c2.0dd08c","name":"Back Door and Light","info":"","x":204,"y":1236,"wires":[]},{"id":"6b2c77d3.56ba88","type":"api-current-state","z":"62f232c2.0dd08c","name":"Is back open?","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"binary_sensor.contact_back_door","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1420,"y":1080,"wires":[["344ed565.be6dca"],["282678ef.61c548"]]},{"id":"344ed565.be6dca","type":"api-call-service","z":"62f232c2.0dd08c","name":"Back Light 100%","server":"7d575fd3.be153","version":"1","service_domain":"light","service":"turn_on","entityId":"light.back","data":"{\"brightness\":255}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1630,"y":1060,"wires":[[]]},{"id":"282678ef.61c548","type":"api-call-service","z":"62f232c2.0dd08c","name":"Back Light 30%","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_on","entityId":"light.back","data":"{\"brightness\":80}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1620,"y":1100,"wires":[[]]},{"id":"142daa11.75e596","type":"api-current-state","z":"62f232c2.0dd08c","name":"Is front open?","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"binary_sensor.contact_front_door","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1420,"y":1180,"wires":[["1f8afa47.e2e276"],["98959526.cceba8"]]},{"id":"1f8afa47.e2e276","type":"api-call-service","z":"62f232c2.0dd08c","name":"Front Light 100%","server":"7d575fd3.be153","version":"1","service_domain":"light","service":"turn_on","entityId":"light.front","data":"{\"brightness\":255}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1630,"y":1160,"wires":[[]]},{"id":"98959526.cceba8","type":"api-call-service","z":"62f232c2.0dd08c","name":"Front Light 30%","server":"7d575fd3.be153","version":"1","service_domain":"light","service":"turn_on","entityId":"light.front","data":"{\"brightness\":80}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1620,"y":1200,"wires":[[]]},{"id":"a5aa1a45.c4c2f8","type":"api-call-service","z":"62f232c2.0dd08c","name":"Front light off","server":"7d575fd3.be153","version":"1","service_domain":"light","service":"turn_off","entityId":"light.front","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1390,"y":920,"wires":[[]]},{"id":"d20251de.a97dc","type":"api-call-service","z":"62f232c2.0dd08c","name":"Back Light off","server":"7d575fd3.be153","version":"1","service_domain":"light","service":"turn_off","entityId":"light.back","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1400,"y":980,"wires":[[]]},{"id":"4fda19db.d163b8","type":"server-state-changed","z":"62f232c2.0dd08c","name":"Back Door","server":"7d575fd3.be153","version":1,"entityidfilter":"binary_sensor.contact_back_door","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"off","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":114,"y":1316,"wires":[["16215a4f.2396a6"],["8824ebf4.df7668"]]},{"id":"8e3c9ae9.a7d0b8","type":"server-state-changed","z":"62f232c2.0dd08c","name":"Front Door","server":"7d575fd3.be153","version":1,"entityidfilter":"binary_sensor.contact_front_door","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"off","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":160,"y":1680,"wires":[["41e1e53.8143f1c","5ed83a0.b9856c8"],["e8b48634.c449f8","d9924072.9bf18"]]},{"id":"f09e6d4e.78de2","type":"server-state-changed","z":"62f232c2.0dd08c","name":"Freezer","server":"7d575fd3.be153","version":1,"entityidfilter":"binary_sensor.contact_freezer","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":1150,"y":1320,"wires":[["ee974eb.fb57db"],[]]},{"id":"484c4cf5.4d98b4","type":"function","z":"62f232c2.0dd08c","name":"Freezer","func":"msg.topic = \"boss\"\nmsg.payload = \"Freezer left open\"\nreturn msg;","outputs":1,"noerr":0,"x":1630,"y":1320,"wires":[["1e436d78.92e373"]]},{"id":"ee974eb.fb57db","type":"stoptimer","z":"62f232c2.0dd08c","duration":"1","units":"Minute","payloadtype":"num","payloadval":"0","name":"","x":1310,"y":1320,"wires":[["ed17f40b.d61e08"],[]]},{"id":"ed17f40b.d61e08","type":"api-current-state","z":"62f232c2.0dd08c","name":"Check","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"binary_sensor.contact_freezer","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1480,"y":1320,"wires":[["484c4cf5.4d98b4"],[]]},{"id":"101919ec.aec916","type":"api-call-service","z":"ca5a8b67.211fb8","name":"Study AC","server":"7d575fd3.be153","version":1,"service_domain":"climate","service":"turn_off","entityId":"climate.study_ac","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":500,"y":180,"wires":[[]]},{"id":"c4d56b4d.33ac08","type":"api-call-service","z":"ca5a8b67.211fb8","name":"Lounge AC","server":"7d575fd3.be153","version":1,"service_domain":"climate","service":"turn_off","entityId":"climate.lounge_ac","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":510,"y":220,"wires":[["e9509f01.2a033"]]},{"id":"88a236e4.0d4fb8","type":"api-call-service","z":"ca5a8b67.211fb8","name":"TV","server":"7d575fd3.be153","version":1,"service_domain":"media_player","service":"turn_off","entityId":"media_player.smart_ir_tv","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":490,"y":260,"wires":[[]]},{"id":"b1b10b04.2ce1f8","type":"api-call-service","z":"ca5a8b67.211fb8","name":"Lights","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"group.lights_bedtime","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":490,"y":300,"wires":[[]]},{"id":"6b5f3339.b0213c","type":"subflow:ca5a8b67.211fb8","z":"86a3c02f.3051a","name":"","env":[],"x":1480,"y":1680,"wires":[["14ea7344.24e0ed"]]},{"id":"b911b839.71bbe8","type":"api-current-state","z":"ca5a8b67.211fb8","name":"Back Door","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"binary_sensor.contact_back_door","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":510,"y":380,"wires":[["c22f4207.123ec"],[]]},{"id":"e46c9b84.60b878","type":"api-current-state","z":"ca5a8b67.211fb8","name":"Front Door","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"binary_sensor.contact_front_door","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":510,"y":420,"wires":[["5fece0df.00b57"],[]]},{"id":"c22f4207.123ec","type":"function","z":"ca5a8b67.211fb8","name":"Opened","func":"msg.topic = \"boss\"\nmsg.payload = \"Back door is still open\"\nreturn msg;","outputs":1,"noerr":0,"x":680,"y":380,"wires":[[]]},{"id":"5fece0df.00b57","type":"function","z":"ca5a8b67.211fb8","name":"Opened","func":"msg.topic = \"boss\"\nmsg.payload = \"Front door is still open\"\nreturn msg;","outputs":1,"noerr":0,"x":680,"y":420,"wires":[[]]},{"id":"bf7d2359.f02f6","type":"mqtt in","z":"3788fae5.b038d6","name":"Lounge Switch","topic":"zigbee2mqtt/0x00158d0001f3f4a8","qos":"2","datatype":"auto","broker":"2eafe4c0.b7da5c","x":200,"y":940,"wires":[["2b6c54cf.b2fc2c"]]},{"id":"f37e65ef.de9a88","type":"switch","z":"3788fae5.b038d6","name":"Click Type","property":"payload.click","propertyType":"msg","rules":[{"t":"eq","v":"left","vt":"str"},{"t":"eq","v":"both","vt":"str"},{"t":"eq","v":"right","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":530,"y":940,"wires":[["38fabf61.ef737"],["464f9a68.b88904"],["71220c0b.8b1784"]]},{"id":"2b6c54cf.b2fc2c","type":"json","z":"3788fae5.b038d6","name":"","property":"payload","action":"","pretty":false,"x":370,"y":940,"wires":[["f37e65ef.de9a88"]]},{"id":"464f9a68.b88904","type":"api-call-service","z":"3788fae5.b038d6","name":"Toggle","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"toggle","entityId":"light.lounge","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":710,"y":940,"wires":[[]]},{"id":"e51bf764.54a428","type":"api-call-service","z":"62f232c2.0dd08c","name":"TV","server":"7d575fd3.be153","version":1,"service_domain":"media_player","service":"turn_off","entityId":"media_player.smart_ir_tv","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":710,"y":820,"wires":[[]]},{"id":"42a51188.cc05d","type":"server-state-changed","z":"62f232c2.0dd08c","name":"No-one Home","server":"7d575fd3.be153","version":1,"entityidfilter":"group.everyone","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"home","halt_if_type":"str","halt_if_compare":"is_not","outputs":2,"output_only_on_state_change":true,"x":1090,"y":1520,"wires":[["348b1a7b.8b62a6","bf6d2520.836408"],[]]},{"id":"348b1a7b.8b62a6","type":"api-current-state","z":"62f232c2.0dd08c","name":"Inside Lights","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is_not","override_topic":false,"entity_id":"group.inside_lights","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1280,"y":1480,"wires":[["75618fa4.97d98"],[]]},{"id":"75618fa4.97d98","type":"function","z":"62f232c2.0dd08c","name":"Notice","func":"msg.topic = \"boss\"\nmsg.payload = \"No one home but there are lights on\"\nreturn msg;","outputs":1,"noerr":0,"x":1460,"y":1440,"wires":[["11ad200e.773aa"]]},{"id":"bf6d2520.836408","type":"ha-get-entities","z":"62f232c2.0dd08c","server":"7d575fd3.be153","name":"Aircons","rules":[{"property":"entity_id","logic":"starts_with","value":"climate","valueType":"str"}],"output_type":"array","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":1270,"y":1540,"wires":[["54ef2619.9458a8"]]},{"id":"54ef2619.9458a8","type":"function","z":"62f232c2.0dd08c","name":"Notice","func":"var count = 0\n\nvar message = \"The following aircons are on:\\n\"\n\nfor(i = 0 ; i < msg.payload.length; i++)\n{\n    if(msg.payload[i].state != \"off\")\n    {\n        message += \"\\n\" + msg.payload[i].attributes.friendly_name;\n        count++;\n    }\n}\n\nif(count === 0)\n    return null;\n\nmsg.topic = \"boss\"\nmsg.payload = message\nreturn msg;","outputs":1,"noerr":0,"x":1460,"y":1540,"wires":[["11ad200e.773aa"]]},{"id":"11c67e09.3ec552","type":"function","z":"62f232c2.0dd08c","name":"Notice","func":"msg.topic = \"boss\"\nmsg.payload = \"Home Assistant booted\"\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":700,"wires":[["f8882e97.4f3ab"]]},{"id":"b211aafc.28b0d8","type":"stoptimer","z":"62f232c2.0dd08c","duration":"30","units":"Second","payloadtype":"num","payloadval":"0","name":"","x":550,"y":500,"wires":[[],[]]},{"id":"e5db0d64.7af64","type":"server-state-changed","z":"62f232c2.0dd08c","name":"Booted","server":"7d575fd3.be153","version":1,"entityidfilter":"input_boolean.booted","entityidfiltertype":"exact","outputinitially":false,"state_type":"habool","haltifstate":"true","halt_if_type":"bool","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":110,"y":700,"wires":[[],[]]},{"id":"f3a92c00.1afde","type":"mqtt in","z":"62f232c2.0dd08c","name":"Kitchen Click","topic":"zigbee2mqtt/0x00158d000183ad5c","qos":"2","datatype":"auto","broker":"2eafe4c0.b7da5c","x":130,"y":1960,"wires":[["1cd2b1c7.3c7bee"]]},{"id":"c574569.601b8a8","type":"switch","z":"62f232c2.0dd08c","name":"Message","property":"payload.click","propertyType":"msg","rules":[{"t":"eq","v":"single","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":460,"y":1960,"wires":[["30fc886a.f5ee08"]]},{"id":"1cd2b1c7.3c7bee","type":"json","z":"62f232c2.0dd08c","name":"","property":"payload","action":"","pretty":false,"x":310,"y":1960,"wires":[["c574569.601b8a8"]]},{"id":"30fc886a.f5ee08","type":"api-call-service","z":"62f232c2.0dd08c","name":"Toggle","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"toggle","entityId":"light.kitchen","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":610,"y":1960,"wires":[[]]},{"id":"8f5c3a46.14b858","type":"ha-get-entities","z":"62f232c2.0dd08c","server":"7d575fd3.be153","name":"Batteries","rules":[{"property":"entity_id","logic":"starts_with","value":"sensor.battery","valueType":"str"}],"output_type":"array","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":280,"y":80,"wires":[["752f536f.1bb71c"]]},{"id":"752f536f.1bb71c","type":"function","z":"62f232c2.0dd08c","name":"Notice","func":"var count = 0\n\nvar message = \"Batteries:\\n\"\n\nfor(i = 0 ; i < msg.payload.length; i++)\n{\n    if(msg.payload[i].state < 90)\n    {\n        message += \"\\n\" + msg.payload[i].attributes.friendly_name;\n        message += \": \" + msg.payload[i].state + \"%\";\n        count++;\n    }\n}\n\nif(count === 0)\n    return null;\n\nmsg.topic = \"boss\"\nmsg.payload = message\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":80,"wires":[["d37eeef6.6df4"]]},{"id":"8d9a243a.78f098","type":"server-state-changed","z":"62f232c2.0dd08c","name":"Sunset","server":"7d575fd3.be153","version":1,"entityidfilter":"sun.sun","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"above_horizon","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":1210,"y":960,"wires":[["a5aa1a45.c4c2f8","d20251de.a97dc"],["6b2c77d3.56ba88","142daa11.75e596"]]},{"id":"8c5ee2e5.c1a16","type":"server-state-changed","z":"62f232c2.0dd08c","name":"Bathroom Door","server":"7d575fd3.be153","version":1,"entityidfilter":"binary_sensor.contact_bathroom","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":1340,"y":500,"wires":[["8d5a2aab.f58118"],["2f188be6.45fec4"]]},{"id":"bf7cd77d.d08268","type":"mqtt in","z":"62f232c2.0dd08c","name":"Bathroom Button","topic":"zigbee2mqtt/0x00158d0001710295","qos":"2","datatype":"auto","broker":"2eafe4c0.b7da5c","x":840,"y":340,"wires":[["31acf8c6.8b73d8"]]},{"id":"ec0e9651.c49e68","type":"switch","z":"62f232c2.0dd08c","name":"Message","property":"payload.click","propertyType":"msg","rules":[{"t":"eq","v":"single","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1160,"y":340,"wires":[["1b81985.3fa5a68"]]},{"id":"31acf8c6.8b73d8","type":"json","z":"62f232c2.0dd08c","name":"","property":"payload","action":"","pretty":false,"x":1010,"y":340,"wires":[["ec0e9651.c49e68"]]},{"id":"2f188be6.45fec4","type":"time-range-switch","z":"62f232c2.0dd08c","name":"Quiet Hours","lat":"-29.81079","lon":"30.93025","startTime":"21:00","endTime":"dawn","startOffset":0,"endOffset":0,"x":1610,"y":380,"wires":[["5dadaa86.d60034"],["77aeed3c.f262b4"]]},{"id":"5dadaa86.d60034","type":"function","z":"62f232c2.0dd08c","name":"Soft","func":"msg.payload = \n{\n    data:\n    {\n        \"brightness\":40,\n        \"color_temp\": \"2700\"\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":1770,"y":340,"wires":[["b4363b8d.521108"]]},{"id":"b4363b8d.521108","type":"api-call-service","z":"62f232c2.0dd08c","name":"Bathroom","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_on","entityId":"light.bathroom","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1940,"y":380,"wires":[[]]},{"id":"77aeed3c.f262b4","type":"function","z":"62f232c2.0dd08c","name":"Bright","func":"msg.payload = \n{\n    data:\n    {\n        \"brightness\":255,\n        \"color_temp\": 288\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":1770,"y":420,"wires":[["b4363b8d.521108"]]},{"id":"1b81985.3fa5a68","type":"api-current-state","z":"62f232c2.0dd08c","name":"Bathroom","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"light.bathroom","state_type":"str","state_location":"","override_payload":"none","entity_location":"","override_data":"none","blockInputOverrides":false,"x":1320,"y":340,"wires":[["4a0f0678.e98488"],["2f188be6.45fec4"]]},{"id":"4a0f0678.e98488","type":"api-call-service","z":"62f232c2.0dd08c","name":"Bathroom","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"light.bathroom","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1600,"y":300,"wires":[[]]},{"id":"d8a70c89.a3675","type":"server-state-changed","z":"3788fae5.b038d6","name":"Come Home","server":"7d575fd3.be153","version":1,"entityidfilter":"device_tracker.mi9tpro_miphone","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"home","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":550,"y":100,"wires":[["2930bd67.478ca2"],[]]},{"id":"2930bd67.478ca2","type":"api-current-state","z":"3788fae5.b038d6","name":"Is it hot?","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"24","halt_if_type":"num","halt_if_compare":"gte","override_topic":false,"entity_id":"sensor.temperature_lounge","state_type":"num","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":720,"y":100,"wires":[["fe2e314f.b36b7"],[]]},{"id":"a5194ca9.77f1b","type":"api-call-service","z":"3788fae5.b038d6","name":"Turn on AC","server":"7d575fd3.be153","version":1,"service_domain":"climate","service":"turn_on","entityId":"climate.lounge_ac","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1050,"y":100,"wires":[["4136d2ff.36477c"]]},{"id":"4732c6a9.d69ad8","type":"server-state-changed","z":"3788fae5.b038d6","name":"Back Door","server":"7d575fd3.be153","version":1,"entityidfilter":"binary_sensor.contact_back_door","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"off","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":700,"y":260,"wires":[["32b9728e.406cee","78806e1a.9f417"],["32b9728e.406cee"]]},{"id":"32b9728e.406cee","type":"stoptimer","z":"3788fae5.b038d6","duration":"1","units":"Minute","payloadtype":"num","payloadval":"0","name":"","x":880,"y":260,"wires":[["3900a2e7.3a363e"],[]]},{"id":"78806e1a.9f417","type":"function","z":"3788fae5.b038d6","name":"Previous State","func":"var ac =  flow.get(\"ac_state\");\nflow.set(\"ac_state\", false);\n\nif(true === ac)\n    return [msg, null]\nelse\n    return [null, msg]","outputs":2,"noerr":0,"x":900,"y":200,"wires":[["fecbcf7e.977ac"],[]]},{"id":"3900a2e7.3a363e","type":"api-current-state","z":"3788fae5.b038d6","name":"Still Open","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"binary_sensor.contact_back_door","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1060,"y":260,"wires":[["54e99f26.f0392"],[]]},{"id":"fecbcf7e.977ac","type":"api-call-service","z":"3788fae5.b038d6","name":"Turn on AC","server":"7d575fd3.be153","version":1,"service_domain":"climate","service":"turn_on","entityId":"climate.lounge_ac","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1090,"y":200,"wires":[[]]},{"id":"54e99f26.f0392","type":"api-current-state","z":"3788fae5.b038d6","name":"AC State","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is_not","override_topic":false,"entity_id":"climate.lounge_ac","state_type":"str","state_location":"","override_payload":"none","entity_location":"","override_data":"none","blockInputOverrides":false,"x":1220,"y":260,"wires":[["7f6e93ab.19bf4c"],["6178d896.9e0aa8"]]},{"id":"7f6e93ab.19bf4c","type":"function","z":"3788fae5.b038d6","name":"Save State ON","func":"flow.set(\"ac_state\", true);\nreturn msg;","outputs":1,"noerr":0,"x":1420,"y":240,"wires":[["9b96030b.64f84"]]},{"id":"6178d896.9e0aa8","type":"function","z":"3788fae5.b038d6","name":"Save State OFF","func":"flow.set(\"ac_state\", false);\nreturn msg;","outputs":1,"noerr":0,"x":1420,"y":280,"wires":[[]]},{"id":"9b96030b.64f84","type":"api-call-service","z":"3788fae5.b038d6","name":"Turn off AC","server":"7d575fd3.be153","version":1,"service_domain":"climate","service":"turn_off","entityId":"climate.lounge_ac","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1610,"y":240,"wires":[[]]},{"id":"1e21be76.0fb3d2","type":"inject","z":"86a3c02f.3051a","name":"","repeat":"","crontab":"30 21 * * *","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":130,"y":1940,"wires":[["e0c82f7a.cbcf2"]]},{"id":"4e000c83.7f4064","type":"api-current-state","z":"86a3c02f.3051a","name":">21C","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"21","halt_if_type":"num","halt_if_compare":"gte","override_topic":false,"entity_id":"sensor.temperature_bedroom","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":630,"y":1940,"wires":[["c0cacb9.4e5fe38"],[]]},{"id":"c0cacb9.4e5fe38","type":"api-call-service","z":"86a3c02f.3051a","name":"Turn on Bedroom AC","server":"7d575fd3.be153","version":1,"service_domain":"climate","service":"turn_on","entityId":"climate.bedroom_ac","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":820,"y":1940,"wires":[[]]},{"id":"d435cd2c.9e625","type":"inject","z":"86a3c02f.3051a","name":"","repeat":"","crontab":"00 01 * * *","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":130,"y":2040,"wires":[["4fec6130.5aecc"]]},{"id":"4fec6130.5aecc","type":"api-current-state","z":"86a3c02f.3051a","name":"<20C","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"19","halt_if_type":"num","halt_if_compare":"lt","override_topic":false,"entity_id":"sensor.temperature_bedroom","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":290,"y":2040,"wires":[["ade9b26c.b2bd7"],[]]},{"id":"ade9b26c.b2bd7","type":"api-call-service","z":"86a3c02f.3051a","name":"Turn off Bedroom AC","server":"7d575fd3.be153","version":1,"service_domain":"climate","service":"turn_off","entityId":"climate.bedroom_ac","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":480,"y":2040,"wires":[[]]},{"id":"ee9a7968.74c658","type":"chatbot-telegram-receive","z":"fa310ecb.c84eb","bot":"29745a73.469c46","botProduction":"29745a73.469c46","x":200,"y":220,"wires":[["a4baf35b.cb07a"]]},{"id":"ace7abb5.a5a548","type":"debug","z":"fa310ecb.c84eb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":650,"y":180,"wires":[]},{"id":"a4baf35b.cb07a","type":"chatbot-authorized","z":"fa310ecb.c84eb","x":420,"y":220,"wires":[["ace7abb5.a5a548","6f2e336e.b1294c"],["76308b39.f4e334"]],"info":"532693134"},{"id":"76308b39.f4e334","type":"debug","z":"fa310ecb.c84eb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":650,"y":260,"wires":[]},{"id":"6f2e336e.b1294c","type":"chatbot-inline-buttons","z":"fa310ecb.c84eb","name":"","buttons":[{"type":"postback","label":"Yes","value":"true","answer":"YES!","alert":false,"style":"default"},{"type":"postback","label":"No","value":"false","answer":"No?","alert":true,"style":"danger"}],"message":"Pick","x":640,"y":140,"wires":[[]]},{"id":"820099a2.b4b0a8","type":"chatbot-telegram-send","z":"fa310ecb.c84eb","bot":"29745a73.469c46","botProduction":"29745a73.469c46","track":true,"passThrough":false,"outputs":1,"x":890,"y":140,"wires":[[]]},{"id":"9e30e220.211ce","type":"inject","z":"62f232c2.0dd08c","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":140,"y":640,"wires":[["11c67e09.3ec552"]]},{"id":"e5039bb6.86f6d8","type":"link out","z":"5e97ea24.516424","name":"","links":["bde211f0.94d9c"],"x":755,"y":460,"wires":[]},{"id":"3a7c0926.309d16","type":"link out","z":"5e97ea24.516424","name":"","links":["bde211f0.94d9c"],"x":975,"y":640,"wires":[]},{"id":"364ce5d8.8351ca","type":"chatbot-telegram-send","z":"796da880.c06928","bot":"a74dbc46.5290a","botProduction":"a74dbc46.5290a","track":true,"passThrough":false,"outputs":1,"x":630,"y":60,"wires":[[]]},{"id":"6b471316.92639c","type":"chatbot-conversation","z":"796da880.c06928","name":"Home","botTelegram":"a74dbc46.5290a","botTelegramProduction":"a74dbc46.5290a","botSlack":"","botSlackProduction":"","botFacebook":"","botFacebookProduction":"","botViber":"","botViberProduction":"","botUniversal":"","botUniversalProduction":"","botTwilio":"","botTwilioProduction":"","botDiscord":"","botDiscordProduction":"","chatId":"-257391012","transport":"telegram","messageId":"","contextMessageId":false,"store":"","x":290,"y":60,"wires":[["ef03b764.21dab8"]]},{"id":"ef03b764.21dab8","type":"chatbot-message","z":"796da880.c06928","name":"Text","message":[],"answer":false,"silent":false,"x":450,"y":60,"wires":[["364ce5d8.8351ca"]]},{"id":"57797689.55f7e8","type":"link in","z":"796da880.c06928","name":"Message Home","links":["543bd5c9.d60d2c","f8882e97.4f3ab","21ff3a8b.1ea676","1a04512e.a436ff","16b47f9.1d2b48","11ad200e.773aa","1e436d78.92e373","d37eeef6.6df4","14ea7344.24e0ed","62f59b1d.7c9e04","428c547c.274afc","2af8a48.5976f5c","91c5ac20.3ed99"],"x":175,"y":60,"wires":[["6b471316.92639c"]]},{"id":"8cf6d107.6952b","type":"chatbot-telegram-send","z":"796da880.c06928","bot":"c098a993.7d4cd8","botProduction":"c098a993.7d4cd8","track":true,"passThrough":false,"outputs":1,"x":630,"y":100,"wires":[[]]},{"id":"d6e1cf35.1ea2d","type":"chatbot-conversation","z":"796da880.c06928","name":"Battery","botTelegram":"c098a993.7d4cd8","botTelegramProduction":"c098a993.7d4cd8","botSlack":"","botSlackProduction":"","botFacebook":"","botFacebookProduction":"","botViber":"","botViberProduction":"","botUniversal":"","botUniversalProduction":"","botTwilio":"","botTwilioProduction":"","botDiscord":"","botDiscordProduction":"","chatId":"-257391012","transport":"telegram","messageId":"","contextMessageId":false,"store":"","x":300,"y":100,"wires":[["e30b2f72.552dc"]]},{"id":"e30b2f72.552dc","type":"chatbot-message","z":"796da880.c06928","name":"Text","message":[],"answer":false,"silent":false,"x":450,"y":100,"wires":[["8cf6d107.6952b"]]},{"id":"e83933ef.2b28a","type":"link in","z":"796da880.c06928","name":"Message Battery","links":[],"x":175,"y":100,"wires":[["d6e1cf35.1ea2d"]]},{"id":"2b8a77db.d82c28","type":"chatbot-telegram-send","z":"796da880.c06928","bot":"19612d6f.770c43","botProduction":"19612d6f.770c43","track":true,"passThrough":false,"outputs":1,"x":630,"y":140,"wires":[[]]},{"id":"7537ec2b.65c064","type":"chatbot-conversation","z":"796da880.c06928","name":"Garden","botTelegram":"19612d6f.770c43","botTelegramProduction":"19612d6f.770c43","botSlack":"","botSlackProduction":"","botFacebook":"","botFacebookProduction":"","botViber":"","botViberProduction":"","botUniversal":"","botUniversalProduction":"","botTwilio":"","botTwilioProduction":"","botDiscord":"","botDiscordProduction":"","chatId":"-257391012","transport":"telegram","messageId":"","contextMessageId":false,"store":"","x":300,"y":140,"wires":[["30fc82dd.51704e"]]},{"id":"30fc82dd.51704e","type":"chatbot-message","z":"796da880.c06928","name":"Text","message":[],"answer":false,"silent":false,"x":450,"y":140,"wires":[["2b8a77db.d82c28"]]},{"id":"bde211f0.94d9c","type":"link in","z":"796da880.c06928","name":"Messsage Garden","links":["249f4117.3329de","3a7c0926.309d16","c678cc7c.9e512","e5039bb6.86f6d8","146cf9e5.0f3a66","bbbb66d0.130c98","df720f01.a53be","3d88c4d8.4b121c"],"x":175,"y":140,"wires":[["7537ec2b.65c064"]]},{"id":"5760b907.4c8418","type":"chatbot-telegram-send","z":"796da880.c06928","bot":"29745a73.469c46","botProduction":"29745a73.469c46","track":false,"passThrough":false,"outputs":0,"x":630,"y":180,"wires":[]},{"id":"2e19da9b.9320e6","type":"chatbot-conversation","z":"796da880.c06928","name":"Test","botTelegram":"29745a73.469c46","botTelegramProduction":"29745a73.469c46","botSlack":"","botSlackProduction":"","botFacebook":"","botFacebookProduction":"","botViber":"","botViberProduction":"","botUniversal":"","botUniversalProduction":"","botTwilio":"","botTwilioProduction":"","botDiscord":"","botDiscordProduction":"","chatId":"-257391012","transport":"telegram","messageId":"","contextMessageId":false,"store":"","x":290,"y":180,"wires":[["a9b481a1.f2089"]]},{"id":"a9b481a1.f2089","type":"chatbot-message","z":"796da880.c06928","name":"Text","message":[],"answer":false,"silent":false,"x":450,"y":180,"wires":[["5760b907.4c8418"]]},{"id":"8e6ec212.65191","type":"link in","z":"796da880.c06928","name":"Messsage Test","links":["1cc30d5e.422973","2c447000.ed44","8a3e49e7.4daba8"],"x":175,"y":180,"wires":[["2e19da9b.9320e6"]]},{"id":"543bd5c9.d60d2c","type":"link out","z":"62f232c2.0dd08c","name":"","links":["57797689.55f7e8"],"x":480,"y":1320,"wires":[]},{"id":"f8882e97.4f3ab","type":"link out","z":"62f232c2.0dd08c","name":"","links":["57797689.55f7e8"],"x":375,"y":700,"wires":[]},{"id":"21ff3a8b.1ea676","type":"link out","z":"62f232c2.0dd08c","name":"","links":["57797689.55f7e8"],"x":495,"y":1680,"wires":[]},{"id":"11ad200e.773aa","type":"link out","z":"62f232c2.0dd08c","name":"","links":["57797689.55f7e8"],"x":1635,"y":1480,"wires":[]},{"id":"1e436d78.92e373","type":"link out","z":"62f232c2.0dd08c","name":"","links":["57797689.55f7e8"],"x":1755,"y":1320,"wires":[]},{"id":"d37eeef6.6df4","type":"link out","z":"62f232c2.0dd08c","name":"","links":["57797689.55f7e8"],"x":535,"y":80,"wires":[]},{"id":"14ea7344.24e0ed","type":"link out","z":"86a3c02f.3051a","name":"","links":["57797689.55f7e8"],"x":1615,"y":1680,"wires":[]},{"id":"9c41333e.5e556","type":"server-state-changed","z":"dfa48b6f.2ff088","name":"Print Status","server":"7d575fd3.be153","version":1,"entityidfilter":"sensor.octoprint_current_state","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"Operational","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":270,"y":360,"wires":[["293983f2.5499cc","3fa12ef5.d462a2"],["e43b8b68.fba218"]]},{"id":"293983f2.5499cc","type":"stoptimer","z":"dfa48b6f.2ff088","duration":"120","units":"Second","payloadtype":"num","payloadval":"0","name":"","x":510,"y":380,"wires":[["2002cf69.0ecc1"],[]]},{"id":"4099aeaa.6abd9","type":"api-current-state","z":"dfa48b6f.2ff088","name":"Off after print","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.off_after_printing","state_type":"habool","state_location":"","override_payload":"none","entity_location":"","override_data":"none","blockInputOverrides":false,"x":970,"y":380,"wires":[["b69c8369.5c54c"],[]]},{"id":"b69c8369.5c54c","type":"api-call-service","z":"dfa48b6f.2ff088","name":"Turn Off","server":"7d575fd3.be153","version":1,"service_domain":"switch","service":"turn_off","entityId":"switch.sonoff_printer","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1140,"y":380,"wires":[[]]},{"id":"efe46ff4.3a05a","type":"chatbot-telegram-receive","z":"dfa48b6f.2ff088","bot":"435a769d.ad67a8","botProduction":"435a769d.ad67a8","x":290,"y":980,"wires":[["709c2907.6c0f58"]]},{"id":"1c166acc.082545","type":"debug","z":"dfa48b6f.2ff088","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":650,"y":980,"wires":[]},{"id":"709c2907.6c0f58","type":"chatbot-authorized","z":"dfa48b6f.2ff088","x":470,"y":980,"wires":[["1c166acc.082545"],[]],"info":"532693134"},{"id":"7090a950.54dbe8","type":"chatbot-inline-buttons","z":"dfa48b6f.2ff088","name":"","buttons":[{"type":"postback","label":"Yes","value":"/off","answer":"Okay","alert":false,"style":"primary"},{"type":"postback","label":"No","value":"/on","answer":"Okay","alert":false,"style":"danger"}],"message":"Print complete, shall I turn off the printer?","x":640,"y":180,"wires":[["94e08a87.a74b68","b81ad4df.f9de98"]]},{"id":"94e08a87.a74b68","type":"chatbot-telegram-send","z":"dfa48b6f.2ff088","bot":"435a769d.ad67a8","botProduction":"435a769d.ad67a8","track":true,"passThrough":false,"outputs":1,"x":830,"y":180,"wires":[["b1878912.d929a8","18fa2ea7.07fa31"]]},{"id":"3fa12ef5.d462a2","type":"chatbot-conversation","z":"dfa48b6f.2ff088","name":"Printer","botTelegram":"435a769d.ad67a8","botTelegramProduction":"435a769d.ad67a8","botSlack":"","botSlackProduction":"","botFacebook":"","botFacebookProduction":"","botViber":"","botViberProduction":"","botUniversal":"","botUniversalProduction":"","botTwilio":"","botTwilioProduction":"","botDiscord":"","botDiscordProduction":"","chatId":"532693134","transport":"telegram","messageId":"","contextMessageId":false,"store":"","x":480,"y":180,"wires":[["7090a950.54dbe8"]]},{"id":"db2a0185.e4878","type":"inject","z":"dfa48b6f.2ff088","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":260,"y":180,"wires":[["3fa12ef5.d462a2"]]},{"id":"76de2177.7f9f2","type":"debug","z":"dfa48b6f.2ff088","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1190,"y":120,"wires":[]},{"id":"b1878912.d929a8","type":"chatbot-command","z":"dfa48b6f.2ff088","name":"","command":"/off","x":1050,"y":120,"wires":[["76de2177.7f9f2"]]},{"id":"9282274b.ce2c68","type":"debug","z":"dfa48b6f.2ff088","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1190,"y":240,"wires":[]},{"id":"18fa2ea7.07fa31","type":"chatbot-command","z":"dfa48b6f.2ff088","name":"","command":"/on","x":1050,"y":240,"wires":[["9282274b.ce2c68","87c53131.a8322"]]},{"id":"b81ad4df.f9de98","type":"function","z":"dfa48b6f.2ff088","name":"Semaphore LEAVE","func":"flow.set(\"printer_block_off\", false);\nreturn msg;","outputs":1,"noerr":0,"x":850,"y":80,"wires":[[]]},{"id":"87c53131.a8322","type":"function","z":"dfa48b6f.2ff088","name":"Semaphore OFF","func":"flow.set(\"printer_block_off\", true);\nreturn msg;","outputs":1,"noerr":0,"x":1260,"y":320,"wires":[[]]},{"id":"2002cf69.0ecc1","type":"function","z":"dfa48b6f.2ff088","name":"Semaphore Check","func":"var block =  flow.get(\"printer_block_off\");\n\nif(true === block)\n    return [msg, null]\nelse\n    return [null, msg]\n\nreturn msg;","outputs":2,"noerr":0,"x":770,"y":380,"wires":[[],["4099aeaa.6abd9"]]},{"id":"e43b8b68.fba218","type":"api-current-state","z":"dfa48b6f.2ff088","name":"Printer is on?","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"switch.sonoff_printer","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"","override_data":"none","blockInputOverrides":false,"x":510,"y":560,"wires":[["ea304ed4.2131c"],["ac22c1f8.7201c"]]},{"id":"18b0ba14.f35196","type":"inject","z":"dfa48b6f.2ff088","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":300,"y":560,"wires":[["e43b8b68.fba218"]]},{"id":"ac22c1f8.7201c","type":"api-call-service","z":"dfa48b6f.2ff088","name":"Turn On Printer","server":"7d575fd3.be153","version":1,"service_domain":"switch","service":"turn_on","entityId":"switch.sonoff_printer","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":740,"y":600,"wires":[["de9a6d0b.ac07a"]]},{"id":"575cc9ac.1495f8","type":"chatbot-message","z":"dfa48b6f.2ff088","name":"Text","message":[{"message":"Print started, turning printer on"}],"answer":false,"silent":false,"x":1070,"y":600,"wires":[["ef2ff437.f7fba8"]]},{"id":"3802000f.0a8fd","type":"chatbot-message","z":"dfa48b6f.2ff088","name":"Text","message":[{"message":"Print started"}],"answer":false,"silent":false,"x":870,"y":520,"wires":[["2a46768c.3c9fba"]]},{"id":"ea304ed4.2131c","type":"chatbot-conversation","z":"dfa48b6f.2ff088","name":"Printer","botTelegram":"435a769d.ad67a8","botTelegramProduction":"435a769d.ad67a8","botSlack":"","botSlackProduction":"","botFacebook":"","botFacebookProduction":"","botViber":"","botViberProduction":"","botUniversal":"","botUniversalProduction":"","botTwilio":"","botTwilioProduction":"","botDiscord":"","botDiscordProduction":"","chatId":"532693134","transport":"telegram","messageId":"","contextMessageId":false,"store":"","x":710,"y":520,"wires":[["3802000f.0a8fd"]]},{"id":"de9a6d0b.ac07a","type":"chatbot-conversation","z":"dfa48b6f.2ff088","name":"Printer","botTelegram":"435a769d.ad67a8","botTelegramProduction":"435a769d.ad67a8","botSlack":"","botSlackProduction":"","botFacebook":"","botFacebookProduction":"","botViber":"","botViberProduction":"","botUniversal":"","botUniversalProduction":"","botTwilio":"","botTwilioProduction":"","botDiscord":"","botDiscordProduction":"","chatId":"532693134","transport":"telegram","messageId":"","contextMessageId":false,"store":"","x":910,"y":600,"wires":[["575cc9ac.1495f8"]]},{"id":"2a46768c.3c9fba","type":"chatbot-telegram-send","z":"dfa48b6f.2ff088","bot":"435a769d.ad67a8","botProduction":"435a769d.ad67a8","track":true,"passThrough":false,"outputs":1,"x":1070,"y":520,"wires":[[]]},{"id":"ef2ff437.f7fba8","type":"chatbot-telegram-send","z":"dfa48b6f.2ff088","bot":"435a769d.ad67a8","botProduction":"435a769d.ad67a8","track":true,"passThrough":false,"outputs":1,"x":1270,"y":600,"wires":[[]]},{"id":"d9b9e2ee.667f6","type":"api-current-state","z":"5e97ea24.516424","name":"Rain Chance","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"0","halt_if_type":"num","halt_if_compare":"gt","override_topic":false,"entity_id":"sensor.dark_sky_forecast_precip_probability_0d","state_type":"str","state_location":"payload.rain_chance","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":410,"y":100,"wires":[["dd09b04.2d0a35"],["dd09b04.2d0a35"]]},{"id":"dd09b04.2d0a35","type":"api-current-state","z":"5e97ea24.516424","name":"Intensity","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"0.25","halt_if_type":"num","halt_if_compare":"gt","override_topic":false,"entity_id":"sensor.dark_sky_forecast_daily_max_precip_intensity_0d","state_type":"str","state_location":"payload.rain_intensity","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":420,"y":180,"wires":[["25ed69a.ace5796"],["25ed69a.ace5796"]]},{"id":"25ed69a.ace5796","type":"api-current-state","z":"5e97ea24.516424","name":"Max temp","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"0","halt_if_type":"num","halt_if_compare":"gt","override_topic":false,"entity_id":"sensor.dark_sky_forecast_daytime_high_temperature_0d","state_type":"str","state_location":"payload.max_temp","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":420,"y":260,"wires":[["b0bcfb6f.5f8148"],["b0bcfb6f.5f8148"]]},{"id":"d78eef7f.7e334","type":"function","z":"5e97ea24.516424","name":"Prep","func":"var payload;\n\nvar rain_intensity = 0;\nvar rain_chance = 0;\nvar max_temp = 0;\nvar water_seconds = 0;\n\npayload = {rain_intensity, rain_chance, max_temp, water_seconds};\n\nmsg.payload = payload;\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":100,"wires":[["d9b9e2ee.667f6"]]},{"id":"18bc4228.2b5abe","type":"inject","z":"5e97ea24.516424","name":"5am","repeat":"","crontab":"00 05 * * *","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":110,"y":100,"wires":[["d78eef7f.7e334"]]},{"id":"b0bcfb6f.5f8148","type":"function","z":"5e97ea24.516424","name":"Water Time","func":"if((msg.payload.rain_chance > 50) & (msg.payload.rain_intensity > 0.25))\n{\n    return [msg, null];\n}\n\nmsg.payload.water_seconds = ((0.75 * msg.payload.max_temp) + 0) * 60\nreturn [null, msg];","outputs":2,"noerr":0,"x":670,"y":180,"wires":[["dd29a7a8.79c0c8"],["e8aa62c4.2a31d","b16d386e.234a88"]]},{"id":"dd29a7a8.79c0c8","type":"function","z":"5e97ea24.516424","name":"Prepare Text","func":"msg.topic = \"garden\"\nvar content = \"Expected rain: \" + msg.payload.rain_intensity;\ncontent += \" mm/h\\n\";\ncontent += \"Chance: \" + msg.payload.rain_chance;\ncontent += \"%\\n\";\ncontent += \"So no water this morning\";\nmsg.payload = content;\nreturn msg;","outputs":1,"noerr":0,"x":890,"y":140,"wires":[["bbbb66d0.130c98"]]},{"id":"bbbb66d0.130c98","type":"link out","z":"5e97ea24.516424","name":"","links":["bde211f0.94d9c"],"x":1055,"y":140,"wires":[]},{"id":"e8aa62c4.2a31d","type":"function","z":"5e97ea24.516424","name":"Seconds to Pulses","func":"var seconds = msg.payload.water_seconds;\nvar pulse = 0;\n\nif(seconds <= 11)\n{\n    pulse = seconds * 10;\n}\nelse\n{\n    pulse = seconds + 100;\n}\n\nmsg.topic = \"sonoff_garden/cmnd/PulseTime\"\nmsg.payload = pulse\nmsg.delay = (seconds + 60) * 1000\nmsg.seconds = seconds\nreturn msg;","outputs":1,"noerr":0,"x":910,"y":240,"wires":[["6e7e7229.cce99c","969fb0ca.2fa5b","6f12e6d4.0e07d8"]]},{"id":"6e7e7229.cce99c","type":"mqtt out","z":"5e97ea24.516424","name":"","topic":"","qos":"","retain":"","broker":"2eafe4c0.b7da5c","x":1390,"y":240,"wires":[]},{"id":"b16d386e.234a88","type":"function","z":"5e97ea24.516424","name":"Prepare Text","func":"msg.topic = \"garden\"\nvar content = \"AM Water Time: \" + ((msg.payload.water_seconds) / 60);\ncontent += \" minutes\\n\";\ncontent += \"Expected rain: \" + msg.payload.rain_intensity;\ncontent += \" mm/h\\n\";\ncontent += \"Chance: \" + msg.payload.rain_chance;\ncontent += \"%\\n\";\ncontent += \"Max Temp: \" + msg.payload.max_temp;\ncontent += \"C\";\nmsg.payload = content;\nreturn msg;","outputs":1,"noerr":0,"x":890,"y":200,"wires":[["3d88c4d8.4b121c"]]},{"id":"3d88c4d8.4b121c","type":"link out","z":"5e97ea24.516424","name":"","links":["bde211f0.94d9c"],"x":1055,"y":200,"wires":[]},{"id":"923cc35a.0165f","type":"server-state-changed","z":"5e97ea24.516424","name":"Manual trigger","server":"7d575fd3.be153","version":1,"entityidfilter":"input_boolean.garden_test","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":466,"y":1020,"wires":[["cf3f50a7.7d179","ef9cf33f.921aa"],[]]},{"id":"cf3f50a7.7d179","type":"function","z":"5e97ea24.516424","name":"Water Time","func":"var seconds = 30\nvar pulse = 0;\n\nif(seconds <= 11)\n{\n    pulse = seconds * 10;\n}\nelse\n{\n    pulse = seconds + 100;\n}\nmsg.topic = \"sonoff_garden/cmnd/PulseTime\"\nmsg.payload = pulse\nreturn msg;","outputs":1,"noerr":0,"x":666,"y":980,"wires":[["aef54f7f.a4bcf"]]},{"id":"aef54f7f.a4bcf","type":"mqtt out","z":"5e97ea24.516424","name":"","topic":"","qos":"","retain":"","broker":"2eafe4c0.b7da5c","x":866,"y":980,"wires":[]},{"id":"ef9cf33f.921aa","type":"delay","z":"5e97ea24.516424","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":656,"y":1040,"wires":[["6b4d9d14.377144"]]},{"id":"67c1e6ae.80e358","type":"mqtt out","z":"5e97ea24.516424","name":"","topic":"","qos":"","retain":"","broker":"2eafe4c0.b7da5c","x":1046,"y":1040,"wires":[]},{"id":"6b4d9d14.377144","type":"function","z":"5e97ea24.516424","name":"Power","func":"msg.topic = \"sonoff_garden/cmnd/Power\"\nmsg.payload = \"1\"\nreturn msg;","outputs":1,"noerr":0,"x":826,"y":1040,"wires":[["b5c8d8bd.f19a28","67c1e6ae.80e358"]]},{"id":"b5c8d8bd.f19a28","type":"api-call-service","z":"5e97ea24.516424","name":"Turn off bool","server":"7d575fd3.be153","version":1,"service_domain":"input_boolean","service":"turn_off","entityId":"input_boolean.garden_test","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1016,"y":1120,"wires":[[]]},{"id":"1c8fee3.7a81212","type":"mqtt out","z":"5e97ea24.516424","name":"","topic":"","qos":"0","retain":"false","broker":"2eafe4c0.b7da5c","x":686,"y":1220,"wires":[]},{"id":"1131064d.e21e5a","type":"function","z":"5e97ea24.516424","name":"Water Time","func":"var seconds = 60\nvar pulse = 0\n\nif(seconds <= 11)\n{\n    pulse = seconds * 10;\n}\nelse\n{\n    pulse = seconds + 100;\n}\nmsg.topic = \"sonoff_entrance/cmnd/PulseTime\"\nmsg.payload = pulse\nreturn msg;","outputs":1,"noerr":0,"x":506,"y":1220,"wires":[["1c8fee3.7a81212","827a5de.844f4a"]]},{"id":"63b32a88.a14424","type":"inject","z":"5e97ea24.516424","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":276,"y":1220,"wires":[["1131064d.e21e5a"]]},{"id":"827a5de.844f4a","type":"delay","z":"5e97ea24.516424","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":696,"y":1300,"wires":[["67bd8809.f97438"]]},{"id":"6b2a84ab.03693c","type":"mqtt out","z":"5e97ea24.516424","name":"","topic":"","qos":"","retain":"","broker":"2eafe4c0.b7da5c","x":1026,"y":1300,"wires":[]},{"id":"67bd8809.f97438","type":"function","z":"5e97ea24.516424","name":"Power","func":"msg.topic = \"sonoff_entrance/cmnd/Power\"\nmsg.payload = 1\nreturn msg;","outputs":1,"noerr":0,"x":866,"y":1300,"wires":[["6b2a84ab.03693c"]]},{"id":"6ce2a0d7.53834","type":"delay","z":"5e97ea24.516424","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":836,"y":540,"wires":[["f599842.58fa478"]]},{"id":"f599842.58fa478","type":"function","z":"5e97ea24.516424","name":"Power","func":"msg.topic = \"sonoff_garden/cmnd/Power\"\nmsg.payload = \"1\"\nreturn msg;","outputs":1,"noerr":0,"x":986,"y":540,"wires":[["bedb8077.e3b2"]]},{"id":"969fb0ca.2fa5b","type":"delay","z":"5e97ea24.516424","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1120,"y":300,"wires":[["85d49bdd.570708"]]},{"id":"85d49bdd.570708","type":"function","z":"5e97ea24.516424","name":"Power","func":"msg.topic = \"sonoff_garden/cmnd/Power\"\nmsg.payload = \"1\"\nreturn msg;","outputs":1,"noerr":0,"x":1250,"y":300,"wires":[["6e7e7229.cce99c"]]},{"id":"71220c0b.8b1784","type":"function","z":"3788fae5.b038d6","name":"Right Logic","func":"var state = flow.get(\"light_state\") || \"off\";\n\nswitch(state)\n{\n    case \"low\":\n        flow.set(\"light_state\", \"off\");\n        return[null, msg];\n\n    default:\n    case \"off\":    \n    case \"high\":\n        flow.set(\"light_state\", \"low\");\n        return[msg, null];\n    \n}","outputs":2,"noerr":0,"x":730,"y":1020,"wires":[["a03b3143.2e984"],["5e064f7d.8b5e8"]]},{"id":"d9f6ef8a.07329","type":"api-call-service","z":"3788fae5.b038d6","name":"lounge","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_on","entityId":"light.lounge","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1350,"y":1120,"wires":[[]]},{"id":"24070940.e6db56","type":"switch","z":"3788fae5.b038d6","name":"","property":"topic","propertyType":"msg","rules":[{"t":"neq","v":"reset","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1210,"y":1120,"wires":[["d9f6ef8a.07329"]]},{"id":"5e064f7d.8b5e8","type":"api-call-service","z":"3788fae5.b038d6","name":"Turn off","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"light.lounge","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":880,"y":1040,"wires":[[]]},{"id":"38fabf61.ef737","type":"function","z":"3788fae5.b038d6","name":"Left Logic","func":"var state = flow.get(\"light_state\") || \"off\";\n\nswitch(state)\n{\n    case \"high\":\n        flow.set(\"light_state\", \"off\");\n        return[null, msg];\n\n    default:\n    case \"off\":    \n    case \"low\":\n        flow.set(\"light_state\", \"high\");\n        return[msg, null];\n}","outputs":2,"noerr":0,"x":720,"y":860,"wires":[["8adf2889.bd0738"],["207fed52.090452"]]},{"id":"207fed52.090452","type":"api-call-service","z":"3788fae5.b038d6","name":"Turn off","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"light.lounge","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":880,"y":900,"wires":[[]]},{"id":"2e2298f5.0bdfc8","type":"inject","z":"2c8f60c4.cfd28","name":"Every Second","repeat":"60","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":200,"y":280,"wires":[["4f14763c.99f148"]]},{"id":"7cc24544.b8b70c","type":"rbe","z":"2c8f60c4.cfd28","name":"","func":"rbe","gap":"","start":"","inout":"out","property":"payload","x":470,"y":160,"wires":[["e4ab0d4b.18e32"]]},{"id":"4f14763c.99f148","type":"function","z":"2c8f60c4.cfd28","name":"Get Hour","func":"function gethour() {\n var date = new Date();\n var hour = (\"0\"+date.getHours()).substr(-2);\n return hour;\n}\n\nvar hour = gethour();\n\nreturn { payload : hour };","outputs":1,"noerr":0,"x":340,"y":160,"wires":[["7cc24544.b8b70c"]]},{"id":"c1338771.c073c8","type":"api-current-state","z":"2c8f60c4.cfd28","name":"Low Traffic","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"20","halt_if_type":"num","halt_if_compare":"lte","override_topic":false,"entity_id":"sensor.rt_ac53_kb_sec_received","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":650,"y":300,"wires":[["e4ab0d4b.18e32"],[]]},{"id":"3de22929.0a41c6","type":"api-call-service","z":"2c8f60c4.cfd28","name":"Speedtest","server":"7d575fd3.be153","version":1,"service_domain":"speedtestdotnet","service":"speedtest","entityId":"","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":true,"x":1000,"y":120,"wires":[[]]},{"id":"b7d1ff1.6f93","type":"inject","z":"2c8f60c4.cfd28","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":500,"y":300,"wires":[["c1338771.c073c8"]]},{"id":"e4ab0d4b.18e32","type":"change","z":"2c8f60c4.cfd28","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":850,"y":220,"wires":[["3de22929.0a41c6"]]},{"id":"2c447000.ed44","type":"link out","z":"fa310ecb.c84eb","name":"","links":["8e6ec212.65191"],"x":1015,"y":740,"wires":[]},{"id":"e2f4c507.c56d18","type":"http request","z":"fa310ecb.c84eb","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"https://www.diyelectronics.co.za/store/198-3d-printers?orderby=price&orderway=asc","tls":"","persist":false,"proxy":"","authType":"","x":330,"y":740,"wires":[["c590b0ad.0f799"]]},{"id":"c590b0ad.0f799","type":"html","z":"fa310ecb.c84eb","name":"","property":"","outproperty":"","tag":".product-count","ret":"html","as":"single","x":500,"y":740,"wires":[["356484fd.cb0f7c"]]},{"id":"356484fd.cb0f7c","type":"string","z":"fa310ecb.c84eb","name":"","methods":[{"name":"strip","params":[{"type":"str","value":"Showing 1 - 24 of "}]},{"name":"strip","params":[{"type":"str","value":" items"}]},{"name":"toInteger","params":[]}],"prop":"payload","propout":"payload","object":"msg","objectout":"msg","x":650,"y":740,"wires":[["47fd65e.950779c"]]},{"id":"47fd65e.950779c","type":"switch","z":"fa310ecb.c84eb","name":"","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"36","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":770,"y":740,"wires":[["704ed9eb.260878"]]},{"id":"704ed9eb.260878","type":"function","z":"fa310ecb.c84eb","name":"Prepare Text","func":"msg.topic = \"test\"\nvar content = \"Products added!\\n\"\ncontent += msg.payload;\ncontent += \" products now in stock.\";\ncontent += \"https://www.diyelectronics.co.za/store/198-3d-printers?orderby=price&orderway=asc\"\nmsg.payload = content;\nreturn msg;","outputs":1,"noerr":0,"x":910,"y":740,"wires":[["2c447000.ed44"]]},{"id":"8a3e49e7.4daba8","type":"link out","z":"fa310ecb.c84eb","name":"","links":["8e6ec212.65191"],"x":575,"y":860,"wires":[]},{"id":"a49f86eb.5994e8","type":"inject","z":"fa310ecb.c84eb","name":"make request","repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"date","x":150,"y":800,"wires":[[]]},{"id":"a5429b18.214428","type":"http request","z":"fa310ecb.c84eb","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"https://www.diyelectronics.co.za/store/198-3d-printers?orderby=price&orderway=asc","tls":"","persist":false,"proxy":"","authType":"","x":330,"y":800,"wires":[["1ec3c50b.2c54bb"]]},{"id":"1ec3c50b.2c54bb","type":"html","z":"fa310ecb.c84eb","name":"","property":"","outproperty":"","tag":".product-container","ret":"html","as":"multi","x":510,"y":800,"wires":[["7bbd19a8.39fe08"]]},{"id":"7bbd19a8.39fe08","type":"function","z":"fa310ecb.c84eb","name":"filter","func":"if(msg.payload.includes(\"Giveaway\"))\n    return msg;\n\n\nreturn null;","outputs":1,"noerr":0,"x":670,"y":800,"wires":[["83bdd7b4.04aa68"]]},{"id":"83bdd7b4.04aa68","type":"html","z":"fa310ecb.c84eb","name":"","property":"payload","outproperty":"payload","tag":".product-image-container","ret":"html","as":"multi","x":850,"y":800,"wires":[["ff9bc552.2ccba8"]]},{"id":"ff9bc552.2ccba8","type":"string","z":"fa310ecb.c84eb","name":"","methods":[{"name":"decodeHTMLEntities","params":[]},{"name":"strip","params":[{"type":"str","value":"<a class=\"product_img_link\" href=\""}]},{"name":"split","params":[{"type":"str","value":"\""},{"type":"num","value":"2"}]}],"prop":"payload","propout":"payload","object":"msg","objectout":"msg","x":170,"y":860,"wires":[["1375878c.989168"]]},{"id":"ab7ed81f.e392c8","type":"function","z":"fa310ecb.c84eb","name":"Prepare Text","func":"msg.topic = \"Giveaway\"\nvar content = \"Product added!\\n\"\ncontent += msg.payload[0];\nmsg.payload = content;\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":860,"wires":[["8a3e49e7.4daba8"]]},{"id":"1375878c.989168","type":"function","z":"fa310ecb.c84eb","name":"filter2","func":"if(msg.payload[0].includes(\"2743\"))\n    return null;\n\nif(msg.payload[0].includes(\"2750\"))\n    return null;\n\nreturn msg;","outputs":1,"noerr":0,"x":310,"y":860,"wires":[["ab7ed81f.e392c8"]]},{"id":"f25a59b5.d8fcb8","type":"server-state-changed","z":"3788fae5.b038d6","name":"Light turned off","server":"7d575fd3.be153","version":1,"entityidfilter":"light.lounge","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"off","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":190,"y":860,"wires":[["9021c270.0a3b8"],[]]},{"id":"9021c270.0a3b8","type":"function","z":"3788fae5.b038d6","name":"Reset Logic","func":"flow.set(\"light_state\", \"off\");","outputs":2,"noerr":0,"x":390,"y":860,"wires":[[],[]]},{"id":"28f7dda.47db922","type":"mqtt in","z":"152554cc.389edb","name":"Button AC","topic":"coffee_table/btnAC","qos":"0","datatype":"auto","broker":"2eafe4c0.b7da5c","x":200,"y":2100,"wires":[["9914c125.c00b9"]]},{"id":"9914c125.c00b9","type":"subflow:a436e8cb.527cf8","z":"152554cc.389edb","name":"","env":[],"x":410,"y":2100,"wires":[]},{"id":"f38d4829.a2e8f8","type":"api-call-service","z":"ef54a0c2.e259d","name":"Select Source","server":"7d575fd3.be153","version":1,"service_domain":"media_player","service":"select_source","entityId":"media_player.spotify","data":"{\"source\":\"Librespot@Jukebox\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":580,"y":160,"wires":[[]]},{"id":"4781246c.8cfadc","type":"spotify","z":"ef54a0c2.e259d","name":"Spotify","auth":"6db11244.bdedac","api":"getMyCurrentPlayingTrack","x":390,"y":780,"wires":[["b626988c.df8b88"]]},{"id":"a3cc4e62.9707a","type":"inject","z":"ef54a0c2.e259d","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"Devices","payloadType":"str","x":230,"y":780,"wires":[["4781246c.8cfadc"]]},{"id":"f9f87d8.95a018","type":"debug","z":"ef54a0c2.e259d","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":950,"y":780,"wires":[]},{"id":"b626988c.df8b88","type":"function","z":"ef54a0c2.e259d","name":"Filter Image URL","func":"msg.url = msg.payload.item.album.images[0].url\n\nreturn msg","outputs":1,"noerr":0,"x":570,"y":780,"wires":[["f9f87d8.95a018","e781411e.17d3"]]},{"id":"e781411e.17d3","type":"http request","z":"ef54a0c2.e259d","name":"","method":"GET","ret":"bin","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":770,"y":840,"wires":[["fc8077f7.fe9988"]]},{"id":"fc8077f7.fe9988","type":"file","z":"ef54a0c2.e259d","name":"save image","filename":"/share/album.jfif","appendNewline":false,"createDir":false,"overwriteFile":"true","x":990,"y":880,"wires":[[]]},{"id":"9c951cb.a9ac2e","type":"http in","z":"ef54a0c2.e259d","name":"","url":"/album.html","method":"get","upload":false,"swaggerDoc":"","x":170,"y":980,"wires":[["6359ebf.27cb314"]]},{"id":"6359ebf.27cb314","type":"file in","z":"ef54a0c2.e259d","name":"","filename":"/share/album.html","format":"","x":430,"y":980,"wires":[["9965632d.99f1e"]]},{"id":"9965632d.99f1e","type":"change","z":"ef54a0c2.e259d","name":"Set Headers","rules":[{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers.content-type","pt":"msg","to":"text/html","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":640,"y":980,"wires":[["e6dd72f3.34a46"]]},{"id":"e6dd72f3.34a46","type":"http response","z":"ef54a0c2.e259d","name":"","statusCode":"","headers":{},"x":810,"y":980,"wires":[]},{"id":"cfb8664b.53ecb8","type":"switch","z":"152554cc.389edb","name":"Click Type","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"click","vt":"str"},{"t":"eq","v":"hold","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1550,"y":1060,"wires":[["da76c1d1.cd9cd"],["e558806f.3db85"]]},{"id":"822e9cff.e7c4b","type":"mqtt out","z":"152554cc.389edb","name":"","topic":"","qos":"","retain":"","broker":"2eafe4c0.b7da5c","x":1910,"y":1300,"wires":[]},{"id":"912c420d.2b4d8","type":"function","z":"152554cc.389edb","name":"TV Power","func":"msg.topic = \"coffee_table/command\"\nmsg.payload = \"tv_power\"\nreturn msg;","outputs":1,"noerr":0,"x":1730,"y":1300,"wires":[["822e9cff.e7c4b"]]},{"id":"6f12e6d4.0e07d8","type":"delay","z":"5e97ea24.516424","name":"","pauseType":"delayv","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1120,"y":380,"wires":[["7a8c2275.de509c"]]},{"id":"7a8c2275.de509c","type":"function","z":"5e97ea24.516424","name":"extract delay","func":"msg.delay = msg.seconds * 1000\nreturn msg;","outputs":1,"noerr":0,"x":1290,"y":380,"wires":[["f5f98afa.e3e548"]]},{"id":"f5f98afa.e3e548","type":"api-call-service","z":"5e97ea24.516424","name":"Water On","server":"7d575fd3.be153","version":1,"service_domain":"switch","service":"turn_on","entityId":"switch.front_garden_irrigation","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1460,"y":380,"wires":[["ee747518.3b34e8"]]},{"id":"ee747518.3b34e8","type":"delay","z":"5e97ea24.516424","name":"","pauseType":"delayv","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1620,"y":380,"wires":[["a1f2f568.3b3f48"]]},{"id":"a1f2f568.3b3f48","type":"api-call-service","z":"5e97ea24.516424","name":"Water On","server":"7d575fd3.be153","version":1,"service_domain":"switch","service":"turn_off","entityId":"switch.front_garden_irrigation","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1780,"y":380,"wires":[[]]},{"id":"48ccf6bc.6f7a98","type":"delay","z":"5e97ea24.516424","name":"","pauseType":"delayv","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":920,"y":480,"wires":[["6990fc0a.de8284"]]},{"id":"6990fc0a.de8284","type":"function","z":"5e97ea24.516424","name":"extract delay","func":"msg.delay = msg.seconds * 1000\nreturn msg;","outputs":1,"noerr":0,"x":1090,"y":480,"wires":[["56ca6eef.d61f6"]]},{"id":"56ca6eef.d61f6","type":"api-call-service","z":"5e97ea24.516424","name":"Water On","server":"7d575fd3.be153","version":1,"service_domain":"switch","service":"turn_on","entityId":"switch.front_garden_irrigation","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1260,"y":480,"wires":[["59e3eace.18eb34"]]},{"id":"59e3eace.18eb34","type":"delay","z":"5e97ea24.516424","name":"","pauseType":"delayv","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1420,"y":480,"wires":[["d24745bb.0b44e8"]]},{"id":"d24745bb.0b44e8","type":"api-call-service","z":"5e97ea24.516424","name":"Water On","server":"7d575fd3.be153","version":1,"service_domain":"switch","service":"turn_off","entityId":"switch.front_garden_irrigation","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1580,"y":480,"wires":[[]]},{"id":"8da65476.5ce448","type":"server-state-changed","z":"86a3c02f.3051a","name":"Bedroom Door","server":"7d575fd3.be153","version":1,"entityidfilter":"binary_sensor.contact_bedroom_door","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"off","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":260,"y":2380,"wires":[["f28d3668.2bb1a8","35b114f7.13131c"],["396f8727.f1fb08"]]},{"id":"18e4dbe1.07c2c4","type":"api-current-state","z":"86a3c02f.3051a","name":">20C","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"20","halt_if_type":"num","halt_if_compare":"gte","override_topic":false,"entity_id":"sensor.temperature_bedroom","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":650,"y":2320,"wires":[["bc3a00b9.8ba51"],[]]},{"id":"bc3a00b9.8ba51","type":"api-call-service","z":"86a3c02f.3051a","name":"Turn on Bedroom AC","server":"7d575fd3.be153","version":1,"service_domain":"climate","service":"turn_on","entityId":"climate.bedroom_ac","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":880,"y":2320,"wires":[[]]},{"id":"30a3034b.ccd10c","type":"api-call-service","z":"86a3c02f.3051a","name":"Turn off Bedroom AC","server":"7d575fd3.be153","version":1,"service_domain":"climate","service":"turn_off","entityId":"climate.bedroom_ac","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":820,"y":2420,"wires":[[]]},{"id":"f28d3668.2bb1a8","type":"api-current-state","z":"86a3c02f.3051a","name":"After Bedtime","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.bedtime","state_type":"habool","state_location":"","override_payload":"none","entity_location":"","override_data":"none","blockInputOverrides":false,"x":480,"y":2200,"wires":[["d8f42877.d8c0f8"],["dea95ee7.21b3e"]]},{"id":"d8f42877.d8c0f8","type":"function","z":"86a3c02f.3051a","name":"Red","func":"msg.payload = \n{\n    data:\n    {\n        \"brightness_pct\":20,\n        \"rgb_color\":[255,0,0]\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":2160,"wires":[["75dd0ebf.d22e4"]]},{"id":"75dd0ebf.d22e4","type":"api-call-service","z":"86a3c02f.3051a","name":"Bedroom Lights","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_on","entityId":"light.bedroom","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":880,"y":2200,"wires":[[]]},{"id":"dea95ee7.21b3e","type":"function","z":"86a3c02f.3051a","name":"White","func":"msg.payload = \n{\n    data:\n    {\n        \"brightness\":255,\n        \"color_temp\":268\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":2240,"wires":[["75dd0ebf.d22e4"]]},{"id":"396f8727.f1fb08","type":"delay","z":"86a3c02f.3051a","name":"","pauseType":"delay","timeout":"30","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":440,"y":2420,"wires":[["2e946082.437e7"]]},{"id":"2e946082.437e7","type":"api-current-state","z":"86a3c02f.3051a","name":"Still Open?","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"binary_sensor.contact_bedroom_door","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":610,"y":2420,"wires":[["30a3034b.ccd10c"],[]]},{"id":"4fee1ad1.8fff14","type":"mqtt in","z":"9c2230b1.bee8d","name":"Markiv","topic":"markiv/service","qos":"0","datatype":"auto","broker":"2eafe4c0.b7da5c","x":930,"y":40,"wires":[["3de8c802.b4b118"]]},{"id":"3de8c802.b4b118","type":"debug","z":"9c2230b1.bee8d","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1110,"y":40,"wires":[]},{"id":"e9509f01.2a033","type":"delay","z":"ca5a8b67.211fb8","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":700,"y":220,"wires":[["808986d8.385e28"]]},{"id":"808986d8.385e28","type":"api-call-service","z":"ca5a8b67.211fb8","name":"Lounge AC","server":"7d575fd3.be153","version":1,"service_domain":"climate","service":"turn_off","entityId":"climate.lounge_ac","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":890,"y":220,"wires":[[]]},{"id":"4136d2ff.36477c","type":"delay","z":"3788fae5.b038d6","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1200,"y":100,"wires":[["36aa2159.fb3dbe"]]},{"id":"36aa2159.fb3dbe","type":"api-call-service","z":"3788fae5.b038d6","name":"Turn on AC","server":"7d575fd3.be153","version":1,"service_domain":"climate","service":"turn_on","entityId":"climate.lounge_ac","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1350,"y":100,"wires":[[]]},{"id":"cc5a188e.9cf8f8","type":"chatbot-telegram-receive","z":"9c2230b1.bee8d","bot":"b2e0dafd.f67fa8","botProduction":"","x":130,"y":360,"wires":[["a3c8d85f.40efe8"]]},{"id":"a3c8d85f.40efe8","type":"chatbot-authorized","z":"9c2230b1.bee8d","x":340,"y":360,"wires":[["bee8f937.aa5e18","3ea3c08.0d6294"],[]]},{"id":"376f5c00.3c3344","type":"file","z":"9c2230b1.bee8d","name":"","filename":"","appendNewline":false,"createDir":false,"overwriteFile":"true","encoding":"none","x":1490,"y":720,"wires":[["7a5e459b.fb826c"]]},{"id":"bee8f937.aa5e18","type":"chatbot-command","z":"9c2230b1.bee8d","name":"","command":"/add","x":510,"y":320,"wires":[["b13d88f5.bf4e68"]]},{"id":"82d6dbc5.e38a78","type":"chatbot-telegram-send","z":"9c2230b1.bee8d","bot":"b2e0dafd.f67fa8","botProduction":"b2e0dafd.f67fa8","track":true,"passThrough":false,"outputs":1,"x":1630,"y":400,"wires":[["87665923.68fb98"]]},{"id":"9b36cbcc.9dc5f8","type":"function","z":"9c2230b1.bee8d","name":"Req Name","func":"msg.topic = \"Req Name\"\nmsg.payload = \"Adding a new person, please send me their name\"\nreturn msg;","outputs":1,"noerr":0,"x":1330,"y":400,"wires":[["cc5dd366.899bf"]]},{"id":"cc5dd366.899bf","type":"chatbot-message","z":"9c2230b1.bee8d","name":"Text","message":[],"answer":false,"silent":false,"x":1470,"y":400,"wires":[["82d6dbc5.e38a78"]]},{"id":"87665923.68fb98","type":"chatbot-parse","z":"9c2230b1.bee8d","name":"","parseType":"string","parseVariable":"name","x":1820,"y":400,"wires":[["f4a93850.363818"],[]]},{"id":"50588d53.eac1d4","type":"chatbot-telegram-send","z":"9c2230b1.bee8d","bot":"b2e0dafd.f67fa8","botProduction":"b2e0dafd.f67fa8","track":true,"passThrough":false,"outputs":1,"x":1650,"y":520,"wires":[["74075316.0f346c"]]},{"id":"f4a93850.363818","type":"function","z":"9c2230b1.bee8d","name":"Request Picture","func":"var chat = msg.chat();\nvar name = chat.get('name');\nvar people = flow.get('people')\n\nfor(var i=0; i<people.length; i++)\n{\n    if(name == people[i].name)\n    {\n        msg.payload = name + \"'s already in the system\"\n        return [null, msg]\n    }\n}\n\nmsg.topic = \"Req Pic\"\nmsg.payload = \"Please send me a picture of \"\nmsg.payload += name\nmsg.payload += \"'s face.\"\n\nflow.set(\"name\", name)\n\nreturn [msg, null]","outputs":2,"noerr":0,"x":1320,"y":520,"wires":[["aa3c09a5.391068"],["b7de3928.855568"]]},{"id":"aa3c09a5.391068","type":"chatbot-message","z":"9c2230b1.bee8d","name":"Text","message":[],"answer":false,"silent":false,"x":1470,"y":520,"wires":[["50588d53.eac1d4"]]},{"id":"74075316.0f346c","type":"chatbot-parse","z":"9c2230b1.bee8d","name":"","parseType":"photo","parseVariable":"face","x":1840,"y":520,"wires":[["4a910f4e.97406"],[]]},{"id":"bd3d57e3.36ada8","type":"chatbot-message","z":"9c2230b1.bee8d","name":"Text","message":[],"answer":false,"silent":false,"x":1930,"y":860,"wires":[["a3c7f146.b923f","bf897ab2.55eea8"]]},{"id":"4a910f4e.97406","type":"function","z":"9c2230b1.bee8d","name":"Get Picture","func":"var chat = msg.chat();\nvar name = chat.get('name');\n\nname = name.replace(/\\s/g,\"\").toLowerCase()\n\nmsg.filename = \"/share/markiv/faces/\" + name + \".jpg\"\n\nreturn msg;","outputs":1,"noerr":0,"x":1290,"y":720,"wires":[["376f5c00.3c3344"]]},{"id":"a3c7f146.b923f","type":"chatbot-telegram-send","z":"9c2230b1.bee8d","bot":"b2e0dafd.f67fa8","botProduction":"b2e0dafd.f67fa8","track":true,"passThrough":false,"outputs":1,"x":2110,"y":820,"wires":[[]]},{"id":"3ea3c08.0d6294","type":"chatbot-command","z":"9c2230b1.bee8d","name":"","command":"/list","x":510,"y":380,"wires":[["cdf08bf.ea9d578"]]},{"id":"bea7c30d.57e05","type":"chatbot-inline-buttons","z":"9c2230b1.bee8d","name":"","buttons":[],"message":"","x":1480,"y":1120,"wires":[["a916c3eb.9306"]]},{"id":"c81493b2.5aade","type":"function","z":"9c2230b1.bee8d","name":"Prep","func":"var people = flow.get(\"people\");\n\nmsg.payload.message = \"People in the system:\"\nmsg.payload.buttons = []\n\nfor(var i=0; i<people.length; i++)\n{\n    var button = \n    {\n      type: 'postback',\n      value: people[i].name,\n      label: people[i].name\n    };\n    msg.payload.buttons.push(button);\n}\nreturn msg;\n","outputs":1,"noerr":0,"x":1330,"y":1120,"wires":[["bea7c30d.57e05"]]},{"id":"c44b468b.a66cc8","type":"file in","z":"9c2230b1.bee8d","name":"Read People File","filename":"/share/markiv/access.json","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":250,"y":120,"wires":[["4718ce41.4972a"]]},{"id":"a31bfef1.b8158","type":"function","z":"9c2230b1.bee8d","name":"Load into flow","func":"flow.set(\"people\", msg.payload.People);\nreturn msg;","outputs":1,"noerr":0,"x":640,"y":120,"wires":[[]]},{"id":"4718ce41.4972a","type":"json","z":"9c2230b1.bee8d","name":"Parse","property":"payload","action":"","pretty":false,"x":430,"y":120,"wires":[["a31bfef1.b8158","a38a2811.c3c3c8"]]},{"id":"d70c713d.677e6","type":"file","z":"9c2230b1.bee8d","name":"","filename":"/share/markiv/access.json","appendNewline":false,"createDir":false,"overwriteFile":"true","encoding":"none","x":410,"y":1260,"wires":[[]]},{"id":"9a00c03c.70a61","type":"json","z":"9c2230b1.bee8d","name":"toString","property":"payload","action":"str","pretty":false,"x":420,"y":1200,"wires":[["d70c713d.677e6"]]},{"id":"cb709e60.c311e","type":"function","z":"9c2230b1.bee8d","name":"Get Object","func":"var people = flow.get(\"people\");\n\nvar ppl = \n{\n    People: people\n};\n\nmsg.payload = ppl\n\n\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":1140,"wires":[["9a00c03c.70a61"]]},{"id":"6c17c8f1.6700f8","type":"link in","z":"9c2230b1.bee8d","name":"SavePeopleFile","links":["a9ef6d3e.2a62e","bf897ab2.55eea8","60dfeac.37ba014"],"x":260,"y":1140,"wires":[["cb709e60.c311e"]]},{"id":"a57c84ab.bf7788","type":"link in","z":"9c2230b1.bee8d","name":"LoadPeopleFile","links":[],"x":115,"y":120,"wires":[["c44b468b.a66cc8"]]},{"id":"fddbee77.13e9f","type":"inject","z":"9c2230b1.bee8d","name":"","repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"Trigger","payloadType":"str","x":100,"y":180,"wires":[["c44b468b.a66cc8"]]},{"id":"a916c3eb.9306","type":"chatbot-telegram-send","z":"9c2230b1.bee8d","bot":"b2e0dafd.f67fa8","botProduction":"b2e0dafd.f67fa8","track":true,"passThrough":false,"outputs":1,"x":1670,"y":1120,"wires":[["fb64bf7a.079a3"]]},{"id":"bf897ab2.55eea8","type":"link out","z":"9c2230b1.bee8d","name":"","links":["5cba632f.e6356c","6c17c8f1.6700f8"],"x":2035,"y":900,"wires":[]},{"id":"a38a2811.c3c3c8","type":"debug","z":"9c2230b1.bee8d","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":630,"y":200,"wires":[]},{"id":"fe90a99e.6e4dd8","type":"api-call-service","z":"152554cc.389edb","name":"Next Track","server":"7d575fd3.be153","version":1,"service_domain":"media_player","service":"media_next_track","entityId":"media_player.spotify_phil","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":350,"y":600,"wires":[["2fee2a9f.ce2d46"]]},{"id":"4e6eb3ed.30472c","type":"function","z":"152554cc.389edb","name":"Clear","func":"flow.set(\"current_tag\", 0);","outputs":0,"noerr":0,"x":570,"y":680,"wires":[]},{"id":"f3f887d.c5db578","type":"spotify","z":"ef54a0c2.e259d","name":"Spotify","auth":"6db11244.bdedac","api":"getAlbum","x":450,"y":80,"wires":[["678b4110.9e302"]]},{"id":"e0b66320.f432d","type":"inject","z":"ef54a0c2.e259d","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"Now Playing","payloadType":"str","x":290,"y":80,"wires":[["f3f887d.c5db578"]]},{"id":"678b4110.9e302","type":"debug","z":"ef54a0c2.e259d","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":590,"y":80,"wires":[]},{"id":"464e3e5d.1a4b5","type":"function","z":"152554cc.389edb","name":"Clear","func":"flow.set(\"current_tag\", 0);","outputs":0,"noerr":0,"x":390,"y":100,"wires":[]},{"id":"2fee2a9f.ce2d46","type":"stoptimer","z":"152554cc.389edb","duration":"30","units":"Minute","payloadtype":"num","payloadval":"0","name":"","x":400,"y":680,"wires":[["4e6eb3ed.30472c"],[]]},{"id":"4e727dab.d861c4","type":"mqtt in","z":"9c2230b1.bee8d","name":"Markiv","topic":"markiv/+/face","qos":"0","datatype":"auto","broker":"2eafe4c0.b7da5c","x":490,"y":940,"wires":[["a422b8ef.417e88"]]},{"id":"3f414a03.d3c226","type":"chatbot-telegram-send","z":"9c2230b1.bee8d","bot":"b2e0dafd.f67fa8","botProduction":"b2e0dafd.f67fa8","track":true,"passThrough":false,"outputs":1,"x":1530,"y":1260,"wires":[["2554779c.bd1ba8","5b1386b1.44a838"]]},{"id":"57b0565c.db60c8","type":"link in","z":"9c2230b1.bee8d","name":"list","links":["cdf08bf.ea9d578"],"x":1215,"y":1120,"wires":[["c81493b2.5aade"]]},{"id":"cdf08bf.ea9d578","type":"link out","z":"9c2230b1.bee8d","name":"","links":["57b0565c.db60c8"],"x":615,"y":380,"wires":[]},{"id":"f9444b8b.549928","type":"link out","z":"9c2230b1.bee8d","name":"","links":["fd45795c.e46de8"],"x":2175,"y":1080,"wires":[]},{"id":"fd45795c.e46de8","type":"link in","z":"9c2230b1.bee8d","name":"person","links":["f9444b8b.549928"],"x":1235,"y":1260,"wires":[["c48f3bd3.9fd9b8"]]},{"id":"c48f3bd3.9fd9b8","type":"chatbot-inline-buttons","z":"9c2230b1.bee8d","name":"","buttons":[{"type":"postback","label":"View","value":"/view","answer":"","alert":false,"style":""},{"type":"postback","label":"Delete","value":"/delete","answer":"","alert":false,"style":""}],"message":"What would you like to do?","x":1340,"y":1260,"wires":[["3f414a03.d3c226"]]},{"id":"fb64bf7a.079a3","type":"chatbot-parse","z":"9c2230b1.bee8d","name":"name","parseType":"string","parseVariable":"name","x":1870,"y":1120,"wires":[["3ee45eb4.b6d052"],[]]},{"id":"ef679be1.f83e78","type":"function","z":"9c2230b1.bee8d","name":"Prep","func":"var name = flow.get('name');\nvar people = flow.get('people');\n\nnode.warn(\"Looking for: \" + name);\nvar ls = \". Last seen: \"\n\nfor(var i=0; i<people.length; i++)\n{\n    if(name == people[i].name)\n    {\n        ls += people[i].lastseen.toLocaleString(\"en-GB\", {day: \"numeric\", month: \"short\", year: \"numeric\", hour: \"numeric\", minute: \"2-digit\"});\n        node.warn(\"Found: \" + name);\n        msg.payload = \n        {\n            caption: name + ls,\n            image: \"/share/markiv/faces/\" + people[i].image\n        }\n        return msg;\n    }\n}\nreturn msg;\n","outputs":1,"noerr":0,"x":1850,"y":1260,"wires":[["8745f3ea.7677e"]]},{"id":"2554779c.bd1ba8","type":"chatbot-command","z":"9c2230b1.bee8d","name":"","command":"/view","x":1710,"y":1260,"wires":[["ef679be1.f83e78","5e300297.c71d6c"]]},{"id":"5b1386b1.44a838","type":"chatbot-command","z":"9c2230b1.bee8d","name":"","command":"/delete","x":1710,"y":1320,"wires":[["c113ef22.c1dc","ca787de7.2a52c"]]},{"id":"8745f3ea.7677e","type":"chatbot-image","z":"9c2230b1.bee8d","name":"","filename":"","image":"","caption":"","x":2010,"y":1260,"wires":[["9027c66a.5d7568"]]},{"id":"9027c66a.5d7568","type":"chatbot-telegram-send","z":"9c2230b1.bee8d","bot":"b2e0dafd.f67fa8","botProduction":"b2e0dafd.f67fa8","track":true,"passThrough":false,"outputs":1,"x":2190,"y":1260,"wires":[[]]},{"id":"5e300297.c71d6c","type":"chatbot-message","z":"9c2230b1.bee8d","name":"","message":[{"message":"fetching..."}],"answer":false,"silent":false,"x":1910,"y":1200,"wires":[["9027c66a.5d7568"]]},{"id":"3ee45eb4.b6d052","type":"function","z":"9c2230b1.bee8d","name":"Prep","func":"var people = flow.get('people')\nvar chat = msg.chat();\nvar name = chat.get('name');\nflow.set(\"name\", name)\n\nfor(var i=0; i<people.length; i++)\n{\n    if(name == people[i].name)\n    {\n        return [msg, null]\n    }\n}\n\nmsg.payload = \"Could not find \" + name\n\nreturn [null, msg]\n","outputs":2,"noerr":0,"x":2030,"y":1120,"wires":[["f9444b8b.549928"],["9a4200a0.dbb1d"]]},{"id":"66674ef1.d176a","type":"file","z":"9c2230b1.bee8d","name":"","filename":"/share/markiv/people.json","appendNewline":false,"createDir":false,"overwriteFile":"true","encoding":"none","x":1050,"y":1800,"wires":[["32e0c345.abe20c"]]},{"id":"d7456ce5.0f8fe","type":"json","z":"9c2230b1.bee8d","name":"toString","property":"payload","action":"str","pretty":false,"x":1100,"y":1740,"wires":[["66674ef1.d176a"]]},{"id":"2b0bff35.27ff","type":"function","z":"9c2230b1.bee8d","name":"Get Object","func":"var people = flow.get(\"people\");\n\nvar p = []\n\nfor(var i=0; i<people.length; i++)\n{\n    var person = \n    {\n      name: people[i].name,\n      image: people[i].image\n    };\n    p.push(person);\n}\n\nvar ppl = \n{\n    People: p\n};\n\nmsg.payload = ppl\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1010,"y":1680,"wires":[["d7456ce5.0f8fe"]]},{"id":"e2371933.c4f808","type":"inject","z":"9c2230b1.bee8d","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"Trigger","payloadType":"str","x":1330,"y":1700,"wires":[["f7809023.a5569"]]},{"id":"90124e92.1a321","type":"link in","z":"9c2230b1.bee8d","name":"upload","links":["32e0c345.abe20c","e1e81cd4.8ee6"],"x":1355,"y":1760,"wires":[["f7809023.a5569"]]},{"id":"f7809023.a5569","type":"function","z":"9c2230b1.bee8d","name":"Send Files","func":"var people = flow.get(\"people\");\n\nfor(var i=0; i<people.length; i++)\n{\n    msg.payload = {}\n    msg.payload.data = \"/share/markiv/faces/\" + people[i].image\n    msg.payload.filename = people[i].image\n    node.send(msg)\n}\n\nmsg.payload = {}\nmsg.payload.data = \"/share/markiv/people.json\"\nmsg.payload.filename = \"people.json\"\n\nreturn msg\n\n\n","outputs":1,"noerr":0,"x":1490,"y":1760,"wires":[["8531be6b.f0c07"]]},{"id":"8531be6b.f0c07","type":"sftp in","z":"9c2230b1.bee8d","name":"","sftp":"16114441.7d446c","operation":"put","filename":"","localFilename":"","workdir":"/home/philip/mark_iv/faces","x":1670,"y":1780,"wires":[["e0b002ec.19d8a"]]},{"id":"7a5e459b.fb826c","type":"chatbot-inline-buttons","z":"9c2230b1.bee8d","name":"Rights","buttons":[{"type":"postback","label":"Full","value":"/full","answer":"","alert":false,"style":""},{"type":"postback","label":"Guest","value":"/guest","answer":"","alert":false,"style":""},{"type":"postback","label":"Daytime","value":"/daytime","answer":"","alert":false,"style":""}],"message":"What access rights are granted?","x":1670,"y":720,"wires":[["456b1d41.7e5964"]]},{"id":"7f8e682.2742398","type":"chatbot-command","z":"9c2230b1.bee8d","name":"","command":"/full","x":1450,"y":820,"wires":[["30f10f3b.b52b6"]]},{"id":"e78f8793.3ce9b8","type":"chatbot-command","z":"9c2230b1.bee8d","name":"","command":"/guest","x":1450,"y":860,"wires":[["25cb9dd0.231702"]]},{"id":"840d44c9.709e68","type":"chatbot-command","z":"9c2230b1.bee8d","name":"","command":"/daytime","x":1460,"y":900,"wires":[["cf7b582d.366a28"]]},{"id":"30f10f3b.b52b6","type":"function","z":"9c2230b1.bee8d","name":"End","func":"msg.payload = \"full\"\n\nreturn msg;","outputs":1,"noerr":0,"x":1630,"y":820,"wires":[["f616a4ed.c69808"]]},{"id":"25cb9dd0.231702","type":"function","z":"9c2230b1.bee8d","name":"End","func":"\nmsg.payload = \"guest\"\n\nreturn msg;","outputs":1,"noerr":0,"x":1630,"y":860,"wires":[["f616a4ed.c69808"]]},{"id":"cf7b582d.366a28","type":"function","z":"9c2230b1.bee8d","name":"End","func":"msg.payload = \"daytime\"\nreturn msg;","outputs":1,"noerr":0,"x":1630,"y":900,"wires":[["f616a4ed.c69808"]]},{"id":"494ffc1a.eba374","type":"mqtt out","z":"9c2230b1.bee8d","name":"","topic":"","qos":"","retain":"","broker":"2eafe4c0.b7da5c","x":2190,"y":1780,"wires":[]},{"id":"24230623.7e0c1a","type":"function","z":"9c2230b1.bee8d","name":"Compile","func":"msg.topic = \"markiv/system/compile\"\nmsg.payload = \"compile\"\nreturn msg;","outputs":1,"noerr":0,"x":2060,"y":1780,"wires":[["494ffc1a.eba374"]]},{"id":"e0b002ec.19d8a","type":"stoptimer","z":"9c2230b1.bee8d","duration":"10","units":"Second","payloadtype":"num","payloadval":"0","name":"","x":1850,"y":1780,"wires":[["24230623.7e0c1a"],[]]},{"id":"c113ef22.c1dc","type":"function","z":"9c2230b1.bee8d","name":"Delete","func":"var name = flow.get('name');\nvar people = flow.get('people');\n\nnode.warn(\"Looking for: \" + name);\n\nvar update_people = []\n\nfor(var i=0; i<people.length; i++)\n{\n    if(name != people[i].name)\n    {\n        update_people.push(people[i])\n    }\n}\n\nflow.set('people', update_people)\n\nmsg.topic = \"markiv/delete\"\nmsg.payload = name\n\nreturn msg;\n","outputs":1,"noerr":0,"x":1850,"y":1320,"wires":[["a9ef6d3e.2a62e","291007d.db8bbf8","4547b92c.591dd8"]]},{"id":"a9ef6d3e.2a62e","type":"link out","z":"9c2230b1.bee8d","name":"","links":["6c17c8f1.6700f8"],"x":1975,"y":1320,"wires":[]},{"id":"32e0c345.abe20c","type":"link out","z":"9c2230b1.bee8d","name":"","links":["90124e92.1a321","c03dcbd5.341478"],"x":1235,"y":1800,"wires":[]},{"id":"ca787de7.2a52c","type":"chatbot-message","z":"9c2230b1.bee8d","name":"","message":[{"message":"Done"}],"answer":false,"silent":false,"x":1930,"y":1380,"wires":[["9027c66a.5d7568"]]},{"id":"9a4200a0.dbb1d","type":"chatbot-message","z":"9c2230b1.bee8d","name":"","message":[{"message":"fetching..."}],"answer":false,"silent":false,"x":2190,"y":1160,"wires":[["9027c66a.5d7568"]]},{"id":"b7de3928.855568","type":"chatbot-message","z":"9c2230b1.bee8d","name":"Text","message":[],"answer":false,"silent":false,"x":1470,"y":580,"wires":[["ab942204.dffb3"]]},{"id":"ab942204.dffb3","type":"chatbot-telegram-send","z":"9c2230b1.bee8d","bot":"b2e0dafd.f67fa8","botProduction":"b2e0dafd.f67fa8","track":true,"passThrough":false,"outputs":1,"x":1630,"y":580,"wires":[[]]},{"id":"793734ba.1a21bc","type":"mqtt in","z":"9c2230b1.bee8d","name":"Markiv","topic":"markiv/front_door/stranger","qos":"0","datatype":"auto","broker":"2eafe4c0.b7da5c","x":210,"y":1440,"wires":[[]]},{"id":"4834e540.5c88bc","type":"sftp in","z":"9c2230b1.bee8d","name":"","sftp":"16114441.7d446c","operation":"get","filename":"","localFilename":"","workdir":"/home/philip/mark_iv/snapshots/","x":510,"y":1440,"wires":[["c37888d3.59df48"]]},{"id":"c37888d3.59df48","type":"file","z":"9c2230b1.bee8d","name":"","filename":"","appendNewline":false,"createDir":false,"overwriteFile":"true","encoding":"none","x":650,"y":1440,"wires":[["1311929d.2bdd4d","68c03138.c6aa8"]]},{"id":"97d78468.5e2188","type":"function","z":"9c2230b1.bee8d","name":"Save","func":"msg.filename = \"/share/markiv/\" + msg.payload\n\nvar path = \"/home/philip/mark_iv/snapshots/\" + msg.payload\nflow.set(\"image\", msg.payload)\nmsg.payload = path\n\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":1440,"wires":[["4834e540.5c88bc"]]},{"id":"1311929d.2bdd4d","type":"function","z":"9c2230b1.bee8d","name":"Prep","func":"msg.payload = \n{\n    caption: \"Stranger spotted\",\n    image: msg.filename\n}\nreturn msg;\n","outputs":1,"noerr":0,"x":810,"y":1440,"wires":[[]]},{"id":"b17ed18a.dbe22","type":"chatbot-image","z":"9c2230b1.bee8d","name":"","filename":"","image":"","caption":"","x":1110,"y":1440,"wires":[["ba3d9a79.50c148"]]},{"id":"ba3d9a79.50c148","type":"chatbot-telegram-send","z":"9c2230b1.bee8d","bot":"b2e0dafd.f67fa8","botProduction":"b2e0dafd.f67fa8","track":false,"passThrough":false,"outputs":0,"x":1290,"y":1440,"wires":[]},{"id":"94831dd2.368cb","type":"chatbot-conversation","z":"9c2230b1.bee8d","name":"","botTelegram":"b2e0dafd.f67fa8","botTelegramProduction":"b2e0dafd.f67fa8","botSlack":"","botSlackProduction":"","botFacebook":"","botFacebookProduction":"","botViber":"","botViberProduction":"","botUniversal":"","botUniversalProduction":"","botTwilio":"","botTwilioProduction":"","botDiscord":"","botDiscordProduction":"","chatId":"-257391012","transport":"telegram","messageId":"","contextMessageId":false,"store":"","x":970,"y":1440,"wires":[["b17ed18a.dbe22"]]},{"id":"b16f6b24.f43718","type":"sftp in","z":"9c2230b1.bee8d","name":"","sftp":"16114441.7d446c","operation":"get","filename":"","localFilename":"","workdir":"/home/philip/mark_iv/snapshots/","x":1710,"y":140,"wires":[["10d1536b.7e7f2d"]]},{"id":"10d1536b.7e7f2d","type":"file","z":"9c2230b1.bee8d","name":"","filename":"","appendNewline":false,"createDir":false,"overwriteFile":"true","encoding":"none","x":1850,"y":180,"wires":[[]]},{"id":"fad01cb6.e2182","type":"function","z":"9c2230b1.bee8d","name":"Save","func":"msg.filename = \"/share/markiv/\" + msg.payload\n\nvar path = \"/home/philip/mark_iv/snapshots/\" + msg.payload\nmsg.payload = path\n\nreturn msg;","outputs":1,"noerr":0,"x":1630,"y":200,"wires":[["b16f6b24.f43718"]]},{"id":"e129c83c.849af8","type":"inject","z":"9c2230b1.bee8d","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"unkown01182020_190101.jpg","payloadType":"str","x":1370,"y":180,"wires":[["fad01cb6.e2182","e3b0b8f1.bdca78"]]},{"id":"e3b0b8f1.bdca78","type":"debug","z":"9c2230b1.bee8d","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1530,"y":120,"wires":[]},{"id":"45f39f40.c7da7","type":"sftp in","z":"9c2230b1.bee8d","name":"","sftp":"16114441.7d446c","operation":"delete","filename":"","localFilename":"","workdir":"/home/philip/mark_iv/snapshots/","x":830,"y":1520,"wires":[[]]},{"id":"68c03138.c6aa8","type":"function","z":"9c2230b1.bee8d","name":"delete","func":"var path = flow.get(\"image\")\n\nmsg.payload = \"mark_iv/snapshots/\"\nmsg.payload += path\n\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":1520,"wires":[["45f39f40.c7da7"]]},{"id":"456b1d41.7e5964","type":"chatbot-telegram-send","z":"9c2230b1.bee8d","bot":"b2e0dafd.f67fa8","botProduction":"b2e0dafd.f67fa8","track":true,"passThrough":false,"outputs":1,"x":1270,"y":860,"wires":[["7f8e682.2742398","e78f8793.3ce9b8","840d44c9.709e68"]]},{"id":"29143df1.471502","type":"inject","z":"9c2230b1.bee8d","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":240,"y":1060,"wires":[["cb709e60.c311e"]]},{"id":"4b84770b.a297d8","type":"inject","z":"9c2230b1.bee8d","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"Trigger","payloadType":"str","x":1890,"y":1700,"wires":[["24230623.7e0c1a"]]},{"id":"f616a4ed.c69808","type":"function","z":"9c2230b1.bee8d","name":"End","func":"var rights = msg.payload\nvar chat = msg.chat();\nvar name = chat.get('name');\nvar people = flow.get(\"people\");\n\nvar img = name.replace(/\\s/g,\"\").toLowerCase() + \".jpg\"\n\nvar person = \n{\n  name: name,\n  image: img,\n  group: rights,\n  lastseen: 0\n};\n\npeople.push(person);\n\nflow.set(\"people\", people);\n\nflow.set(\"new_person\", person);\n\nmsg.topic = \"End\"\nmsg.payload = \"Added \"\nmsg.payload += name\n\nreturn msg;","outputs":1,"noerr":0,"x":1770,"y":860,"wires":[["bd3d57e3.36ada8"]]},{"id":"ba46f3c4.bcda2","type":"comment","z":"9c2230b1.bee8d","name":"Load People","info":"The server stores a JSON list with known people.\nThis bit loads it into flow memory","x":190,"y":60,"wires":[]},{"id":"b13d88f5.bf4e68","type":"link out","z":"9c2230b1.bee8d","name":"","links":["92f15a34.c168d8"],"x":615,"y":320,"wires":[]},{"id":"92f15a34.c168d8","type":"link in","z":"9c2230b1.bee8d","name":"Add","links":["b13d88f5.bf4e68"],"x":1215,"y":400,"wires":[["9b36cbcc.9dc5f8"]]},{"id":"36ec735a.341aec","type":"comment","z":"9c2230b1.bee8d","name":"List","info":"Lists all the faces in the DB.\n\nAllows user to view or delete faces","x":1270,"y":1080,"wires":[]},{"id":"f211c85e.eaf738","type":"comment","z":"9c2230b1.bee8d","name":"Add","info":"Adds a new face to the device","x":1250,"y":340,"wires":[]},{"id":"f940224b.656d4","type":"file","z":"9c2230b1.bee8d","name":"","filename":"/share/markiv/add.json","appendNewline":false,"createDir":false,"overwriteFile":"true","encoding":"none","x":380,"y":780,"wires":[["a3899646.2c0428"]]},{"id":"fe1ac526.d327d8","type":"json","z":"9c2230b1.bee8d","name":"toString","property":"payload","action":"str","pretty":false,"x":400,"y":720,"wires":[["f940224b.656d4"]]},{"id":"3501b465.819f7c","type":"function","z":"9c2230b1.bee8d","name":"Get Object","func":"var person = flow.get(\"new_person\");\nmsg.payload = person\n\n\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":660,"wires":[["fe1ac526.d327d8"]]},{"id":"5cba632f.e6356c","type":"link in","z":"9c2230b1.bee8d","name":"UploadNewPerson","links":["bf897ab2.55eea8"],"x":240,"y":660,"wires":[["3501b465.819f7c"]]},{"id":"9557786b.789068","type":"inject","z":"9c2230b1.bee8d","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":220,"y":580,"wires":[["3501b465.819f7c"]]},{"id":"a3899646.2c0428","type":"function","z":"9c2230b1.bee8d","name":"Send Files","func":"var person = flow.get(\"new_person\");\n\nmsg.payload = {}\nmsg.payload.data = \"/share/markiv/faces/\" + person.image\nmsg.payload.filename = person.image\nnode.send(msg)\n\nmsg.payload = {}\nmsg.payload.data = \"/share/markiv/add.json\"\nmsg.payload.filename = \"add.json\"\n\nreturn msg\n\n\n","outputs":1,"noerr":0,"x":590,"y":780,"wires":[["a9146995.96f778"]]},{"id":"a9146995.96f778","type":"sftp in","z":"9c2230b1.bee8d","name":"","sftp":"16114441.7d446c","operation":"put","filename":"","localFilename":"","workdir":"/home/philip/mark_iv/faces","x":610,"y":720,"wires":[["c1cb6dc.652399"]]},{"id":"c580199e.764638","type":"mqtt out","z":"9c2230b1.bee8d","name":"","topic":"","qos":"","retain":"","broker":"2eafe4c0.b7da5c","x":990,"y":660,"wires":[]},{"id":"a4243f91.bccf8","type":"function","z":"9c2230b1.bee8d","name":"Compile","func":"msg.topic = \"markiv/compile\"\nmsg.payload = \"compile\"\nreturn msg;","outputs":1,"noerr":0,"x":860,"y":660,"wires":[["c580199e.764638"]]},{"id":"c1cb6dc.652399","type":"stoptimer","z":"9c2230b1.bee8d","duration":"10","units":"Second","payloadtype":"num","payloadval":"0","name":"","x":650,"y":660,"wires":[["a4243f91.bccf8"],[]]},{"id":"270d471f.442748","type":"inject","z":"9c2230b1.bee8d","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"Trigger","payloadType":"str","x":890,"y":500,"wires":[["a4243f91.bccf8"]]},{"id":"291007d.db8bbf8","type":"mqtt out","z":"9c2230b1.bee8d","name":"","topic":"","qos":"","retain":"","broker":"2eafe4c0.b7da5c","x":2130,"y":1400,"wires":[]},{"id":"4547b92c.591dd8","type":"debug","z":"9c2230b1.bee8d","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":2140,"y":1360,"wires":[]},{"id":"7c48553.5c609ac","type":"inject","z":"9c2230b1.bee8d","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1580,"y":1440,"wires":[["ffee8c5e.7490a"]]},{"id":"ffee8c5e.7490a","type":"function","z":"9c2230b1.bee8d","name":"set name","func":"flow.set(\"name\", \"Joe Biden\")\nreturn msg;","outputs":1,"noerr":0,"x":1760,"y":1440,"wires":[["c113ef22.c1dc"]]},{"id":"c6877162.564ce","type":"mqtt in","z":"f2e45804.48caf8","name":"Motion","topic":"motion/camera/#","qos":"0","datatype":"auto","broker":"2eafe4c0.b7da5c","x":190,"y":360,"wires":[["56fcb6e8.b743c8"]]},{"id":"19eddae9.8a64b5","type":"chatbot-telegram-send","z":"f2e45804.48caf8","bot":"b2e0dafd.f67fa8","botProduction":"b2e0dafd.f67fa8","track":true,"passThrough":false,"outputs":1,"x":950,"y":480,"wires":[[]]},{"id":"98a69d04.ae8d6","type":"chatbot-message","z":"f2e45804.48caf8","name":"Text","message":[],"answer":false,"silent":false,"x":790,"y":480,"wires":[["19eddae9.8a64b5"]]},{"id":"1f907859.7f8c88","type":"chatbot-conversation","z":"f2e45804.48caf8","name":"Chat","botTelegram":"b2e0dafd.f67fa8","botTelegramProduction":"b2e0dafd.f67fa8","botSlack":"","botSlackProduction":"","botFacebook":"","botFacebookProduction":"","botViber":"","botViberProduction":"","botUniversal":"","botUniversalProduction":"","botTwilio":"","botTwilioProduction":"","botDiscord":"","botDiscordProduction":"","chatId":"-257391012","transport":"telegram","messageId":"","contextMessageId":false,"store":"","x":650,"y":480,"wires":[["98a69d04.ae8d6"]]},{"id":"270aea55.fd47c6","type":"switch","z":"f2e45804.48caf8","name":"Location","property":"payload.location","propertyType":"msg","rules":[{"t":"eq","v":"front","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":500,"y":300,"wires":[["135b97df.aea318"]]},{"id":"135b97df.aea318","type":"switch","z":"f2e45804.48caf8","name":"","property":"payload.state","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":700,"y":260,"wires":[["3592a31.589395c"],[]]},{"id":"a9952ed6.0a207","type":"api-call-service","z":"f2e45804.48caf8","name":"Light On","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_on","entityId":"light.lounge","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1040,"y":220,"wires":[[]]},{"id":"962539b7.6d97b8","type":"api-current-state","z":"f2e45804.48caf8","name":"!Home?","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"home","halt_if_type":"str","halt_if_compare":"is_not","override_topic":false,"entity_id":"device_tracker.mi9tpro_miphone","state_type":"str","state_location":"","override_payload":"none","entity_location":"","override_data":"none","blockInputOverrides":false,"x":500,"y":480,"wires":[["1f907859.7f8c88"],["1f907859.7f8c88"]]},{"id":"56fcb6e8.b743c8","type":"function","z":"f2e45804.48caf8","name":"Parse","func":"var topic = msg.topic.split(\"/\")\nvar state = (msg.payload == \"ON\")\n\nmsg.payload = {}\nmsg.payload.location =  topic[2]\nmsg.payload.state = state\n\nnode.send([msg, null])\n\nvar str = \"Motion \"\nif(state)\n    str += \"detected \"\nelse\n    str += \"ended \"\n    \nstr += \"in the \" + msg.payload.location\n\nmsg.topic = \"motion\"\nmsg.payload = str\n\nreturn [null, msg]","outputs":2,"noerr":0,"x":330,"y":360,"wires":[["270aea55.fd47c6"],["962539b7.6d97b8"]]},{"id":"3592a31.589395c","type":"api-current-state","z":"f2e45804.48caf8","name":"Dark","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"above_horizon","halt_if_type":"str","halt_if_compare":"is_not","override_topic":false,"entity_id":"sun.sun","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":890,"y":220,"wires":[["a9952ed6.0a207"],[]]},{"id":"7d779411.f47fec","type":"comment","z":"9c2230b1.bee8d","name":"Update Last Seen","info":"","x":510,"y":880,"wires":[]},{"id":"a422b8ef.417e88","type":"function","z":"9c2230b1.bee8d","name":"Prep","func":"var people = flow.get(\"people\");\n\nfor(var i=0; i<people.length; i++)\n{\n    if(people[i].name == msg.payload)\n    {\n        people[i].lastseen = new Date();\n        flow.set(\"people\", people);\n        return [msg, null]\n    }\n}\nreturn [null, msg]\n","outputs":2,"noerr":0,"x":670,"y":920,"wires":[["60dfeac.37ba014"],[]]},{"id":"24787912.d65686","type":"comment","z":"9c2230b1.bee8d","name":"Update access.json","info":"","x":450,"y":1080,"wires":[]},{"id":"60dfeac.37ba014","type":"link out","z":"9c2230b1.bee8d","name":"save","links":["6c17c8f1.6700f8"],"x":775,"y":900,"wires":[]},{"id":"dfb2a236.1596a","type":"api-current-state","z":"2c8f60c4.cfd28","name":"Dark","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"above_horizon","halt_if_type":"str","halt_if_compare":"is_not","override_topic":false,"entity_id":"sun.sun","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1050,"y":600,"wires":[["8e5b61bb.7c69a","4252a0a7.8b0f7"],["61c1c44c.1822cc"]]},{"id":"61c1c44c.1822cc","type":"link out","z":"2c8f60c4.cfd28","name":"Before Dark","links":["cc0540e5.20ee3"],"x":1215,"y":660,"wires":[]},{"id":"cc0540e5.20ee3","type":"link in","z":"2c8f60c4.cfd28","name":"All Off","links":["61c1c44c.1822cc","7edcb02a.bbdd7"],"x":255,"y":420,"wires":[["bb4c6e2d.562c3"]]},{"id":"bb4c6e2d.562c3","type":"ha-get-entities","z":"2c8f60c4.cfd28","server":"7d575fd3.be153","name":"Lights","rules":[{"property":"entity_id","logic":"starts_with","value":"light.","valueType":"str"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":370,"y":420,"wires":[["59221ead.cb53c"]]},{"id":"b4fc4d87.b5b53","type":"inject","z":"2c8f60c4.cfd28","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":200,"y":480,"wires":[["bb4c6e2d.562c3"]]},{"id":"59221ead.cb53c","type":"function","z":"2c8f60c4.cfd28","name":"Command","func":"var id = msg.payload.entity_id\n\nmsg.payload = \n{\n    domain : \"light\",\n    service : \"turn_off\",\n    data:\n    {    \n        entity_id: id\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":420,"wires":[["974d70f5.8f5cd"]]},{"id":"974d70f5.8f5cd","type":"api-call-service","z":"2c8f60c4.cfd28","name":"Service","server":"7d575fd3.be153","version":1,"service_domain":"","service":"","entityId":"","data":"","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"msg","mustacheAltTags":false,"x":740,"y":420,"wires":[[]]},{"id":"c4935a16.341358","type":"comment","z":"2c8f60c4.cfd28","name":"All Off","info":"","x":350,"y":480,"wires":[]},{"id":"8e5b61bb.7c69a","type":"time-range-switch","z":"2c8f60c4.cfd28","name":"","lat":"-29.81323","lon":"30.84077","startTime":"sunset","endTime":"22:00","startOffset":0,"endOffset":0,"x":1280,"y":600,"wires":[["c6660ddb.e12d"],["7edcb02a.bbdd7"]]},{"id":"7edcb02a.bbdd7","type":"link out","z":"2c8f60c4.cfd28","name":"","links":["cc0540e5.20ee3"],"x":1445,"y":640,"wires":[]},{"id":"61f23dea.af8604","type":"comment","z":"2c8f60c4.cfd28","name":"Loadshedding","info":"","x":130,"y":360,"wires":[]},{"id":"4252a0a7.8b0f7","type":"api-call-service","z":"2c8f60c4.cfd28","name":"Bedroom AC","server":"7d575fd3.be153","version":1,"service_domain":"climate","service":"turn_on","entityId":"climate.bedroom_ac","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1280,"y":520,"wires":[[]]},{"id":"bc81990d.694638","type":"inject","z":"86a3c02f.3051a","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":660,"y":580,"wires":[["749d4018.ec617"]]},{"id":"ca1e8537.e4e5b8","type":"api-current-state","z":"2c8f60c4.cfd28","name":"","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"100","halt_if_type":"num","halt_if_compare":"lt","override_topic":false,"entity_id":"sensor.nut_ups_input_voltage","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":390,"y":580,"wires":[["99fa4bf4.b5d8d8"],["659e5777.1fd198"]]},{"id":"99fa4bf4.b5d8d8","type":"function","z":"2c8f60c4.cfd28","name":"Semaphore ON","func":"flow.set(\"ls\", true);\nreturn msg\n","outputs":1,"noerr":0,"x":700,"y":540,"wires":[[]]},{"id":"85224412.d67088","type":"inject","z":"2c8f60c4.cfd28","name":"","repeat":"5","crontab":"","once":true,"onceDelay":"1","topic":"","payload":"","payloadType":"date","x":130,"y":580,"wires":[[]]},{"id":"659e5777.1fd198","type":"function","z":"2c8f60c4.cfd28","name":"Semaphore Check","func":"var ls =  flow.get(\"ls\");\n\nif(msg.payload > 200)\n{\n    if(true === ls)\n    {\n        flow.set(\"ls\", false);\n        return [msg, null]\n    }\n}\n\nreturn [null, msg]\n\n","outputs":2,"noerr":0,"x":710,"y":620,"wires":[["c4bc121a.cdd2e"],[]]},{"id":"c4bc121a.cdd2e","type":"delay","z":"2c8f60c4.cfd28","name":"","pauseType":"delay","timeout":"60","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":900,"y":600,"wires":[["dfb2a236.1596a"]]},{"id":"e0c82f7a.cbcf2","type":"api-current-state","z":"86a3c02f.3051a","name":"Philip is home","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"home","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"device_tracker.mi9tpro_miphone","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":300,"y":1940,"wires":[["179f204a.a7659"],[]]},{"id":"e2c10bbd.552c28","type":"delay","z":"86a3c02f.3051a","name":"","pauseType":"delay","timeout":"10","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1030,"y":520,"wires":[["dea0e52f.d0eb08"]]},{"id":"f3d138cb.ca32e8","type":"mqtt in","z":"152554cc.389edb","name":"Volume","topic":"coffee_table/amp","qos":"0","datatype":"auto","broker":"2eafe4c0.b7da5c","x":1010,"y":1720,"wires":[["51120c1c.5a8144","cc998333.1cc71"]]},{"id":"51120c1c.5a8144","type":"switch","z":"152554cc.389edb","name":"Check","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"short","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1190,"y":1720,"wires":[["cfcf9909.e859f8"]]},{"id":"cc998333.1cc71","type":"debug","z":"152554cc.389edb","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1210,"y":1640,"wires":[]},{"id":"cfcf9909.e859f8","type":"api-call-service","z":"152554cc.389edb","name":"","server":"7d575fd3.be153","version":1,"service_domain":"media_player","service":"toggle","entityId":"media_player.receiver","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1390,"y":1720,"wires":[[]]},{"id":"e558806f.3db85","type":"api-call-service","z":"152554cc.389edb","name":"Power","server":"7d575fd3.be153","version":1,"service_domain":"media_player","service":"toggle","entityId":"media_player.receiver","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1810,"y":1100,"wires":[[]]},{"id":"3b7f265a.6b708a","type":"api-call-service","z":"152554cc.389edb","name":"Select Source","server":"7d575fd3.be153","version":1,"service_domain":"media_player","service":"select_source","entityId":"media_player.receiver","data":"{\"source\":\"TV\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1740,"y":1240,"wires":[[]]},{"id":"d236e5a0.ad4998","type":"api-call-service","z":"152554cc.389edb","name":"Select Source","server":"7d575fd3.be153","version":1,"service_domain":"media_player","service":"select_source","entityId":"media_player.spotify_phil","data":"{\"source\":\"Onkyo TX-NR575E F3F71F\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":2260,"y":1080,"wires":[["fe7f4e00.f99c7"]]},{"id":"fe7f4e00.f99c7","type":"api-call-service","z":"152554cc.389edb","name":"Play Music","server":"7d575fd3.be153","version":1,"service_domain":"media_player","service":"media_play","entityId":"media_player.spotify_phil","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":2450,"y":1080,"wires":[[]]},{"id":"cd1e5c78.4aa63","type":"api-call-service","z":"152554cc.389edb","name":"Select Source","server":"7d575fd3.be153","version":1,"service_domain":"media_player","service":"select_source","entityId":"media_player.receiver","data":"{\"source\":\"net\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":2040,"y":1080,"wires":[["d236e5a0.ad4998"]]},{"id":"da76c1d1.cd9cd","type":"api-current-state","z":"152554cc.389edb","name":"Is Playing?","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"playing","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"media_player.spotify_phil","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1827,"y":1047,"wires":[["b7a18580.0a8818"],["cd1e5c78.4aa63"]]},{"id":"b7a18580.0a8818","type":"api-call-service","z":"152554cc.389edb","name":"","server":"7d575fd3.be153","version":1,"service_domain":"media_player","service":"media_pause","entityId":"media_player.spotify_phil","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":2100,"y":1020,"wires":[[]]},{"id":"2ba746ae.0bb31a","type":"api-call-service","z":"ca5a8b67.211fb8","name":"Receiver","server":"7d575fd3.be153","version":1,"service_domain":"media_player","service":"turn_off","entityId":"media_player.receiver","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":500,"y":520,"wires":[[]]},{"id":"f7909cea.9905b","type":"change","z":"8e0a986b.ca0ef8","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":370,"y":140,"wires":[["6a6a0e19.a5346","33d5124b.5dd8fe","9690509e.ea3f3"]]},{"id":"9690509e.ea3f3","type":"function","z":"8e0a986b.ca0ef8","name":"2500K","func":"msg.payload = \n{\n    data:\n    {\n        \"brightness\":255,\n        \"color_temp\": 2500\n    }\n};\n\nglobal.set(\"lounge_scene\", \"warm\");\n\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":160,"wires":[["18c0dbc8.d34c14"]]},{"id":"18c0dbc8.d34c14","type":"api-call-service","z":"8e0a986b.ca0ef8","name":"Lounge","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_on","entityId":"light.lounge","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":760,"y":160,"wires":[[]]},{"id":"a0e8685a.8e3108","type":"api-call-service","z":"8b2696b9.77c108","name":"Entrance","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"light.entrance","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":580,"y":180,"wires":[[]]},{"id":"e3169abf.7a4a98","type":"change","z":"8b2696b9.77c108","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":330,"y":200,"wires":[["a0e8685a.8e3108","e1d810db.48261"]]},{"id":"ca24d037.3188c","type":"api-call-service","z":"8b2696b9.77c108","name":"Lounge","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_on","entityId":"light.lounge","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":720,"y":220,"wires":[[]]},{"id":"e1d810db.48261","type":"function","z":"8b2696b9.77c108","name":"250K","func":"msg.payload = \n{\n    data:\n    {\n        \"brightness\":255,\n        \"color_temp\":250\n    }\n};\nglobal.set(\"lounge_scene\", \"bright\");\nreturn msg;","outputs":1,"noerr":0,"x":570,"y":220,"wires":[["ca24d037.3188c"]]},{"id":"69303f76.a7109","type":"api-call-service","z":"f39f57bd.f82a58","name":"Kitchen","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"light.kitchen","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":540,"y":140,"wires":[[]]},{"id":"32608752.6ce518","type":"api-call-service","z":"f39f57bd.f82a58","name":"Entrance","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"light.entrance","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":540,"y":180,"wires":[[]]},{"id":"da8ae703.da5a18","type":"change","z":"f39f57bd.f82a58","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":290,"y":200,"wires":[["69303f76.a7109","32608752.6ce518","8bdb5cc6.d6b64"]]},{"id":"8bdb5cc6.d6b64","type":"function","z":"f39f57bd.f82a58","name":"1800K","func":"msg.payload = \n{\n    data:\n    {\n        \"brightness\":255,\n        \"color_temp\": 1800\n    }\n};\nglobal.set(\"lounge_scene\", \"medium\");\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":220,"wires":[["ec67d17a.801c9"]]},{"id":"ec67d17a.801c9","type":"api-call-service","z":"f39f57bd.f82a58","name":"Lounge","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_on","entityId":"light.lounge","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":680,"y":220,"wires":[[]]},{"id":"f7c84f40.b0fdc","type":"function","z":"152554cc.389edb","name":"FSM","func":"var state = global.get(\"lounge_scene\") || \"off\";\n\nswitch(state)\n{\n    default:\n    case \"off\":\n        return[msg, null, null, null];\n\n    case \"warm\":\n        return[null, msg, null, null];\n\n    case \"medium\":\n        return[null, null, msg, null];\n\n    case \"bright\":\n        return[null, null, null, msg];\n}\n","outputs":4,"noerr":0,"x":1740,"y":320,"wires":[["9f1e356f.687c28"],["7fd4d73c.d59cf8"],["7bfaf4fe.4456ec"],["b9bcc661.ee1b88"]]},{"id":"9f1e356f.687c28","type":"subflow:8e0a986b.ca0ef8","z":"152554cc.389edb","name":"","env":[],"x":1950,"y":280,"wires":[]},{"id":"7bfaf4fe.4456ec","type":"subflow:8b2696b9.77c108","z":"152554cc.389edb","name":"","x":1950,"y":360,"wires":[]},{"id":"7fd4d73c.d59cf8","type":"subflow:f39f57bd.f82a58","z":"152554cc.389edb","name":"","x":1960,"y":320,"wires":[]},{"id":"b9bcc661.ee1b88","type":"subflow:8e0a986b.ca0ef8","z":"152554cc.389edb","name":"","env":[],"x":1950,"y":400,"wires":[]},{"id":"239064ae.f24bcc","type":"server-state-changed","z":"3788fae5.b038d6","name":"Chill","server":"7d575fd3.be153","version":1,"entityidfilter":"input_boolean.chill_time","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":1050,"y":440,"wires":[["7517beec.7305d","eeb9265b.8b0328","942447ab.53cdf8"],[]]},{"id":"7517beec.7305d","type":"api-call-service","z":"3788fae5.b038d6","name":"Reset bool","server":"7d575fd3.be153","version":1,"service_domain":"input_boolean","service":"turn_off","entityId":"input_boolean.chill_time","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1240,"y":400,"wires":[[]]},{"id":"344020c6.5b639","type":"api-call-service","z":"3788fae5.b038d6","name":"Play Music","server":"7d575fd3.be153","version":1,"service_domain":"media_player","service":"play_media","entityId":"media_player.spotify_phil","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1620,"y":460,"wires":[["d4ed10ae.6e52"]]},{"id":"942447ab.53cdf8","type":"api-call-service","z":"3788fae5.b038d6","name":"Select Source","server":"7d575fd3.be153","version":1,"service_domain":"media_player","service":"select_source","entityId":"media_player.spotify_phil","data":"{\"source\":\"Onkyo TX-NR575E F3F71F\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1250,"y":460,"wires":[["17e88970.019397"]]},{"id":"17e88970.019397","type":"function","z":"3788fae5.b038d6","name":"Accoustic Jam","func":"msg.payload = \n{\n    data:\n    {\n        \"media_content_type\":\"playlist\",\n        \"media_content_id\":\"spotify:playlist:705vyINkWYjjQTW1sLxmd0\"\n    }\n};\nreturn msg;","outputs":1,"noerr":0,"x":1430,"y":460,"wires":[["344020c6.5b639"]]},{"id":"d4ed10ae.6e52","type":"api-call-service","z":"3788fae5.b038d6","name":"Shuffle","server":"7d575fd3.be153","version":1,"service_domain":"media_player","service":"play_media","entityId":"media_player.spotify_phil","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1780,"y":460,"wires":[[]]},{"id":"eeb9265b.8b0328","type":"subflow:8e0a986b.ca0ef8","z":"3788fae5.b038d6","name":"","env":[],"x":1250,"y":520,"wires":[]},{"id":"a03b3143.2e984","type":"subflow:8e0a986b.ca0ef8","z":"3788fae5.b038d6","name":"","x":900,"y":1000,"wires":[]},{"id":"8adf2889.bd0738","type":"subflow:8b2696b9.77c108","z":"3788fae5.b038d6","name":"","env":[],"x":900,"y":840,"wires":[]},{"id":"e2d1f061.2c3d7","type":"api-call-service","z":"62f232c2.0dd08c","name":"Receiver","server":"7d575fd3.be153","version":1,"service_domain":"media_player","service":"turn_off","entityId":"media_player.receiver","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":720,"y":680,"wires":[[]]},{"id":"fe2e314f.b36b7","type":"api-current-state","z":"3788fae5.b038d6","name":"AC Off?","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"climate.lounge_ac","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":880,"y":100,"wires":[["a5194ca9.77f1b"],[]]},{"id":"179f204a.a7659","type":"api-current-state","z":"86a3c02f.3051a","name":"AC Off?","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"climate.bedroom_ac","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":480,"y":1940,"wires":[["4e000c83.7f4064"],[]]},{"id":"e7d9d2d6.63e2","type":"api-call-service","z":"152554cc.389edb","name":"","server":"7d575fd3.be153","version":1,"service_domain":"media_player","service":"select_source","entityId":"media_player.receiver","data":"{\"source\": \"net\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1070,"y":680,"wires":[[]]},{"id":"35b114f7.13131c","type":"api-current-state","z":"86a3c02f.3051a","name":"AC Off?","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"climate.bedroom_ac","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":480,"y":2320,"wires":[["18e4dbe1.07c2c4"],[]]},{"id":"dbd5310b.88731","type":"mqtt in","z":"fa310ecb.c84eb","name":"zm","topic":"zoneminder/#","qos":"0","datatype":"auto","broker":"2eafe4c0.b7da5c","x":320,"y":1060,"wires":[["834916f4.ab9f48"]]},{"id":"834916f4.ab9f48","type":"debug","z":"fa310ecb.c84eb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":500,"y":1060,"wires":[]},{"id":"78d9c352.fd07bc","type":"server-state-changed","z":"2c8f60c4.cfd28","name":"Booted","server":"7d575fd3.be153","version":1,"entityidfilter":"input_boolean.booted","entityidfiltertype":"exact","outputinitially":false,"state_type":"habool","haltifstate":"true","halt_if_type":"bool","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":890,"y":540,"wires":[["c4bc121a.cdd2e","dfb2a236.1596a"],[]]},{"id":"c6660ddb.e12d","type":"ha-get-entities","z":"2c8f60c4.cfd28","server":"7d575fd3.be153","name":"Lights","rules":[{"property":"entity_id","logic":"starts_with","value":"light.","valueType":"str"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":1470,"y":540,"wires":[["79d01230.f750fc"]]},{"id":"79d01230.f750fc","type":"function","z":"2c8f60c4.cfd28","name":"Command","func":"var id = msg.payload.entity_id\n\nif(msg.payload.entity_id.includes(\"lounge\"))\n    return;\n\nmsg.payload = \n{\n    domain : \"light\",\n    service : \"turn_off\",\n    data:\n    {    \n        entity_id: id\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1650,"y":540,"wires":[["da3b50cb.3fe67"]]},{"id":"da3b50cb.3fe67","type":"api-call-service","z":"2c8f60c4.cfd28","name":"Service","server":"7d575fd3.be153","version":1,"service_domain":"","service":"","entityId":"","data":"","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"msg","mustacheAltTags":false,"x":1840,"y":540,"wires":[[]]},{"id":"352d393b.28cc76","type":"debug","z":"152554cc.389edb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1390,"y":620,"wires":[]},{"id":"cab35574.45d8b8","type":"debug","z":"152554cc.389edb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1430,"y":540,"wires":[]},{"id":"8d5a2aab.f58118","type":"delay","z":"62f232c2.0dd08c","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1360,"y":420,"wires":[["4a0f0678.e98488"]]},{"id":"9426b6aa.4dc908","type":"http request","z":"fa310ecb.c84eb","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"http://192.168.1.208/plugin/enclosure/inputs/1?apikey=54CE655DBCE049AEA2FCF6F9A14D8157","tls":"","persist":false,"proxy":"","authType":"","x":1160,"y":240,"wires":[["9dfbf288.79e81"]]},{"id":"9dfbf288.79e81","type":"debug","z":"fa310ecb.c84eb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1370,"y":240,"wires":[]},{"id":"742c303c.b8308","type":"inject","z":"fa310ecb.c84eb","name":"make request","repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"date","x":970,"y":240,"wires":[["9426b6aa.4dc908"]]},{"id":"b7a9ce6c.54c07","type":"api-current-state","z":"dfa48b6f.2ff088","name":"","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"50","halt_if_type":"num","halt_if_compare":"gt","override_topic":false,"entity_id":"sensor.printer_enclosure_temp","state_type":"num","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":710,"y":700,"wires":[["c4fc2ce2.18e2c"],[]]},{"id":"3d0d3460.2c3ccc","type":"inject","z":"dfa48b6f.2ff088","name":"","repeat":"10","crontab":"","once":true,"onceDelay":"10","topic":"","payload":"","payloadType":"date","x":450,"y":700,"wires":[["b7a9ce6c.54c07"]]},{"id":"b17d5bf4.0a1468","type":"chatbot-message","z":"dfa48b6f.2ff088","name":"Text","message":[{"message":"Printer enclosure exceeds 40C"}],"answer":false,"silent":false,"x":1130,"y":700,"wires":[["fab0571e.678598"]]},{"id":"c4fc2ce2.18e2c","type":"chatbot-conversation","z":"dfa48b6f.2ff088","name":"Printer","botTelegram":"435a769d.ad67a8","botTelegramProduction":"435a769d.ad67a8","botSlack":"","botSlackProduction":"","botFacebook":"","botFacebookProduction":"","botViber":"","botViberProduction":"","botUniversal":"","botUniversalProduction":"","botTwilio":"","botTwilioProduction":"","botDiscord":"","botDiscordProduction":"","chatId":"532693134","transport":"telegram","messageId":"","contextMessageId":false,"store":"","x":970,"y":700,"wires":[["b17d5bf4.0a1468"]]},{"id":"fab0571e.678598","type":"chatbot-telegram-send","z":"dfa48b6f.2ff088","bot":"435a769d.ad67a8","botProduction":"435a769d.ad67a8","track":true,"passThrough":false,"outputs":1,"x":1330,"y":700,"wires":[[]]},{"id":"bf3156de.febfb8","type":"server-state-changed","z":"dfa48b6f.2ff088","name":"Print Status","server":"7d575fd3.be153","version":1,"entityidfilter":"binary_sensor.cr10s_pro_v2_printing","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is_not","outputs":2,"output_only_on_state_change":true,"x":310,"y":840,"wires":[["f17070b.315019"],[]]},{"id":"1d34206a.ef32a","type":"chatbot-message","z":"dfa48b6f.2ff088","name":"Text","message":[{"message":"CR10S finished printing"}],"answer":false,"silent":false,"x":630,"y":840,"wires":[["622692e0.a9528c"]]},{"id":"f17070b.315019","type":"chatbot-conversation","z":"dfa48b6f.2ff088","name":"Printer","botTelegram":"435a769d.ad67a8","botTelegramProduction":"435a769d.ad67a8","botSlack":"","botSlackProduction":"","botFacebook":"","botFacebookProduction":"","botViber":"","botViberProduction":"","botUniversal":"","botUniversalProduction":"","botTwilio":"","botTwilioProduction":"","botDiscord":"","botDiscordProduction":"","chatId":"532693134","transport":"telegram","messageId":"","contextMessageId":false,"store":"","x":470,"y":840,"wires":[["1d34206a.ef32a"]]},{"id":"622692e0.a9528c","type":"chatbot-telegram-send","z":"dfa48b6f.2ff088","bot":"435a769d.ad67a8","botProduction":"435a769d.ad67a8","track":true,"passThrough":false,"outputs":1,"x":830,"y":840,"wires":[[]]},{"id":"449752dc.7a7b9c","type":"switch","z":"dfa48b6f.2ff088","name":"Message","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"left","vt":"str"},{"t":"eq","v":"right","vt":"str"},{"t":"eq","v":"both","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":420,"y":1200,"wires":[["1c133f10.23a2c1"],["169f40f4.cb8fff"],[]]},{"id":"94871f17.da95b","type":"server-state-changed","z":"dfa48b6f.2ff088","name":"Button","server":"7d575fd3.be153","version":1,"entityidfilter":"sensor.printer_button_click","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":280,"y":1200,"wires":[["449752dc.7a7b9c"]]},{"id":"67a655cb.c8e24c","type":"http request","z":"ecfae70d.6fd868","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":1326,"y":161,"wires":[["b0aa1eff.75651"]]},{"id":"e94af234.f5ed4","type":"http request","z":"dfa48b6f.2ff088","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"http://192.168.1.208/plugin/enclosure/getOutputStatus?apikey=54CE655DBCE049AEA2FCF6F9A14D8157","tls":"","persist":false,"proxy":"","authType":"","x":670,"y":1280,"wires":[["68423116.d0ca8"]]},{"id":"3b097356.0ecf5c","type":"inject","z":"dfa48b6f.2ff088","name":"","repeat":"","crontab":"","once":false,"onceDelay":"10","topic":"","payload":"","payloadType":"date","x":480,"y":1280,"wires":[["e94af234.f5ed4"]]},{"id":"2be945b0.134aaa","type":"debug","z":"dfa48b6f.2ff088","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":990,"y":1280,"wires":[]},{"id":"eb4fd9f6.da3a28","type":"function","z":"ecfae70d.6fd868","name":"Prepare Request","func":"msg.url = \"http://192.168.1.208/plugin/enclosure/setIO?apikey=C83FCB54774D420E8A67A430EB170B05&index_id=2&status=\"\n\nif(msg.light == \"on\")\n    msg.url += \"true\"\nelse if(msg.light == \"off\")    \n    msg.url += \"false\"\nelse\n    return\n\nreturn msg","outputs":1,"noerr":0,"x":1046,"y":161,"wires":[["67a655cb.c8e24c","616f2f65.1800e"]]},{"id":"8d7e5c57.6ef06","type":"subflow:ecfae70d.6fd868","z":"dfa48b6f.2ff088","name":"","env":[],"x":810,"y":1160,"wires":[]},{"id":"68423116.d0ca8","type":"json","z":"dfa48b6f.2ff088","name":"","property":"payload","action":"","pretty":false,"x":840,"y":1280,"wires":[["2be945b0.134aaa"]]},{"id":"c98e2e82.738a6","type":"http request","z":"ecfae70d.6fd868","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"http://192.168.1.208/plugin/enclosure/getOutputStatus?apikey=C83FCB54774D420E8A67A430EB170B05","tls":"","persist":false,"proxy":"","authType":"","x":506,"y":281,"wires":[["c28aabc4.fde6f8"]]},{"id":"c28aabc4.fde6f8","type":"json","z":"ecfae70d.6fd868","name":"","property":"payload","action":"","pretty":false,"x":676,"y":281,"wires":[["93a07f39.78bd8"]]},{"id":"6f6d535e.459b4c","type":"switch","z":"ecfae70d.6fd868","name":"","property":"light","propertyType":"msg","rules":[{"t":"neq","v":"toggle","vt":"str"},{"t":"eq","v":"toggle","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":346,"y":161,"wires":[["eb4fd9f6.da3a28"],["c98e2e82.738a6"]]},{"id":"93a07f39.78bd8","type":"function","z":"ecfae70d.6fd868","name":"Switch","func":"if(msg.payload[1].status === true)\n    msg.light = \"off\"\nelse\n    msg.light = \"on\"\n    \nreturn msg;\n","outputs":1,"noerr":0,"x":846,"y":281,"wires":[["eb4fd9f6.da3a28"]]},{"id":"a98f1c29.4335","type":"http request","z":"dfa48b6f.2ff088","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"http://192.168.1.208/plugin/enclosure/getOutputStatus?apikey=54CE655DBCE049AEA2FCF6F9A14D8157","tls":"","persist":false,"proxy":"","authType":"","x":590,"y":1400,"wires":[["67507c49.eb2e04"]]},{"id":"67507c49.eb2e04","type":"json","z":"dfa48b6f.2ff088","name":"","property":"payload","action":"","pretty":false,"x":760,"y":1400,"wires":[["dc7d36db.ee0778"]]},{"id":"d6c85030.57e5f","type":"inject","z":"dfa48b6f.2ff088","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":380,"y":1420,"wires":[["a98f1c29.4335"]]},{"id":"dc7d36db.ee0778","type":"function","z":"dfa48b6f.2ff088","name":"Prepare Request","func":"flow.set(\"status\", msg.payload[1].status)\n","outputs":1,"noerr":0,"x":950,"y":1400,"wires":[[]]},{"id":"6b4f288b.bbc2f8","type":"http request","z":"ecfae70d.6fd868","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":1346,"y":401,"wires":[["dc3fecd7.0151f"]]},{"id":"e78dace6.2c0bd","type":"function","z":"ecfae70d.6fd868","name":"Prepare Request","func":"msg.url = \"http://192.168.1.208/plugin/enclosure/setIO?apikey=C83FCB54774D420E8A67A430EB170B05&index_id=1&status=\"\n\nif(msg.printer == \"on\")\n    msg.url += \"true\"\nelse if(msg.printer == \"off\")    \n    msg.url += \"false\"\nelse\n    return\n\nreturn msg","outputs":1,"noerr":0,"x":1066,"y":401,"wires":[["6b4f288b.bbc2f8","c8c21fa8.04ac7"]]},{"id":"7fabf17.68ff81","type":"http request","z":"ecfae70d.6fd868","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"http://192.168.1.208/plugin/enclosure/getOutputStatus?apikey=C83FCB54774D420E8A67A430EB170B05","tls":"","persist":false,"proxy":"","authType":"","x":526,"y":521,"wires":[["42d6f746.005218"]]},{"id":"42d6f746.005218","type":"json","z":"ecfae70d.6fd868","name":"","property":"payload","action":"","pretty":false,"x":696,"y":521,"wires":[["c67a4d7e.ac628"]]},{"id":"3b95e8fe.376e68","type":"switch","z":"ecfae70d.6fd868","name":"","property":"printer","propertyType":"msg","rules":[{"t":"neq","v":"toggle","vt":"str"},{"t":"eq","v":"toggle","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":366,"y":401,"wires":[["e78dace6.2c0bd"],["7fabf17.68ff81"]]},{"id":"c67a4d7e.ac628","type":"function","z":"ecfae70d.6fd868","name":"Switch","func":"if(msg.payload[0].status === true)\n    msg.printer = \"off\"\nelse\n    msg.printer = \"on\"\n    \nreturn msg;\n","outputs":1,"noerr":0,"x":866,"y":521,"wires":[["e78dace6.2c0bd"]]},{"id":"1c133f10.23a2c1","type":"function","z":"dfa48b6f.2ff088","name":"Toggle Light","func":"msg.light = \"toggle\"\n\nreturn msg\n","outputs":1,"noerr":0,"x":610,"y":1160,"wires":[["8d7e5c57.6ef06"]]},{"id":"7a4b8a04.c7d4b4","type":"debug","z":"ecfae70d.6fd868","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":300,"y":80,"wires":[]},{"id":"616f2f65.1800e","type":"debug","z":"ecfae70d.6fd868","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1230,"y":100,"wires":[]},{"id":"c8c21fa8.04ac7","type":"debug","z":"ecfae70d.6fd868","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1230,"y":340,"wires":[]},{"id":"b0aa1eff.75651","type":"debug","z":"ecfae70d.6fd868","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1510,"y":120,"wires":[]},{"id":"dc3fecd7.0151f","type":"debug","z":"ecfae70d.6fd868","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1530,"y":360,"wires":[]},{"id":"169f40f4.cb8fff","type":"function","z":"dfa48b6f.2ff088","name":"Toggle Power","func":"msg.printer = \"toggle\"\n\nreturn msg\n","outputs":1,"noerr":0,"x":620,"y":1200,"wires":[["8d7e5c57.6ef06"]]},{"id":"8e8a7de9.69019","type":"mqtt in","z":"62f232c2.0dd08c","name":"Button 1","topic":"zigbee2mqtt/0x00158d0001f41f2c","qos":"2","datatype":"auto","broker":"2eafe4c0.b7da5c","x":1080,"y":1820,"wires":[["2a87112c.416fde"]]},{"id":"31b8c82a.9b2a28","type":"switch","z":"62f232c2.0dd08c","name":"Message","property":"payload.click","propertyType":"msg","rules":[{"t":"eq","v":"single","vt":"str"},{"t":"eq","v":"long","vt":"str"},{"t":"eq","v":"double","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":1380,"y":1820,"wires":[["b74f8104.b143f"],[],[]]},{"id":"2a87112c.416fde","type":"json","z":"62f232c2.0dd08c","name":"","property":"payload","action":"","pretty":false,"x":1230,"y":1820,"wires":[["31b8c82a.9b2a28"]]},{"id":"b74f8104.b143f","type":"api-current-state","z":"62f232c2.0dd08c","name":"","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"climate.study_ac","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1630,"y":1760,"wires":[["9fb16122.5d43"],["61d4b492.f2ad1c"]]},{"id":"9fb16122.5d43","type":"api-call-service","z":"62f232c2.0dd08c","name":"","server":"7d575fd3.be153","version":1,"service_domain":"climate","service":"turn_on","entityId":"climate.study_ac","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1920,"y":1740,"wires":[[]]},{"id":"61d4b492.f2ad1c","type":"api-call-service","z":"62f232c2.0dd08c","name":"","server":"7d575fd3.be153","version":1,"service_domain":"climate","service":"turn_off","entityId":"climate.study_ac","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1920,"y":1800,"wires":[[]]},{"id":"9f797a10.cb3098","type":"api-call-service","z":"ca5a8b67.211fb8","name":"Storeroom","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"light.storeroom_light","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":510,"y":580,"wires":[[]]},{"id":"ee2bfb22.e00998","type":"api-call-service","z":"ca5a8b67.211fb8","name":"Bathroom","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"light.bathroom","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":500,"y":640,"wires":[[]]},{"id":"cc51f123.3ce62","type":"inject","z":"62f232c2.0dd08c","name":"","repeat":"60","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":190,"y":2260,"wires":[["a6407012.169c1"]]},{"id":"24c5da64.6925a6","type":"api-call-service","z":"62f232c2.0dd08c","name":"Geyser Off","server":"7d575fd3.be153","version":1,"service_domain":"switch","service":"turn_off","entityId":"switch.geyser","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1050,"y":2280,"wires":[[]]},{"id":"70276796.233f58","type":"api-call-service","z":"62f232c2.0dd08c","name":"Geyser On","server":"7d575fd3.be153","version":1,"service_domain":"switch","service":"turn_on","entityId":"switch.geyser","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1050,"y":2200,"wires":[[]]},{"id":"b270e6b0.984808","type":"api-current-state","z":"62f232c2.0dd08c","name":"","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"switch.geyser","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":820,"y":2200,"wires":[["70276796.233f58"],[]]},{"id":"281dcc89.88ab94","type":"time-range-switch","z":"62f232c2.0dd08c","name":"","lat":"-29.83346","lon":"30.91393","startTime":"04:00","endTime":"06:00","startOffset":0,"endOffset":0,"x":590,"y":2260,"wires":[["b270e6b0.984808"],["30b9c29e.e5e1ce"]]},{"id":"30b9c29e.e5e1ce","type":"api-current-state","z":"62f232c2.0dd08c","name":"","server":"7d575fd3.be153","version":1,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"switch.geyser","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":820,"y":2300,"wires":[["24c5da64.6925a6"],[]]},{"id":"a6407012.169c1","type":"time-range-switch","z":"62f232c2.0dd08c","name":"","lat":"-29.83346","lon":"30.91393","startTime":"18:00","endTime":"20:00","startOffset":0,"endOffset":0,"x":370,"y":2260,"wires":[["b270e6b0.984808"],["281dcc89.88ab94"]]},{"id":"c8ff82ec.c7e07","type":"api-call-service","z":"62f232c2.0dd08c","name":"Bedroom Light","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"light.bedroom","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":680,"y":980,"wires":[[]]},{"id":"4e5263a4.04d8fc","type":"mqtt out","z":"62f232c2.0dd08c","name":"","topic":"","qos":"","retain":"","broker":"2eafe4c0.b7da5c","x":530,"y":2500,"wires":[]},{"id":"9284d4a4.bd7d88","type":"function","z":"62f232c2.0dd08c","name":"Reset Energy","func":"msg.topic = \"cmnd/tasmota_488F91/EnergyReset3\"\nmsg.payload = \"0\"\nreturn msg;","outputs":1,"noerr":0,"x":360,"y":2500,"wires":[["4e5263a4.04d8fc"]]},{"id":"57713887.1c4798","type":"inject","z":"62f232c2.0dd08c","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":900,"y":2440,"wires":[["24c5da64.6925a6"]]},{"id":"7cb51cde.f241c4","type":"inject","z":"62f232c2.0dd08c","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":180,"y":2500,"wires":[["9284d4a4.bd7d88"]]},{"id":"71f6dcdf.a11794","type":"function","z":"62f232c2.0dd08c","name":"Opened","func":"msg.topic = \"boss\"\nmsg.payload = \"Back door opened\"\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":2720,"wires":[["bc8b0426.df7ee8"]]},{"id":"961e7241.791bf","type":"function","z":"62f232c2.0dd08c","name":"Closed","func":"msg.topic = \"boss\"\nmsg.payload = \"Back door closed\"\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":2640,"wires":[["ad41f953.64d508"]]},{"id":"9d899af5.2505d8","type":"comment","z":"62f232c2.0dd08c","name":"Store Room Light","info":"","x":274,"y":2596,"wires":[]},{"id":"643912df.f9c5ec","type":"server-state-changed","z":"62f232c2.0dd08c","name":"Store Door","server":"7d575fd3.be153","version":1,"entityidfilter":"binary_sensor.store_door_contact","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"off","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":194,"y":2676,"wires":[["961e7241.791bf"],["71f6dcdf.a11794"]]},{"id":"ad41f953.64d508","type":"api-call-service","z":"62f232c2.0dd08c","name":"Store light off","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_off","entityId":"light.storeroom_light","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":550,"y":2640,"wires":[[]]},{"id":"bc8b0426.df7ee8","type":"api-call-service","z":"62f232c2.0dd08c","name":"Store light on","server":"7d575fd3.be153","version":1,"service_domain":"light","service":"turn_on","entityId":"light.storeroom_light","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":550,"y":2720,"wires":[[]]},{"id":"18034796.49ea88","type":"inject","z":"62f232c2.0dd08c","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":880,"y":2080,"wires":[["70276796.233f58"]]},{"id":"cd1978ff.a45b78","type":"inject","z":"2c8f60c4.cfd28","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":340,"y":840,"wires":[["ba01652f.6715d8"]]},{"id":"f1e852ca.fbc2d","type":"mqtt out","z":"2c8f60c4.cfd28","name":"","topic":"","qos":"","retain":"","broker":"2eafe4c0.b7da5c","x":687,"y":842,"wires":[]},{"id":"ba01652f.6715d8","type":"function","z":"2c8f60c4.cfd28","name":"Netmap","func":"msg.topic = \"zigbee2mqtt/bridge/networkmap\"\nmsg.payload = \"graphviz\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":507,"y":842,"wires":[["f1e852ca.fbc2d"]]},{"id":"7a436731.338728","type":"mqtt in","z":"2c8f60c4.cfd28","name":"Network map","topic":"zigbee2mqtt/bridge/networkmap/graphviz","qos":"0","datatype":"auto","broker":"2eafe4c0.b7da5c","x":350,"y":920,"wires":[["3ebc16d5.616d2a"]]},{"id":"3ebc16d5.616d2a","type":"debug","z":"2c8f60c4.cfd28","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":520,"y":940,"wires":[]}]